# 用户管理功能开发文档

## 1. 功能概述

用户管理模块提供系统用户的增删改查功能，支持用户信息管理、状态管理、密码重置、角色分配等功能。

## 2. 功能需求

### 2.1 用户列表查询
- 支持分页查询
- 支持按用户名、真实姓名、状态筛选
- 显示用户基本信息（用户名、真实姓名、邮箱、手机号、状态、创建时间）

### 2.2 用户新增
- 用户名唯一性校验
- 密码长度不少于6位
- 必填字段：用户名、密码、真实姓名
- 可选字段：邮箱、手机号
- 默认状态：启用（1）

### 2.3 用户编辑
- 可修改真实姓名、邮箱、手机号、状态
- 用户名不可修改
- 密码可选修改（不填则不修改）

### 2.4 用户删除
- 逻辑删除
- 删除前检查是否有关联数据

### 2.5 密码重置
- 重置密码为默认值：123456
- 重置后密码需要BCrypt加密

### 2.6 角色分配
- 支持为用户分配多个角色
- 显示用户当前角色列表
- 支持角色添加和移除

## 3. 数据库设计

### 3.1 用户表（sys_user）

```sql
CREATE TABLE `sys_user` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password` varchar(255) NOT NULL COMMENT '密码（BCrypt加密）',
  `real_name` varchar(50) DEFAULT NULL COMMENT '真实姓名',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `status` tinyint DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统用户表';
```

### 3.2 用户角色关联表（sys_user_role）

```sql
CREATE TABLE `sys_user_role` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `role_id` bigint NOT NULL COMMENT '角色ID',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_role` (`user_id`, `role_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_role_id` (`role_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户角色关联表';
```

## 4. 后端开发

### 4.1 DTO

#### UserQueryDTO（查询DTO）

```java
package com.zssystem.dto;

import lombok.Data;

@Data
public class UserQueryDTO {
    private String username;
    private String realName;
    private Integer status;
    private Integer pageNum = 1;
    private Integer pageSize = 10;
}
```

#### UserSaveDTO（保存DTO）

```java
package com.zssystem.dto;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;
import lombok.Data;

@Data
public class UserSaveDTO {
    private Long id;
    
    @NotBlank(message = "用户名不能为空")
    @Size(min = 3, max = 50, message = "用户名长度必须在3-50之间")
    private String username;
    
    @Size(min = 6, message = "密码长度不能少于6位")
    private String password;
    
    @NotBlank(message = "真实姓名不能为空")
    private String realName;
    
    private String email;
    
    private String phone;
    
    private Integer status = 1;
    
    private Long[] roleIds;
}
```

### 4.2 VO

#### UserVO（用户视图对象）

```java
package com.zssystem.vo;

import lombok.Data;
import java.time.LocalDateTime;
import java.util.List;

@Data
public class UserVO {
    private Long id;
    private String username;
    private String realName;
    private String email;
    private String phone;
    private Integer status;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
    private List<RoleVO> roles;
}
```

### 4.3 Service接口

```java
package com.zssystem.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.zssystem.dto.UserQueryDTO;
import com.zssystem.dto.UserSaveDTO;
import com.zssystem.vo.UserVO;

public interface SysUserService {
    IPage<UserVO> getList(UserQueryDTO dto);
    UserVO getById(Long id);
    void save(UserSaveDTO dto);
    void delete(Long id);
    void resetPassword(Long id);
}
```

### 4.4 Service实现

```java
package com.zssystem.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.zssystem.dto.UserQueryDTO;
import com.zssystem.dto.UserSaveDTO;
import com.zssystem.entity.SysUser;
import com.zssystem.entity.SysUserRole;
import com.zssystem.mapper.SysUserMapper;
import com.zssystem.mapper.SysUserRoleMapper;
import com.zssystem.service.SysUserService;
import com.zssystem.util.BeanUtil;
import com.zssystem.vo.UserVO;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
public class SysUserServiceImpl implements SysUserService {
    
    @Autowired
    private SysUserMapper userMapper;
    
    @Autowired
    private SysUserRoleMapper userRoleMapper;
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    @Override
    public IPage<UserVO> getList(UserQueryDTO dto) {
        Page<SysUser> page = new Page<>(dto.getPageNum(), dto.getPageSize());
        
        LambdaQueryWrapper<SysUser> wrapper = new LambdaQueryWrapper<>();
        wrapper.like(dto.getUsername() != null, SysUser::getUsername, dto.getUsername())
               .like(dto.getRealName() != null, SysUser::getRealName, dto.getRealName())
               .eq(dto.getStatus() != null, SysUser::getStatus, dto.getStatus())
               .orderByDesc(SysUser::getCreateTime);
        
        IPage<SysUser> userPage = userMapper.selectPage(page, wrapper);
        
        // 转换为VO并填充角色信息
        IPage<UserVO> voPage = userPage.convert(user -> {
            UserVO vo = BeanUtil.copyProperties(user, UserVO.class);
            // 查询用户角色
            List<SysUserRole> userRoles = userRoleMapper.selectList(
                new LambdaQueryWrapper<SysUserRole>().eq(SysUserRole::getUserId, user.getId())
            );
            // TODO: 填充角色信息
            return vo;
        });
        
        return voPage;
    }
    
    @Override
    public UserVO getById(Long id) {
        SysUser user = userMapper.selectById(id);
        if (user == null) {
            throw new RuntimeException("用户不存在");
        }
        UserVO vo = BeanUtil.copyProperties(user, UserVO.class);
        // TODO: 填充角色信息
        return vo;
    }
    
    @Override
    @Transactional
    public void save(UserSaveDTO dto) {
        SysUser user;
        
        if (dto.getId() != null) {
            // 更新
            user = userMapper.selectById(dto.getId());
            if (user == null) {
                throw new RuntimeException("用户不存在");
            }
            
            // 检查用户名是否被其他用户使用
            SysUser existUser = userMapper.selectOne(
                new LambdaQueryWrapper<SysUser>()
                    .eq(SysUser::getUsername, dto.getUsername())
                    .ne(SysUser::getId, dto.getId())
            );
            if (existUser != null) {
                throw new RuntimeException("用户名已存在");
            }
            
            // 更新用户信息
            user.setRealName(dto.getRealName());
            user.setEmail(dto.getEmail());
            user.setPhone(dto.getPhone());
            user.setStatus(dto.getStatus());
            
            // 如果提供了密码，则更新密码
            if (dto.getPassword() != null && !dto.getPassword().isEmpty()) {
                user.setPassword(passwordEncoder.encode(dto.getPassword()));
            }
            
            userMapper.updateById(user);
        } else {
            // 新增
            // 检查用户名是否已存在
            SysUser existUser = userMapper.selectOne(
                new LambdaQueryWrapper<SysUser>()
                    .eq(SysUser::getUsername, dto.getUsername())
            );
            if (existUser != null) {
                throw new RuntimeException("用户名已存在");
            }
            
            user = new SysUser();
            user.setUsername(dto.getUsername());
            user.setPassword(passwordEncoder.encode(dto.getPassword()));
            user.setRealName(dto.getRealName());
            user.setEmail(dto.getEmail());
            user.setPhone(dto.getPhone());
            user.setStatus(dto.getStatus() != null ? dto.getStatus() : 1);
            
            userMapper.insert(user);
        }
        
        // 更新用户角色关联
        if (dto.getRoleIds() != null) {
            // 删除原有角色关联
            userRoleMapper.delete(
                new LambdaQueryWrapper<SysUserRole>()
                    .eq(SysUserRole::getUserId, user.getId())
            );
            
            // 添加新角色关联
            for (Long roleId : dto.getRoleIds()) {
                SysUserRole userRole = new SysUserRole();
                userRole.setUserId(user.getId());
                userRole.setRoleId(roleId);
                userRoleMapper.insert(userRole);
            }
        }
    }
    
    @Override
    @Transactional
    public void delete(Long id) {
        SysUser user = userMapper.selectById(id);
        if (user == null) {
            throw new RuntimeException("用户不存在");
        }
        // 逻辑删除
        userMapper.deleteById(id);
    }
    
    @Override
    @Transactional
    public void resetPassword(Long id) {
        SysUser user = userMapper.selectById(id);
        if (user == null) {
            throw new RuntimeException("用户不存在");
        }
        // 重置密码为123456
        user.setPassword(passwordEncoder.encode("123456"));
        userMapper.updateById(user);
    }
}
```

### 4.5 Controller

```java
package com.zssystem.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.zssystem.common.PageResult;
import com.zssystem.common.Result;
import com.zssystem.dto.UserQueryDTO;
import com.zssystem.dto.UserSaveDTO;
import com.zssystem.service.SysUserService;
import com.zssystem.vo.UserVO;
import jakarta.validation.Valid;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/users")
public class SysUserController {
    
    @Autowired
    private SysUserService userService;
    
    @GetMapping("/list")
    public Result<PageResult<UserVO>> getList(@Valid UserQueryDTO dto) {
        IPage<UserVO> page = userService.getList(dto);
        return Result.success(PageResult.of(page));
    }
    
    @GetMapping("/{id}")
    public Result<UserVO> getById(@PathVariable Long id) {
        UserVO vo = userService.getById(id);
        return Result.success(vo);
    }
    
    @PostMapping
    public Result<Void> create(@Valid @RequestBody UserSaveDTO dto) {
        userService.save(dto);
        return Result.success();
    }
    
    @PutMapping("/{id}")
    public Result<Void> update(@PathVariable Long id, @Valid @RequestBody UserSaveDTO dto) {
        dto.setId(id);
        userService.save(dto);
        return Result.success();
    }
    
    @DeleteMapping("/{id}")
    public Result<Void> delete(@PathVariable Long id) {
        userService.delete(id);
        return Result.success();
    }
    
    @PostMapping("/{id}/reset-password")
    public Result<Void> resetPassword(@PathVariable Long id) {
        userService.resetPassword(id);
        return Result.success();
    }
}
```

## 5. 前端开发

### 5.1 API定义

```typescript
import request from '@/utils/request';

export interface UserQueryParams {
  username?: string;
  realName?: string;
  status?: number;
  pageNum?: number;
  pageSize?: number;
}

export interface UserSaveParams {
  id?: number;
  username: string;
  password?: string;
  realName: string;
  email?: string;
  phone?: string;
  status?: number;
  roleIds?: number[];
}

export interface UserInfo {
  id: number;
  username: string;
  realName: string;
  email?: string;
  phone?: string;
  status: number;
  createTime: string;
  updateTime: string;
  roles?: any[];
}

export const getUserList = (params: UserQueryParams) => {
  return request.get<{ list: UserInfo[]; total: number }>('/users/list', { params });
};

export const getUserById = (id: number) => {
  return request.get<UserInfo>(`/users/${id}`);
};

export const createUser = (data: UserSaveParams) => {
  return request.post('/users', data);
};

export const updateUser = (id: number, data: UserSaveParams) => {
  return request.put(`/users/${id}`, data);
};

export const deleteUser = (id: number) => {
  return request.delete(`/users/${id}`);
};

export const resetPassword = (id: number) => {
  return request.post(`/users/${id}/reset-password`);
};
```

### 5.2 用户列表页面

```typescript
import React, { useEffect, useState } from 'react';
import { Table, Button, Form, Input, Select, Space, message, Popconfirm } from 'antd';
import { PlusOutlined, EditOutlined, DeleteOutlined, ReloadOutlined } from '@ant-design/icons';
import { getUserList, deleteUser, resetPassword, UserInfo, UserQueryParams } from '@/api/user';
import UserModal from './UserModal';

const UserList: React.FC = () => {
  const [form] = Form.useForm();
  const [tableData, setTableData] = useState<UserInfo[]>([]);
  const [loading, setLoading] = useState(false);
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 10,
    total: 0,
  });
  const [modalVisible, setModalVisible] = useState(false);
  const [editingUser, setEditingUser] = useState<UserInfo | null>(null);

  const fetchList = async () => {
    setLoading(true);
    try {
      const values = form.getFieldsValue();
      const params: UserQueryParams = {
        ...values,
        pageNum: pagination.current,
        pageSize: pagination.pageSize,
      };
      const response = await getUserList(params);
      setTableData(response.list);
      setPagination({ ...pagination, total: response.total });
    } catch (error: any) {
      message.error(error.message || '查询失败');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchList();
  }, [pagination.current, pagination.pageSize]);

  const handleAdd = () => {
    setEditingUser(null);
    setModalVisible(true);
  };

  const handleEdit = (record: UserInfo) => {
    setEditingUser(record);
    setModalVisible(true);
  };

  const handleDelete = async (id: number) => {
    try {
      await deleteUser(id);
      message.success('删除成功');
      fetchList();
    } catch (error: any) {
      message.error(error.message || '删除失败');
    }
  };

  const handleResetPassword = async (id: number) => {
    try {
      await resetPassword(id);
      message.success('密码重置成功，默认密码：123456');
    } catch (error: any) {
      message.error(error.message || '重置失败');
    }
  };

  const handleSearch = () => {
    setPagination({ ...pagination, current: 1 });
    fetchList();
  };

  const handleReset = () => {
    form.resetFields();
    handleSearch();
  };

  const columns = [
    {
      title: '用户名',
      dataIndex: 'username',
      key: 'username',
    },
    {
      title: '真实姓名',
      dataIndex: 'realName',
      key: 'realName',
    },
    {
      title: '邮箱',
      dataIndex: 'email',
      key: 'email',
    },
    {
      title: '手机号',
      dataIndex: 'phone',
      key: 'phone',
    },
    {
      title: '状态',
      dataIndex: 'status',
      key: 'status',
      render: (status: number) => (status === 1 ? '启用' : '禁用'),
    },
    {
      title: '创建时间',
      dataIndex: 'createTime',
      key: 'createTime',
    },
    {
      title: '操作',
      key: 'action',
      render: (_: any, record: UserInfo) => (
        <Space>
          <Button type="link" icon={<EditOutlined />} onClick={() => handleEdit(record)}>
            编辑
          </Button>
          <Popconfirm
            title="确定要重置密码吗？"
            onConfirm={() => handleResetPassword(record.id)}
          >
            <Button type="link">重置密码</Button>
          </Popconfirm>
          <Popconfirm
            title="确定要删除吗？"
            onConfirm={() => handleDelete(record.id)}
          >
            <Button type="link" danger icon={<DeleteOutlined />}>
              删除
            </Button>
          </Popconfirm>
        </Space>
      ),
    },
  ];

  return (
    <div>
      <Form form={form} layout="inline" style={{ marginBottom: 16 }}>
        <Form.Item name="username">
          <Input placeholder="用户名" />
        </Form.Item>
        <Form.Item name="realName">
          <Input placeholder="真实姓名" />
        </Form.Item>
        <Form.Item name="status">
          <Select placeholder="状态" style={{ width: 120 }} allowClear>
            <Select.Option value={1}>启用</Select.Option>
            <Select.Option value={0}>禁用</Select.Option>
          </Select>
        </Form.Item>
        <Form.Item>
          <Space>
            <Button type="primary" onClick={handleSearch}>
              查询
            </Button>
            <Button onClick={handleReset}>
              <ReloadOutlined /> 重置
            </Button>
            <Button type="primary" icon={<PlusOutlined />} onClick={handleAdd}>
              新增
            </Button>
          </Space>
        </Form.Item>
      </Form>

      <Table
        columns={columns}
        dataSource={tableData}
        loading={loading}
        rowKey="id"
        pagination={{
          current: pagination.current,
          pageSize: pagination.pageSize,
          total: pagination.total,
          onChange: (page, pageSize) => {
            setPagination({ ...pagination, current: page, pageSize });
          },
        }}
      />

      <UserModal
        visible={modalVisible}
        user={editingUser}
        onCancel={() => setModalVisible(false)}
        onSuccess={() => {
          setModalVisible(false);
          fetchList();
        }}
      />
    </div>
  );
};

export default UserList;
```

## 6. 注意事项

1. 用户名必须唯一，新增和更新时都要校验
2. 密码长度不少于6位
3. 更新用户时，密码为空则不修改密码
4. 删除用户使用逻辑删除
5. 重置密码默认值为123456，需要BCrypt加密
6. 用户角色关联需要同步更新
7. 前端需要处理表单验证和错误提示
