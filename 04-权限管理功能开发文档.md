# 权限管理功能开发文档

## 1. 功能概述

权限管理模块基于RBAC（Role-Based Access Control）模型，实现角色和权限的管理，支持菜单权限和按钮权限的分离，提供权限树形结构展示和动态路由生成。

## 2. 功能需求

### 2.1 角色管理
- 角色列表查询（分页）
- 角色新增、编辑、删除
- 角色名称唯一性校验
- 角色状态管理（启用/禁用）
- 角色权限分配

### 2.2 权限管理
- 权限树形结构展示
- 权限新增、编辑、删除
- 权限类型：菜单权限、按钮权限
- 权限编码唯一性校验
- 权限排序

### 2.3 角色权限关联
- 为角色分配权限
- 支持批量分配
- 权限树形选择

### 2.4 用户角色关联
- 为用户分配角色
- 支持多角色分配
- 角色列表展示

## 3. 数据库设计

### 3.1 角色表（sys_role）

```sql
CREATE TABLE `sys_role` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `role_name` varchar(50) NOT NULL COMMENT '角色名称',
  `role_code` varchar(50) NOT NULL COMMENT '角色编码',
  `description` varchar(255) DEFAULT NULL COMMENT '角色描述',
  `status` tinyint DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_role_code` (`role_code`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色表';
```

### 3.2 权限表（sys_permission）

```sql
CREATE TABLE `sys_permission` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `parent_id` bigint DEFAULT 0 COMMENT '父权限ID，0表示顶级',
  `permission_name` varchar(50) NOT NULL COMMENT '权限名称',
  `permission_code` varchar(100) NOT NULL COMMENT '权限编码',
  `permission_type` tinyint NOT NULL COMMENT '权限类型：1-菜单，2-按钮',
  `path` varchar(200) DEFAULT NULL COMMENT '路由路径',
  `component` varchar(200) DEFAULT NULL COMMENT '组件路径',
  `icon` varchar(50) DEFAULT NULL COMMENT '图标',
  `sort_order` int DEFAULT 0 COMMENT '排序',
  `status` tinyint DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_permission_code` (`permission_code`),
  KEY `idx_parent_id` (`parent_id`),
  KEY `idx_type` (`permission_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='权限表';
```

### 3.3 角色权限关联表（sys_role_permission）

```sql
CREATE TABLE `sys_role_permission` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `role_id` bigint NOT NULL COMMENT '角色ID',
  `permission_id` bigint NOT NULL COMMENT '权限ID',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_role_permission` (`role_id`, `permission_id`),
  KEY `idx_role_id` (`role_id`),
  KEY `idx_permission_id` (`permission_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色权限关联表';
```

### 3.4 用户角色关联表（sys_user_role）

```sql
CREATE TABLE `sys_user_role` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `role_id` bigint NOT NULL COMMENT '角色ID',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_role` (`user_id`, `role_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_role_id` (`role_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户角色关联表';
```

## 4. 后端开发

### 4.1 实体类

#### SysRole

```java
package com.zssystem.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.time.LocalDateTime;

@Data
@TableName("sys_role")
public class SysRole {
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private String roleName;
    
    private String roleCode;
    
    private String description;
    
    private Integer status;
    
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;
    
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;
    
    @TableLogic
    private Integer deleted;
}
```

#### SysPermission

```java
package com.zssystem.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.time.LocalDateTime;

@Data
@TableName("sys_permission")
public class SysPermission {
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private Long parentId;
    
    private String permissionName;
    
    private String permissionCode;
    
    private Integer permissionType; // 1-菜单，2-按钮
    
    private String path;
    
    private String component;
    
    private String icon;
    
    private Integer sortOrder;
    
    private Integer status;
    
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;
    
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;
    
    @TableLogic
    private Integer deleted;
}
```

### 4.2 DTO

#### RoleQueryDTO

```java
package com.zssystem.dto;

import lombok.Data;

@Data
public class RoleQueryDTO {
    private String roleName;
    private String roleCode;
    private Integer status;
    private Integer pageNum = 1;
    private Integer pageSize = 10;
}
```

#### RoleSaveDTO

```java
package com.zssystem.dto;

import jakarta.validation.constraints.NotBlank;
import lombok.Data;

@Data
public class RoleSaveDTO {
    private Long id;
    
    @NotBlank(message = "角色名称不能为空")
    private String roleName;
    
    @NotBlank(message = "角色编码不能为空")
    private String roleCode;
    
    private String description;
    
    private Integer status = 1;
    
    private Long[] permissionIds;
}
```

#### PermissionSaveDTO

```java
package com.zssystem.dto;

import jakarta.validation.constraints.NotBlank;
import lombok.Data;

@Data
public class PermissionSaveDTO {
    private Long id;
    
    private Long parentId = 0L;
    
    @NotBlank(message = "权限名称不能为空")
    private String permissionName;
    
    @NotBlank(message = "权限编码不能为空")
    private String permissionCode;
    
    @NotBlank(message = "权限类型不能为空")
    private Integer permissionType; // 1-菜单，2-按钮
    
    private String path;
    
    private String component;
    
    private String icon;
    
    private Integer sortOrder = 0;
    
    private Integer status = 1;
}
```

### 4.3 VO

#### RoleVO

```java
package com.zssystem.vo;

import lombok.Data;
import java.time.LocalDateTime;
import java.util.List;

@Data
public class RoleVO {
    private Long id;
    private String roleName;
    private String roleCode;
    private String description;
    private Integer status;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
    private List<Long> permissionIds;
}
```

#### PermissionTreeVO

```java
package com.zssystem.vo;

import lombok.Data;
import java.util.List;

@Data
public class PermissionTreeVO {
    private Long id;
    private Long parentId;
    private String permissionName;
    private String permissionCode;
    private Integer permissionType;
    private String path;
    private String component;
    private String icon;
    private Integer sortOrder;
    private Integer status;
    private List<PermissionTreeVO> children;
}
```

### 4.4 Service接口

```java
package com.zssystem.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.zssystem.dto.RoleQueryDTO;
import com.zssystem.dto.RoleSaveDTO;
import com.zssystem.dto.PermissionSaveDTO;
import com.zssystem.vo.RoleVO;
import com.zssystem.vo.PermissionTreeVO;

import java.util.List;

public interface SysRoleService {
    IPage<RoleVO> getList(RoleQueryDTO dto);
    RoleVO getById(Long id);
    void save(RoleSaveDTO dto);
    void delete(Long id);
}

public interface SysPermissionService {
    List<PermissionTreeVO> getTree();
    PermissionTreeVO getById(Long id);
    void save(PermissionSaveDTO dto);
    void delete(Long id);
    List<PermissionTreeVO> getPermissionsByRoleId(Long roleId);
}
```

## 5. 前端开发

### 5.1 权限树组件

```typescript
import React from 'react';
import { Tree } from 'antd';
import { PermissionTreeVO } from '@/api/permission';

interface PermissionTreeProps {
  value?: number[];
  onChange?: (checkedKeys: number[]) => void;
  treeData: PermissionTreeVO[];
}

const PermissionTree: React.FC<PermissionTreeProps> = ({
  value = [],
  onChange,
  treeData,
}) => {
  const onCheck = (checkedKeys: any) => {
    onChange?.(checkedKeys.checked || checkedKeys);
  };

  return (
    <Tree
      checkable
      checkedKeys={value}
      onCheck={onCheck}
      treeData={treeData}
      fieldNames={{
        title: 'permissionName',
        key: 'id',
        children: 'children',
      }}
    />
  );
};

export default PermissionTree;
```

## 6. 注意事项

1. 角色编码和权限编码必须唯一
2. 权限采用树形结构，支持多级菜单
3. 删除角色前检查是否有关联用户
4. 删除权限前检查是否有关联角色
5. 权限类型：1-菜单，2-按钮
6. 前端需要根据用户权限动态生成菜单和路由
7. 按钮权限需要在前端进行控制显示/隐藏
