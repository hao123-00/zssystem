# 生产管理功能开发文档（更新版）

## 1. 功能概述

生产管理模块用于管理注塑生产计划安排和生产记录，核心功能是**完成27天内所有设备的生产计划安排**，查看在27天内是否能够完成生产目标。系统根据设备信息、设备可生产产品配置（包含订单数量和产能数量），自动生成27天的生产计划排程，并实时计算剩余数量。

## 2. 功能需求

### 2.1 设备生产信息管理

#### 2.1.1 设备基本信息扩展
每台设备需要维护以下信息：
- **设备编号**（唯一）
- **组别**：设备所属组别
- **机台号**：机台编号
- **设备型号**：设备的具体型号
- **机械手型号**：机械手的具体型号
- **启用日期**：设备启用的日期
- **使用年限**：设备的使用年限（年）
- **模温机**：模温机信息
- **冻水机**：冻水机信息
- **基本排模**：基本排模信息
- **备用排模1**：第一个备用排模
- **备用排模2**：第二个备用排模
- **备用排模3**：第三个备用排模

#### 2.1.2 设备可生产产品配置（含订单和产能）
每台设备可以配置自己要完成的一种或多种产品，每种产品包含：
- **产品名称**：产品的名称
- **产品编码**：产品的编码（可选）
- **订单数量**：该产品在该设备上的订单数量
- **产能数量**：该设备生产该产品的日产能（每天能生产的数量）

### 2.2 27天生产计划排程（核心功能）

#### 2.2.1 排程目标
- 完成**27天内所有设备的生产计划安排**
- 查看在27天内是否能够完成生产目标
- 自动计算每天的生产安排和剩余数量

#### 2.2.2 排程规则
1. **按设备维度**：为每台设备安排27天的生产计划
2. **按产品优先级**：每台设备按配置的产品顺序进行生产
3. **剩余数量计算**：`剩余数量 = 订单数量 - 产能数量 × 第几天`
4. **产品切换规则**：当某个产品的剩余数量 ≤ 0 时，停止计算该产品，开始排序下一种产品
5. **时间范围**：从当前日期开始，连续27天

#### 2.2.3 排程结果展示
对于每台设备，显示27天内的：
- **日期**：第1天、第2天...第27天
- **产品名称**：当天生产的产品名称
- **产能**：当天该产品的产能数量
- **剩余数量**：该产品在该设备上的剩余订单数量
  - 计算公式：`剩余数量 = 订单数量 - 产能 × 已生产天数`
  - 当剩余数量 ≤ 0 时，该产品完成，切换到下一个产品

#### 2.2.4 排程查询功能
- 支持按设备编号、组别、机台号查询
- 支持查看单台设备的27天排程
- 支持查看所有设备的27天排程汇总
- 支持导出排程报表

### 2.3 生产记录管理
- 生产记录录入（关联排程计划）
- 记录列表查询
- 记录信息：设备、产品、产量、不良品数量、生产日期等

### 2.4 生产目标完成情况分析
- 27天内总产能统计
- 各产品完成情况统计
- 各设备产能利用率统计
- 是否能在27天内完成生产目标的判断

## 3. 数据库设计

### 3.1 设备表（equipment）- 扩展字段

```sql
CREATE TABLE `equipment` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `equipment_no` varchar(50) NOT NULL COMMENT '设备编号（唯一）',
  `equipment_name` varchar(100) NOT NULL COMMENT '设备名称',
  `group_name` varchar(50) DEFAULT NULL COMMENT '组别',
  `machine_no` varchar(50) DEFAULT NULL COMMENT '机台号',
  `equipment_model` varchar(100) DEFAULT NULL COMMENT '设备型号',
  `robot_model` varchar(100) DEFAULT NULL COMMENT '机械手型号',
  `enable_date` date DEFAULT NULL COMMENT '启用日期',
  `service_life` int DEFAULT NULL COMMENT '使用年限（年）',
  `mold_temp_machine` varchar(100) DEFAULT NULL COMMENT '模温机',
  `chiller` varchar(100) DEFAULT NULL COMMENT '冻水机',
  `basic_mold` varchar(100) DEFAULT NULL COMMENT '基本排模',
  `spare_mold1` varchar(100) DEFAULT NULL COMMENT '备用排模1',
  `spare_mold2` varchar(100) DEFAULT NULL COMMENT '备用排模2',
  `spare_mold3` varchar(100) DEFAULT NULL COMMENT '备用排模3',
  `status` tinyint DEFAULT 1 COMMENT '状态：0-停用，1-正常，2-维修中',
  `remark` varchar(500) DEFAULT NULL COMMENT '备注',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_equipment_no` (`equipment_no`),
  KEY `idx_group_name` (`group_name`),
  KEY `idx_machine_no` (`machine_no`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备表';
```

### 3.2 设备生产产品配置表（equipment_production_product）

> 用于维护设备与产品的生产关系，包含订单数量和产能数量。

```sql
CREATE TABLE `equipment_production_product` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `equipment_id` bigint NOT NULL COMMENT '设备ID',
  `equipment_no` varchar(50) NOT NULL COMMENT '设备编号（冗余，便于查询）',
  `product_code` varchar(50) DEFAULT NULL COMMENT '产品编码',
  `product_name` varchar(100) NOT NULL COMMENT '产品名称',
  `order_quantity` int NOT NULL COMMENT '订单数量',
  `daily_capacity` int NOT NULL COMMENT '日产能（每天能生产的数量）',
  `sort_order` int DEFAULT 0 COMMENT '排序（用于确定生产优先级）',
  `remark` varchar(500) DEFAULT NULL COMMENT '备注',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  KEY `idx_equipment_id` (`equipment_id`),
  KEY `idx_product_code` (`product_code`),
  KEY `idx_sort_order` (`sort_order`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备生产产品配置表';
```

说明：
- 同一设备可以配置多个产品（通过 `equipment_id` 关联）
- `sort_order` 字段用于确定该设备上产品的生产优先级（数值越小优先级越高）
- `order_quantity` 和 `daily_capacity` 用于27天排程计算

### 3.3 27天生产计划排程表（production_schedule）

> 用于存储自动生成的27天生产计划排程结果。

```sql
CREATE TABLE `production_schedule` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `equipment_id` bigint NOT NULL COMMENT '设备ID',
  `equipment_no` varchar(50) NOT NULL COMMENT '设备编号',
  `schedule_date` date NOT NULL COMMENT '排程日期（27天中的某一天）',
  `day_number` int NOT NULL COMMENT '第几天（1-27）',
  `product_code` varchar(50) DEFAULT NULL COMMENT '产品编码',
  `product_name` varchar(100) NOT NULL COMMENT '产品名称',
  `daily_capacity` int NOT NULL COMMENT '当天产能',
  `remaining_quantity` int NOT NULL COMMENT '剩余数量（订单数量 - 产能 × 已生产天数）',
  `equipment_product_id` bigint NOT NULL COMMENT '关联的设备生产产品配置ID',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  KEY `idx_equipment_id` (`equipment_id`),
  KEY `idx_schedule_date` (`schedule_date`),
  KEY `idx_day_number` (`day_number`),
  UNIQUE KEY `uk_equipment_day` (`equipment_id`, `day_number`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='27天生产计划排程表';
```

说明：
- 每个设备每天一条记录（27天共27条记录）
- `remaining_quantity` 为负数或0时，表示该产品已完成，下一天切换到下一个产品
- 可以通过 `equipment_id` 和 `day_number` 唯一确定一条排程记录

### 3.4 生产记录表（production_record）

```sql
CREATE TABLE `production_record` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `record_no` varchar(50) NOT NULL COMMENT '记录编号',
  `equipment_id` bigint NOT NULL COMMENT '设备ID',
  `equipment_no` varchar(50) NOT NULL COMMENT '设备编号',
  `schedule_id` bigint DEFAULT NULL COMMENT '排程ID（关联production_schedule）',
  `product_code` varchar(50) DEFAULT NULL COMMENT '产品编码',
  `product_name` varchar(100) NOT NULL COMMENT '产品名称',
  `production_date` date NOT NULL COMMENT '生产日期',
  `start_time` datetime DEFAULT NULL COMMENT '开始时间',
  `end_time` datetime DEFAULT NULL COMMENT '结束时间',
  `quantity` int NOT NULL COMMENT '产量',
  `defect_quantity` int DEFAULT 0 COMMENT '不良品数量',
  `remark` varchar(500) DEFAULT NULL COMMENT '备注',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_record_no` (`record_no`),
  KEY `idx_equipment_id` (`equipment_id`),
  KEY `idx_production_date` (`production_date`),
  KEY `idx_schedule_id` (`schedule_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='生产记录表';
```

## 4. 后端开发

### 4.1 实体类

#### Equipment（扩展字段）

```java
package com.zssystem.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.time.LocalDate;
import java.time.LocalDateTime;

@Data
@TableName("equipment")
public class Equipment {
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private String equipmentNo;
    
    private String equipmentName;
    
    private String groupName; // 组别
    
    private String machineNo; // 机台号
    
    private String equipmentModel; // 设备型号
    
    private String robotModel; // 机械手型号
    
    private LocalDate enableDate; // 启用日期
    
    private Integer serviceLife; // 使用年限（年）
    
    private String moldTempMachine; // 模温机
    
    private String chiller; // 冻水机
    
    private String basicMold; // 基本排模
    
    private String spareMold1; // 备用排模1
    
    private String spareMold2; // 备用排模2
    
    private String spareMold3; // 备用排模3
    
    private Integer status; // 0-停用，1-正常，2-维修中
    
    private String remark;
    
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;
    
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;
    
    @TableLogic
    private Integer deleted;
}
```

#### EquipmentProductionProduct

```java
package com.zssystem.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.time.LocalDateTime;

@Data
@TableName("equipment_production_product")
public class EquipmentProductionProduct {
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private Long equipmentId;
    
    private String equipmentNo;
    
    private String productCode;
    
    private String productName;
    
    private Integer orderQuantity; // 订单数量
    
    private Integer dailyCapacity; // 日产能
    
    private Integer sortOrder; // 排序（生产优先级）
    
    private String remark;
    
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;
    
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;
    
    @TableLogic
    private Integer deleted;
}
```

#### ProductionSchedule

```java
package com.zssystem.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.time.LocalDate;
import java.time.LocalDateTime;

@Data
@TableName("production_schedule")
public class ProductionSchedule {
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private Long equipmentId;
    
    private String equipmentNo;
    
    private LocalDate scheduleDate; // 排程日期
    
    private Integer dayNumber; // 第几天（1-27）
    
    private String productCode;
    
    private String productName;
    
    private Integer dailyCapacity; // 当天产能
    
    private Integer remainingQuantity; // 剩余数量
    
    private Long equipmentProductId; // 关联的设备生产产品配置ID
    
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;
    
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;
    
    @TableLogic
    private Integer deleted;
}
```

### 4.2 DTO

#### EquipmentProductionProductSaveDTO

```java
package com.zssystem.dto;

import jakarta.validation.constraints.NotNull;
import lombok.Data;

@Data
public class EquipmentProductionProductSaveDTO {
    private Long id;
    
    @NotNull(message = "设备ID不能为空")
    private Long equipmentId;
    
    private String productCode;
    
    @NotNull(message = "产品名称不能为空")
    private String productName;
    
    @NotNull(message = "订单数量不能为空")
    private Integer orderQuantity;
    
    @NotNull(message = "日产能不能为空")
    private Integer dailyCapacity;
    
    private Integer sortOrder = 0; // 默认排序为0
    
    private String remark;
}
```

#### ProductionScheduleQueryDTO

```java
package com.zssystem.dto;

import lombok.Data;

@Data
public class ProductionScheduleQueryDTO {
    private String equipmentNo;
    private String groupName;
    private String machineNo;
    private LocalDate startDate; // 排程开始日期（默认从今天开始）
}
```

#### ProductionScheduleVO

```java
package com.zssystem.vo;

import lombok.Data;
import java.time.LocalDate;
import java.util.List;

@Data
public class ProductionScheduleVO {
    private Long equipmentId;
    private String equipmentNo;
    private String equipmentName;
    private String groupName;
    private String machineNo;
    private LocalDate scheduleStartDate; // 排程开始日期
    private List<ScheduleDayVO> scheduleDays; // 27天的排程详情
    private Boolean canCompleteTarget; // 是否能在27天内完成生产目标
}

@Data
class ScheduleDayVO {
    private Integer dayNumber; // 第几天（1-27）
    private LocalDate scheduleDate; // 排程日期
    private String productName; // 产品名称
    private Integer dailyCapacity; // 产能
    private Integer remainingQuantity; // 剩余数量
}
```

### 4.3 Service实现要点

#### 27天生产计划排程算法

```java
@Override
@Transactional
public ProductionScheduleVO generate27DaySchedule(Long equipmentId, LocalDate startDate) {
    // 1. 查询设备信息
    Equipment equipment = equipmentMapper.selectById(equipmentId);
    if (equipment == null) {
        throw new RuntimeException("设备不存在");
    }
    
    // 2. 查询该设备配置的所有产品（按sortOrder排序）
    List<EquipmentProductionProduct> products = equipmentProductionProductMapper.selectList(
        new LambdaQueryWrapper<EquipmentProductionProduct>()
            .eq(EquipmentProductionProduct::getEquipmentId, equipmentId)
            .orderByAsc(EquipmentProductionProduct::getSortOrder)
    );
    
    if (products.isEmpty()) {
        throw new RuntimeException("该设备未配置可生产产品");
    }
    
    // 3. 删除该设备旧的排程记录
    productionScheduleMapper.delete(new LambdaQueryWrapper<ProductionSchedule>()
        .eq(ProductionSchedule::getEquipmentId, equipmentId));
    
    // 4. 生成27天排程
    List<ScheduleDayVO> scheduleDays = new ArrayList<>();
    int currentProductIndex = 0;
    int currentProductDays = 0; // 当前产品已生产天数
    int remainingQuantity = products.get(currentProductIndex).getOrderQuantity();
    
    for (int day = 1; day <= 27; day++) {
        LocalDate scheduleDate = startDate.plusDays(day - 1);
        EquipmentProductionProduct currentProduct = products.get(currentProductIndex);
        
        // 计算剩余数量
        remainingQuantity = currentProduct.getOrderQuantity() - 
                           (currentProduct.getDailyCapacity() * currentProductDays);
        
        // 如果剩余数量 <= 0，切换到下一个产品
        if (remainingQuantity <= 0 && currentProductIndex < products.size() - 1) {
            currentProductIndex++;
            currentProduct = products.get(currentProductIndex);
            currentProductDays = 0;
            remainingQuantity = currentProduct.getOrderQuantity();
        }
        
        // 创建排程记录
        ProductionSchedule schedule = new ProductionSchedule();
        schedule.setEquipmentId(equipmentId);
        schedule.setEquipmentNo(equipment.getEquipmentNo());
        schedule.setScheduleDate(scheduleDate);
        schedule.setDayNumber(day);
        schedule.setProductCode(currentProduct.getProductCode());
        schedule.setProductName(currentProduct.getProductName());
        schedule.setDailyCapacity(currentProduct.getDailyCapacity());
        schedule.setRemainingQuantity(remainingQuantity);
        schedule.setEquipmentProductId(currentProduct.getId());
        productionScheduleMapper.insert(schedule);
        
        // 添加到VO
        ScheduleDayVO dayVO = new ScheduleDayVO();
        dayVO.setDayNumber(day);
        dayVO.setScheduleDate(scheduleDate);
        dayVO.setProductName(currentProduct.getProductName());
        dayVO.setDailyCapacity(currentProduct.getDailyCapacity());
        dayVO.setRemainingQuantity(remainingQuantity);
        scheduleDays.add(dayVO);
        
        currentProductDays++;
    }
    
    // 5. 判断是否能在27天内完成所有产品的生产目标
    boolean canComplete = true;
    for (EquipmentProductionProduct product : products) {
        int totalDaysNeeded = (int) Math.ceil((double) product.getOrderQuantity() / product.getDailyCapacity());
        // 这里需要计算该产品在排程中实际分配的天数，简化处理
    }
    
    // 6. 构建返回VO
    ProductionScheduleVO vo = new ProductionScheduleVO();
    vo.setEquipmentId(equipmentId);
    vo.setEquipmentNo(equipment.getEquipmentNo());
    vo.setEquipmentName(equipment.getEquipmentName());
    vo.setGroupName(equipment.getGroupName());
    vo.setMachineNo(equipment.getMachineNo());
    vo.setScheduleStartDate(startDate);
    vo.setScheduleDays(scheduleDays);
    vo.setCanCompleteTarget(canComplete);
    
    return vo;
}
```

## 5. 前端开发

### 5.1 设备生产信息配置页面

#### 5.1.1 设备基本信息表单
表单字段：
- 设备编号（必填，唯一）
- 设备名称（必填）
- 组别（输入框）
- 机台号（输入框）
- 设备型号（输入框）
- 机械手型号（输入框）
- 启用日期（日期选择器）
- 使用年限（数字输入框，单位：年）
- 模温机（输入框）
- 冻水机（输入框）
- 基本排模（输入框）
- 备用排模1（输入框）
- 备用排模2（输入框）
- 备用排模3（输入框）
- 状态（下拉选择：正常、维修中、停用）

#### 5.1.2 设备可生产产品配置
- 在设备详情页增加"可生产产品"标签页
- 列表展示该设备配置的所有产品
- 每条记录显示：产品名称、产品编码、订单数量、日产能、排序
- 支持新增产品配置（表单包含：产品名称、产品编码、订单数量、日产能、排序）
- 支持编辑、删除产品配置

### 5.2 27天生产计划排程页面

#### 5.2.1 排程生成
- 选择设备（下拉选择，支持按组别、机台号筛选）
- 选择排程开始日期（默认今天）
- 点击"生成27天排程"按钮，系统自动计算并生成排程

#### 5.2.2 排程展示
采用表格形式展示，列包括：
- **设备信息列**：设备编号、设备名称、组别、机台号
- **27天排程列**：第1天、第2天...第27天
  - 每个单元格显示：产品名称、产能、剩余数量
  - 可以用不同颜色标识：正常生产（绿色）、产品切换（黄色）、已完成（灰色）

#### 5.2.3 排程详情查看
- 点击某台设备，查看该设备的详细27天排程
- 以时间轴或表格形式展示每天的产品名称、产能、剩余数量
- 显示该设备是否能在27天内完成所有产品的生产目标

#### 5.2.4 排程汇总分析
- 显示所有设备的27天排程汇总
- 统计各产品的总订单数量、总产能、预计完成天数
- 判断是否能在27天内完成所有生产目标
- 支持导出排程报表（Excel）

### 5.3 生产记录管理
- 生产记录录入（关联排程计划）
- 记录列表查询
- 支持按设备、产品、日期查询

## 6. 开发要点

### 6.1 27天排程算法核心逻辑

```java
// 伪代码
for (day = 1 to 27) {
    currentProduct = products[currentProductIndex];
    remainingQuantity = currentProduct.orderQuantity - (currentProduct.dailyCapacity * currentProductDays);
    
    if (remainingQuantity <= 0 && 还有下一个产品) {
        currentProductIndex++;
        currentProduct = products[currentProductIndex];
        currentProductDays = 0;
        remainingQuantity = currentProduct.orderQuantity;
    }
    
    // 记录第day天的排程
    schedule[day] = {
        productName: currentProduct.productName,
        dailyCapacity: currentProduct.dailyCapacity,
        remainingQuantity: remainingQuantity
    };
    
    currentProductDays++;
}
```

### 6.2 生产目标完成判断

- 遍历所有设备的所有产品配置
- 计算每个产品需要的生产天数：`ceil(订单数量 / 日产能)`
- 根据排程结果，统计每个产品实际分配的生产天数
- 判断：实际分配天数 ≤ 27天，且所有产品都能完成，则能在27天内完成生产目标

## 7. 注意事项

1. **设备编号必须唯一**
2. **设备扩展字段**：组别、机台号、设备型号、机械手型号、启用日期、使用年限、模温机、冻水机、基本排模、备用排模（三个）都需要在设备表中维护
3. **产品配置排序**：通过 `sort_order` 字段确定产品生产优先级，数值越小优先级越高
4. **剩余数量计算**：`剩余数量 = 订单数量 - 产能 × 已生产天数`，当剩余数量 ≤ 0 时，切换到下一个产品
5. **27天排程**：从指定开始日期起，连续27天
6. **排程唯一性**：每个设备每天只能有一条排程记录（`equipment_id + day_number` 唯一）
7. **排程重新生成**：当设备的产品配置发生变化时，需要重新生成27天排程
8. **删除使用逻辑删除**
