# 设备管理功能开发文档（更新版）

## 1. 功能概述

设备管理模块是系统的核心模块，主要用于：
- 管理注塑成型设备的**基本信息**（每台设备有唯一的设备编号）  
- 维护设备与**可生产产品**之间的关系（每台设备可以配置自己能生产的产品列表）  
- 管理注塑成型设备的**点检记录**（注塑成型设备点检表，为核心功能，需要记录30天的点检数据）  
- 管理设备的**维护记录**与**故障记录**

注塑成型设备点检表包含电路部分、机架部分、油路部分、周边设备共16个检查项。

## 2. 功能需求

### 2.1 设备基本信息管理
- 设备列表查询（分页）
- 设备新增、编辑、删除
- 设备信息：**设备编号**、设备名称、设备型号、制造商、购买日期、状态等
- 设备编号：**系统内全局唯一**，用于与生产管理、点检记录、可生产产品配置等模块关联
- 设备状态：正常、维修中、停用

### 2.2 设备可生产产品配置
- 每台设备可以配置**可生产的产品列表**
- 产品信息（与生产管理模块保持一致）：产品名称、产品编码
- 支持为一台设备配置多个产品
- 支持按产品维度反查可以生产该产品的设备列表
- 支持在设备详情页查看该设备的可生产产品列表
- 支持新增、编辑、删除设备可生产产品配置

### 2.3 注塑成型设备点检表（核心功能）

#### 2.3.1 表头信息
- 月份（第几个月的数据，如：2024年1月）
- 检点人姓名
- 设备编号
- 设备名称

#### 2.3.2 电路部分检查（3项）
1. 发热圈/感温线/交流接触器温度控制器是否正常
2. 电箱排风扇/安全门开关/烘料斗温度是否正常
3. 形成开关是否正常

#### 2.3.3 机架部分检查（3项）
1. 哥林柱、机架螺母是否松动
2. 安全挡板/射咀/低压保护是否正常
3. 调模牙盘变形及余音是否正常

#### 2.3.4 油路部分检查（5项）
1. 油泵压力/动作是否正常
2. 油泵/溶胶/马达是否有杂音
3. 油温/冷却器是否正常
4. 自动加油润滑油管是否正常
5. 机台油管是否漏油

#### 2.3.5 周边设备检查（5项）
1. 模温机、冻水机是否异响
2. 模温机冷却水、冷却水过滤网是否堵塞
3. 油温机是否缺油、温度是否正常
4. 冻水机过滤网、运水是否正常
5. 冻水机制冷系统、交流触感器是否正常

#### 2.3.6 点检记录功能
- 每天记录一次点检数据
- 记录30天的数据（一个月）
- 每个检查项状态：1-正常，0-异常
- 支持按月份、设备编号、检点人查询
- 支持异常项备注说明

### 2.4 设备维护记录
- 维护记录录入
- 维护记录查询
- 维护信息：维护日期、维护类型、维护内容、维护人员等

### 2.5 设备故障记录
- 故障记录录入
- 故障记录查询
- 故障信息：故障日期、故障描述、处理方式、处理人员等

## 3. 数据库设计

### 3.1 设备表（equipment）

```sql
CREATE TABLE `equipment` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `equipment_no` varchar(50) NOT NULL COMMENT '设备编号（唯一）',
  `equipment_name` varchar(100) NOT NULL COMMENT '设备名称',
  `equipment_model` varchar(100) DEFAULT NULL COMMENT '设备型号',
  `manufacturer` varchar(100) DEFAULT NULL COMMENT '制造商',
  `purchase_date` date DEFAULT NULL COMMENT '购买日期',
  `status` tinyint DEFAULT 1 COMMENT '状态：0-停用，1-正常，2-维修中',
  `remark` varchar(500) DEFAULT NULL COMMENT '备注',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_equipment_no` (`equipment_no`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备表';
```

### 3.2 设备可生产产品表（equipment_product）

> 用于维护“设备-可生产产品”的多对多关系，满足“每台设备可以设定自己能生产的产品”的需求。

```sql
CREATE TABLE `equipment_product` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `equipment_id` bigint NOT NULL COMMENT '设备ID',
  `equipment_no` varchar(50) NOT NULL COMMENT '设备编号（冗余，便于查询）',
  `product_code` varchar(50) NOT NULL COMMENT '产品编码',
  `product_name` varchar(100) NOT NULL COMMENT '产品名称',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_equipment_product` (`equipment_id`, `product_code`),
  KEY `idx_equipment_id` (`equipment_id`),
  KEY `idx_product_code` (`product_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备可生产产品表';
```

说明：
- 同一设备（equipment_id）下，同一个产品编码（product_code）只能配置一次（`uk_equipment_product`）
- 后续可以与生产管理模块中的产品定义关联（如有独立的产品表）

### 3.3 设备点检表（equipment_check）

```sql
CREATE TABLE `equipment_check` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `equipment_id` bigint NOT NULL COMMENT '设备ID',
  `equipment_no` varchar(50) NOT NULL COMMENT '设备编号',
  `equipment_name` varchar(100) NOT NULL COMMENT '设备名称',
  `check_month` varchar(7) NOT NULL COMMENT '检查月份，格式：YYYY-MM',
  `check_date` date NOT NULL COMMENT '检查日期',
  `checker_name` varchar(50) NOT NULL COMMENT '检点人姓名',
  -- 电路部分（3项）
  `circuit_item1` tinyint DEFAULT NULL COMMENT '发热圈/感温线/交流接触器温度控制器：1-正常，0-异常',
  `circuit_item2` tinyint DEFAULT NULL COMMENT '电箱排风扇/安全门开关/烘料斗温度：1-正常，0-异常',
  `circuit_item3` tinyint DEFAULT NULL COMMENT '形成开关：1-正常，0-异常',
  -- 机架部分（3项）
  `frame_item1` tinyint DEFAULT NULL COMMENT '哥林柱、机架螺母：1-正常，0-异常',
  `frame_item2` tinyint DEFAULT NULL COMMENT '安全挡板/射咀/低压保护：1-正常，0-异常',
  `frame_item3` tinyint DEFAULT NULL COMMENT '调模牙盘变形及余音：1-正常，0-异常',
  -- 油路部分（5项）
  `oil_item1` tinyint DEFAULT NULL COMMENT '油泵压力/动作：1-正常，0-异常',
  `oil_item2` tinyint DEFAULT NULL COMMENT '油泵/溶胶/马达杂音：1-正常，0-异常',
  `oil_item3` tinyint DEFAULT NULL COMMENT '油温/冷却器：1-正常，0-异常',
  `oil_item4` tinyint DEFAULT NULL COMMENT '自动加油润滑油管：1-正常，0-异常',
  `oil_item5` tinyint DEFAULT NULL COMMENT '机台油管漏油：1-正常，0-异常',
  -- 周边设备（5项）
  `peripheral_item1` tinyint DEFAULT NULL COMMENT '模温机、冻水机异响：1-正常，0-异常',
  `peripheral_item2` tinyint DEFAULT NULL COMMENT '模温机冷却水、过滤网：1-正常，0-异常',
  `peripheral_item3` tinyint DEFAULT NULL COMMENT '油温机缺油、温度：1-正常，0-异常',
  `peripheral_item4` tinyint DEFAULT NULL COMMENT '冻水机过滤网、运水：1-正常，0-异常',
  `peripheral_item5` tinyint DEFAULT NULL COMMENT '冻水机制冷系统、交流触感器：1-正常，0-异常',
  -- 备注
  `remark` varchar(1000) DEFAULT NULL COMMENT '异常项备注说明',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  KEY `idx_equipment_id` (`equipment_id`),
  KEY `idx_check_month` (`check_month`),
  KEY `idx_check_date` (`check_date`),
  KEY `idx_checker_name` (`checker_name`),
  UNIQUE KEY `uk_equipment_date` (`equipment_id`, `check_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备点检表';
```

### 3.4 设备维护记录表（equipment_maintenance）

```sql
CREATE TABLE `equipment_maintenance` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `equipment_id` bigint NOT NULL COMMENT '设备ID',
  `maintenance_date` date NOT NULL COMMENT '维护日期',
  `maintenance_type` varchar(50) DEFAULT NULL COMMENT '维护类型',
  `maintenance_content` varchar(500) DEFAULT NULL COMMENT '维护内容',
  `maintainer_name` varchar(50) DEFAULT NULL COMMENT '维护人员',
  `cost` decimal(10,2) DEFAULT NULL COMMENT '维护费用',
  `remark` varchar(500) DEFAULT NULL COMMENT '备注',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  KEY `idx_equipment_id` (`equipment_id`),
  KEY `idx_maintenance_date` (`maintenance_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备维护记录表';
```

### 3.5 设备故障记录表（equipment_fault）

```sql
CREATE TABLE `equipment_fault` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `equipment_id` bigint NOT NULL COMMENT '设备ID',
  `fault_date` datetime NOT NULL COMMENT '故障日期',
  `fault_description` varchar(500) NOT NULL COMMENT '故障描述',
  `handle_method` varchar(500) DEFAULT NULL COMMENT '处理方式',
  `handler_name` varchar(50) DEFAULT NULL COMMENT '处理人员',
  `handle_date` datetime DEFAULT NULL COMMENT '处理日期',
  `status` tinyint DEFAULT 0 COMMENT '状态：0-待处理，1-处理中，2-已处理',
  `remark` varchar(500) DEFAULT NULL COMMENT '备注',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  KEY `idx_equipment_id` (`equipment_id`),
  KEY `idx_fault_date` (`fault_date`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备故障记录表';
```

## 4. 后端开发

### 4.1 实体类

#### Equipment

```java
package com.zssystem.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.time.LocalDate;
import java.time.LocalDateTime;

@Data
@TableName("equipment")
public class Equipment {
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private String equipmentNo;
    
    private String equipmentName;
    
    private String equipmentModel;
    
    private String manufacturer;
    
    private LocalDate purchaseDate;
    
    private Integer status; // 0-停用，1-正常，2-维修中
    
    private String remark;
    
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;
    
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;
    
    @TableLogic
    private Integer deleted;
}
```

#### EquipmentProduct

```java
package com.zssystem.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.time.LocalDateTime;

@Data
@TableName("equipment_product")
public class EquipmentProduct {
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private Long equipmentId;
    
    private String equipmentNo;
    
    private String productCode;
    
    private String productName;
    
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;
    
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;
    
    @TableLogic
    private Integer deleted;
}
```

#### EquipmentCheck

```java
package com.zssystem.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.time.LocalDate;
import java.time.LocalDateTime;

@Data
@TableName("equipment_check")
public class EquipmentCheck {
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private Long equipmentId;
    
    private String equipmentNo;
    
    private String equipmentName;
    
    private String checkMonth; // YYYY-MM
    
    private LocalDate checkDate;
    
    private String checkerName;
    
    // 电路部分（3项）
    private Integer circuitItem1;
    private Integer circuitItem2;
    private Integer circuitItem3;
    
    // 机架部分（3项）
    private Integer frameItem1;
    private Integer frameItem2;
    private Integer frameItem3;
    
    // 油路部分（5项）
    private Integer oilItem1;
    private Integer oilItem2;
    private Integer oilItem3;
    private Integer oilItem4;
    private Integer oilItem5;
    
    // 周边设备（5项）
    private Integer peripheralItem1;
    private Integer peripheralItem2;
    private Integer peripheralItem3;
    private Integer peripheralItem4;
    private Integer peripheralItem5;
    
    private String remark;
    
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;
    
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;
    
    @TableLogic
    private Integer deleted;
}
```

### 4.2 DTO（新增/调整部分）

#### EquipmentCheckQueryDTO

```java
package com.zssystem.dto;

import lombok.Data;

@Data
public class EquipmentCheckQueryDTO {
    private String equipmentNo;
    private String equipmentName;
    private String checkMonth; // YYYY-MM
    private String checkerName;
    private Integer pageNum = 1;
    private Integer pageSize = 30; // 默认30条（一个月）
}
```

#### EquipmentCheckSaveDTO

```java
package com.zssystem.dto;

import jakarta.validation.constraints.NotNull;
import lombok.Data;
import java.time.LocalDate;

@Data
public class EquipmentCheckSaveDTO {
    private Long id;
    
    @NotNull(message = "设备ID不能为空")
    private Long equipmentId;
    
    @NotNull(message = "检查日期不能为空")
    private LocalDate checkDate;
    
    @NotNull(message = "检点人姓名不能为空")
    private String checkerName;
    
    // 电路部分
    private Integer circuitItem1;
    private Integer circuitItem2;
    private Integer circuitItem3;
    
    // 机架部分
    private Integer frameItem1;
    private Integer frameItem2;
    private Integer frameItem3;
    
    // 油路部分
    private Integer oilItem1;
    private Integer oilItem2;
    private Integer oilItem3;
    private Integer oilItem4;
    private Integer oilItem5;
    
    // 周边设备
    private Integer peripheralItem1;
    private Integer peripheralItem2;
    private Integer peripheralItem3;
    private Integer peripheralItem4;
    private Integer peripheralItem5;
    
    private String remark;
}
```

#### EquipmentProductDTO（示例）

```java
package com.zssystem.dto;

import jakarta.validation.constraints.NotNull;
import lombok.Data;

@Data
public class EquipmentProductSaveDTO {
    private Long id;
    
    @NotNull(message = "设备ID不能为空")
    private Long equipmentId;
    
    @NotNull(message = "产品编码不能为空")
    private String productCode;
    
    @NotNull(message = "产品名称不能为空")
    private String productName;
}
```

### 4.3 Service 实现要点（点检）

```java
@Override
@Transactional
public void saveCheck(EquipmentCheckSaveDTO dto) {
    // 1. 查询设备信息
    Equipment equipment = equipmentMapper.selectById(dto.getEquipmentId());
    if (equipment == null) {
        throw new RuntimeException("设备不存在");
    }
    
    // 2. 生成检查月份（YYYY-MM格式）
    String checkMonth = dto.getCheckDate().format(DateTimeFormatter.ofPattern("yyyy-MM"));
    
    // 3. 检查当天是否已有点检记录
    EquipmentCheck existCheck = equipmentCheckMapper.selectOne(
        new LambdaQueryWrapper<EquipmentCheck>()
            .eq(EquipmentCheck::getEquipmentId, dto.getEquipmentId())
            .eq(EquipmentCheck::getCheckDate, dto.getCheckDate())
    );
    
    EquipmentCheck check;
    if (existCheck != null) {
        // 更新
        check = existCheck;
    } else {
        // 新增
        check = new EquipmentCheck();
    }
    
    // 4. 填充数据
    check.setEquipmentId(dto.getEquipmentId());
    check.setEquipmentNo(equipment.getEquipmentNo());
    check.setEquipmentName(equipment.getEquipmentName());
    check.setCheckMonth(checkMonth);
    check.setCheckDate(dto.getCheckDate());
    check.setCheckerName(dto.getCheckerName());
    
    // 填充检查项
    check.setCircuitItem1(dto.getCircuitItem1());
    check.setCircuitItem2(dto.getCircuitItem2());
    check.setCircuitItem3(dto.getCircuitItem3());
    check.setFrameItem1(dto.getFrameItem1());
    check.setFrameItem2(dto.getFrameItem2());
    check.setFrameItem3(dto.getFrameItem3());
    check.setOilItem1(dto.getOilItem1());
    check.setOilItem2(dto.getOilItem2());
    check.setOilItem3(dto.getOilItem3());
    check.setOilItem4(dto.getOilItem4());
    check.setOilItem5(dto.getOilItem5());
    check.setPeripheralItem1(dto.getPeripheralItem1());
    check.setPeripheralItem2(dto.getPeripheralItem2());
    check.setPeripheralItem3(dto.getPeripheralItem3());
    check.setPeripheralItem4(dto.getPeripheralItem4());
    check.setPeripheralItem5(dto.getPeripheralItem5());
    
    check.setRemark(dto.getRemark());
    
    if (existCheck != null) {
        equipmentCheckMapper.updateById(check);
    } else {
        equipmentCheckMapper.insert(check);
    }
}
```

### 4.4 Service 实现要点（设备可生产产品）

```java
@Override
@Transactional
public void bindProductToEquipment(EquipmentProductSaveDTO dto) {
    Equipment equipment = equipmentMapper.selectById(dto.getEquipmentId());
    if (equipment == null) {
        throw new RuntimeException("设备不存在");
    }
    
    // 检查是否已存在绑定
    EquipmentProduct exist = equipmentProductMapper.selectOne(
        new LambdaQueryWrapper<EquipmentProduct>()
            .eq(EquipmentProduct::getEquipmentId, dto.getEquipmentId())
            .eq(EquipmentProduct::getProductCode, dto.getProductCode())
    );
    if (exist != null) {
        throw new RuntimeException("该设备已配置该产品");
    }
    
    EquipmentProduct ep = new EquipmentProduct();
    ep.setEquipmentId(dto.getEquipmentId());
    ep.setEquipmentNo(equipment.getEquipmentNo());
    ep.setProductCode(dto.getProductCode());
    ep.setProductName(dto.getProductName());
    equipmentProductMapper.insert(ep);
}
```

## 5. 前端开发

### 5.1 点检表页面设计

点检表页面需要展示30天的数据，采用表格形式：
- 第一列：日期
- 第二列：检点人
- 第三列开始：16个检查项（每个检查项显示正常/异常）
- 最后列：备注

### 5.2 点检录入表单

表单包含：
- 设备选择（下拉选择，显示设备编号 + 设备名称）
- 检查日期（日期选择器）
- 检点人（输入框）
- 16个检查项（每个检查项使用开关或单选框：正常/异常）
- 备注（文本域）

### 5.3 点检查询功能

- 按月份查询（月份选择器）
- 按设备编号查询（下拉选择）
- 按检点人查询（输入框）

### 5.4 设备可生产产品配置页面

- 在设备详情页增加“可生产产品”标签页或区域：
  - 列表展示当前设备可生产的产品（产品编码、产品名称）
  - 支持新增一条可生产产品配置（输入/选择产品编码和产品名称）
  - 支持删除某个产品配置
- 在产品相关页面（如生产管理模块）支持按产品选择可用设备（调用后端接口按产品编码查询可生产该产品的设备列表）

## 6. 注意事项

1. **设备编号必须唯一**（`equipment.equipment_no` 唯一索引）
2. **同一设备同一天只能有一条点检记录**（唯一约束：`equipment_id + check_date`）
3. 检查月份自动从检查日期提取（YYYY-MM格式）
4. 每个检查项状态：1-正常，0-异常
5. 点检表查询默认显示30条数据（一个月）
6. 支持按月份、设备、检点人筛选查询
7. 异常项可以在备注中说明具体情况
8. 删除使用逻辑删除
9. 设备与可生产产品关系使用 `equipment_product` 表维护，同一设备与同一产品的关联只能配置一次
10. 与生产管理模块的产品信息保持字段命名一致（`product_code`、`product_name`），便于联动使用