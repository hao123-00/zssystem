# 品质管理功能开发文档

## 1. 功能概述

品质管理模块用于管理注塑生产中的质量检验记录，包括检验记录管理、不合格品处理、质量追溯、合格率统计等。

## 2. 功能需求

### 2.1 检验记录管理
- 检验记录录入
- 检验记录查询（分页）
- 检验信息：订单号、产品名称、检验日期、检验人员、检验数量、合格数量、不合格数量、合格率等

### 2.2 不合格品处理
- 不合格品记录
- 不合格原因分类
- 处理方式：返工、报废、让步接收
- 处理记录跟踪

### 2.3 质量追溯
- 根据订单号追溯检验记录
- 根据产品批次追溯检验记录
- 追溯信息包括：生产记录、检验记录、不合格品处理记录等

### 2.4 合格率统计
- 按日期统计合格率
- 按订单统计合格率
- 按产品统计合格率
- 合格率趋势分析（可选）

### 2.5 质量报表
- 质量日报
- 质量月报
- 不合格品分析报表
- 报表导出功能

## 3. 数据库设计

### 3.1 检验记录表（quality_inspection）

```sql
CREATE TABLE `quality_inspection` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `inspection_no` varchar(50) NOT NULL COMMENT '检验单号',
  `order_id` bigint NOT NULL COMMENT '订单ID',
  `order_no` varchar(50) NOT NULL COMMENT '订单编号',
  `product_name` varchar(100) NOT NULL COMMENT '产品名称',
  `batch_no` varchar(50) DEFAULT NULL COMMENT '批次号',
  `inspection_date` date NOT NULL COMMENT '检验日期',
  `inspector_name` varchar(50) DEFAULT NULL COMMENT '检验人员',
  `inspection_quantity` int NOT NULL COMMENT '检验数量',
  `qualified_quantity` int NOT NULL COMMENT '合格数量',
  `unqualified_quantity` int NOT NULL COMMENT '不合格数量',
  `qualified_rate` decimal(5,2) DEFAULT NULL COMMENT '合格率（%）',
  `inspection_result` tinyint DEFAULT NULL COMMENT '检验结果：0-不合格，1-合格',
  `remark` varchar(500) DEFAULT NULL COMMENT '备注',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_inspection_no` (`inspection_no`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_inspection_date` (`inspection_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='检验记录表';
```

### 3.2 不合格品记录表（quality_defect）

```sql
CREATE TABLE `quality_defect` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `inspection_id` bigint NOT NULL COMMENT '检验记录ID',
  `defect_no` varchar(50) NOT NULL COMMENT '不合格品编号',
  `defect_type` varchar(50) DEFAULT NULL COMMENT '不合格类型',
  `defect_reason` varchar(500) DEFAULT NULL COMMENT '不合格原因',
  `defect_quantity` int NOT NULL COMMENT '不合格数量',
  `handle_method` varchar(50) DEFAULT NULL COMMENT '处理方式：返工、报废、让步接收',
  `handler_name` varchar(50) DEFAULT NULL COMMENT '处理人员',
  `handle_date` date DEFAULT NULL COMMENT '处理日期',
  `status` tinyint DEFAULT 0 COMMENT '状态：0-待处理，1-处理中，2-已处理',
  `remark` varchar(500) DEFAULT NULL COMMENT '备注',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_defect_no` (`defect_no`),
  KEY `idx_inspection_id` (`inspection_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='不合格品记录表';
```

### 3.3 不合格原因分类表（quality_defect_type）

```sql
CREATE TABLE `quality_defect_type` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `type_code` varchar(50) NOT NULL COMMENT '类型编码',
  `type_name` varchar(100) NOT NULL COMMENT '类型名称',
  `parent_id` bigint DEFAULT 0 COMMENT '父类型ID',
  `sort_order` int DEFAULT 0 COMMENT '排序',
  `status` tinyint DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_type_code` (`type_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='不合格原因分类表';
```

## 4. 开发要点

### 4.1 合格率计算
- 合格率 = (合格数量 / 检验数量) × 100%
- 自动计算并保存

### 4.2 检验结果判定
- 如果合格率 >= 95%，判定为合格
- 如果合格率 < 95%，判定为不合格

### 4.3 不合格品处理流程
- 待处理 → 处理中 → 已处理
- 处理方式：返工、报废、让步接收

### 4.4 质量追溯
- 根据订单号查询所有相关的检验记录和不合格品记录
- 关联生产记录，形成完整的追溯链

### 4.5 统计功能
- 使用SQL聚合函数统计合格率
- 支持按日期、订单、产品等维度统计
- 提供图表展示（可选）

## 5. 注意事项

1. 检验单号必须唯一
2. 不合格数量 = 检验数量 - 合格数量
3. 合格率自动计算，保留两位小数
4. 删除使用逻辑删除
5. 不合格品处理需要跟踪处理状态
6. 质量追溯需要关联多个表的数据
7. 支持质量报表导出功能
