# 注塑工艺文件管理功能开发文档

## 1. 功能概述

注塑工艺文件管理是生产管理模块的重要组成部分，主要用于管理注塑生产过程中的工艺文件（Excel格式），实现工艺文件的上传、审批、版本管理、电子受控章等功能。

### 1.1 核心功能
- 注塑工艺文件编制与上传
- 多级审批流程管理
- 工艺文件版本控制
- 电子受控章管理
- 工艺文件查看与下载
- 工艺文件修改与变更管理
- 审批历史记录与追溯

### 1.2 业务规则
- 每台设备（机台）至少配置 4 个注塑工艺文件
- 工艺文件必须为 Excel 格式（.xls, .xlsx）
- 工艺文件编制人为注塑组长
- 审批流程固定：车间主任审核 → 注塑部经理会签 → 生产技术部经理批准
- 审批通过后自动盖电子受控章
- 工艺文件修改需要重新走审批流程
- 每次修改产生新版本，保留历史版本

## 2. 审批流程设计

### 2.1 流程状态

| 状态码 | 状态名称 | 说明 |
|--------|----------|------|
| 0 | 草稿 | 初始状态，未提交审批 |
| 1 | 待车间主任审核 | 已提交，等待车间主任审核 |
| 2 | 待注塑部经理会签 | 车间主任审核通过，等待注塑部经理会签 |
| 3 | 待生产技术部经理批准 | 注塑部经理会签通过，等待生产技术部经理批准 |
| 5 | 已批准（生效中） | 生产技术部经理批准通过，自动盖电子受控章，工艺文件生效 |
| -1 | 已驳回 | 任一审批环节驳回 |
| -2 | 已作废 | 工艺文件作废 |

### 2.2 审批流程图

```
[草稿(0)] 
    ↓ 提交审批
[待车间主任审核(1)] ←→ [已驳回(-1)]
    ↓ 审核通过
[待注塑部经理会签(2)] ←→ [已驳回(-1)]
    ↓ 会签通过
[待生产技术部经理批准(3)] ←→ [已驳回(-1)]
    ↓ 批准通过 + 盖电子受控章
[已批准-生效中(5)]
    ↓ 作废
[已作废(-2)]
```

### 2.3 审批权限

| 审批环节 | 角色 | 权限 |
|----------|------|------|
| 编制/上传 | 注塑组长 | 创建、编辑草稿、提交审批、修改已驳回的工艺文件 |
| 第一级审核 | 车间主任 | 审核通过、驳回（需填写意见） |
| 第二级会签 | 注塑部经理 | 会签通过、驳回（需填写意见） |
| 第三级批准 | 生产技术部经理 | 最终批准、驳回（需填写意见）、盖电子受控章 |
| 查看 | 所有相关人员 | 查看已批准的工艺文件 |
| 作废 | 注塑组长、部门经理 | 作废已生效的工艺文件 |

## 3. 数据库设计

### 3.1 注塑工艺文件表（process_file）

```sql
CREATE TABLE `process_file` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `file_no` varchar(50) NOT NULL COMMENT '工艺文件编号（唯一，格式：PF20260124001）',
  `equipment_id` bigint NOT NULL COMMENT '设备ID',
  `equipment_no` varchar(50) NOT NULL COMMENT '设备编号（冗余）',
  `machine_no` varchar(50) NOT NULL COMMENT '机台号（冗余）',
  `file_name` varchar(200) NOT NULL COMMENT '文件名称',
  `file_path` varchar(500) NOT NULL COMMENT '文件存储路径',
  `file_size` bigint DEFAULT NULL COMMENT '文件大小（字节）',
  `file_type` varchar(50) DEFAULT NULL COMMENT '文件类型（xls, xlsx）',
  `version` int DEFAULT 1 COMMENT '版本号（从1开始）',
  `status` int DEFAULT 0 COMMENT '状态：0-草稿，1-待车间主任审核，2-待注塑部经理会签，3-待生产技术部经理批准，5-已批准（生效中），-1-已驳回，-2-已作废',
  `creator_id` bigint NOT NULL COMMENT '创建人ID（注塑组长）',
  `creator_name` varchar(50) NOT NULL COMMENT '创建人姓名',
  `submit_time` datetime DEFAULT NULL COMMENT '提交审批时间',
  `approval_time` datetime DEFAULT NULL COMMENT '最终批准时间',
  `effective_time` datetime DEFAULT NULL COMMENT '生效时间（批准时间）',
  `invalid_time` datetime DEFAULT NULL COMMENT '失效时间（作废时间）',
  `seal_image_path` varchar(500) DEFAULT NULL COMMENT '电子受控章图片路径',
  `is_current` tinyint DEFAULT 1 COMMENT '是否当前版本：1-是，0-否（历史版本）',
  `parent_file_id` bigint DEFAULT NULL COMMENT '父工艺文件ID（修改时关联原文件）',
  `change_reason` varchar(500) DEFAULT NULL COMMENT '变更原因（修改时必填）',
  `remark` varchar(1000) DEFAULT NULL COMMENT '备注',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_file_no` (`file_no`),
  KEY `idx_equipment_id` (`equipment_id`),
  KEY `idx_equipment_no` (`equipment_no`),
  KEY `idx_machine_no` (`machine_no`),
  KEY `idx_status` (`status`),
  KEY `idx_creator_id` (`creator_id`),
  KEY `idx_parent_file_id` (`parent_file_id`),
  KEY `idx_is_current` (`is_current`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='注塑工艺文件表';
```

### 3.2 工艺文件审批记录表（process_file_approval）

```sql
CREATE TABLE `process_file_approval` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `file_id` bigint NOT NULL COMMENT '工艺文件ID',
  `file_no` varchar(50) NOT NULL COMMENT '工艺文件编号（冗余）',
  `approval_level` int NOT NULL COMMENT '审批级别：1-车间主任审核，2-注塑部经理会签，3-生产技术部经理批准',
  `approver_id` bigint NOT NULL COMMENT '审批人ID',
  `approver_name` varchar(50) NOT NULL COMMENT '审批人姓名',
  `approver_role` varchar(50) NOT NULL COMMENT '审批人角色',
  `approval_result` int NOT NULL COMMENT '审批结果：1-通过，0-驳回',
  `approval_opinion` varchar(500) DEFAULT NULL COMMENT '审批意见（驳回时必填）',
  `approval_time` datetime NOT NULL COMMENT '审批时间',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_file_id` (`file_id`),
  KEY `idx_file_no` (`file_no`),
  KEY `idx_approver_id` (`approver_id`),
  KEY `idx_approval_level` (`approval_level`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工艺文件审批记录表';
```

### 3.3 电子受控章表（process_file_seal）

```sql
CREATE TABLE `process_file_seal` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `file_id` bigint NOT NULL COMMENT '工艺文件ID',
  `file_no` varchar(50) NOT NULL COMMENT '工艺文件编号（冗余）',
  `seal_no` varchar(50) NOT NULL COMMENT '印章编号',
  `seal_type` varchar(50) DEFAULT '受控章' COMMENT '印章类型',
  `seal_content` varchar(200) DEFAULT NULL COMMENT '印章内容',
  `seal_image_path` varchar(500) NOT NULL COMMENT '印章图片路径',
  `seal_time` datetime NOT NULL COMMENT '盖章时间',
  `seal_by_id` bigint NOT NULL COMMENT '盖章人ID（生产技术部经理）',
  `seal_by_name` varchar(50) NOT NULL COMMENT '盖章人姓名',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_file_id` (`file_id`),
  KEY `idx_file_no` (`file_no`),
  KEY `idx_seal_by_id` (`seal_by_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工艺文件电子受控章表';
```

## 4. 后端开发

### 4.1 实体类（Entity）

#### ProcessFile.java

```java
package com.zssystem.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.time.LocalDateTime;

@Data
@TableName("process_file")
public class ProcessFile {
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private String fileNo;
    private Long equipmentId;
    private String equipmentNo;
    private String machineNo;
    private String fileName;
    private String filePath;
    private Long fileSize;
    private String fileType;
    private Integer version;
    private Integer status;
    private Long creatorId;
    private String creatorName;
    private LocalDateTime submitTime;
    private LocalDateTime approvalTime;
    private LocalDateTime effectiveTime;
    private LocalDateTime invalidTime;
    private String sealImagePath;
    private Integer isCurrent;
    private Long parentFileId;
    private String changeReason;
    private String remark;
    
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;
    
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;
    
    @TableLogic
    private Integer deleted;
}
```

#### ProcessFileApproval.java

```java
package com.zssystem.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.time.LocalDateTime;

@Data
@TableName("process_file_approval")
public class ProcessFileApproval {
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private Long fileId;
    private String fileNo;
    private Integer approvalLevel;
    private Long approverId;
    private String approverName;
    private String approverRole;
    private Integer approvalResult;
    private String approvalOpinion;
    private LocalDateTime approvalTime;
    
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;
}
```

#### ProcessFileSeal.java

```java
package com.zssystem.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.time.LocalDateTime;

@Data
@TableName("process_file_seal")
public class ProcessFileSeal {
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private Long fileId;
    private String fileNo;
    private String sealNo;
    private String sealType;
    private String sealContent;
    private String sealImagePath;
    private LocalDateTime sealTime;
    private Long sealById;
    private String sealByName;
    
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;
}
```

### 4.2 DTO（数据传输对象）

#### ProcessFileQueryDTO.java

```java
package com.zssystem.dto;

import lombok.Data;

@Data
public class ProcessFileQueryDTO {
    private String fileNo;
    private String equipmentNo;
    private String machineNo;
    private String fileName;
    private Integer status;
    private String creatorName;
    private Integer version;
    private Integer isCurrent;
    private Integer pageNum = 1;
    private Integer pageSize = 10;
}
```

#### ProcessFileUploadDTO.java

```java
package com.zssystem.dto;

import jakarta.validation.constraints.NotNull;
import lombok.Data;
import org.springframework.web.multipart.MultipartFile;

@Data
public class ProcessFileUploadDTO {
    private Long id; // 修改时传入
    
    @NotNull(message = "设备ID不能为空")
    private Long equipmentId;
    
    @NotNull(message = "文件不能为空")
    private MultipartFile file;
    
    private String changeReason; // 修改时必填
    
    private String remark;
}
```

#### ProcessFileApprovalDTO.java

```java
package com.zssystem.dto;

import jakarta.validation.constraints.NotNull;
import lombok.Data;

@Data
public class ProcessFileApprovalDTO {
    @NotNull(message = "工艺文件ID不能为空")
    private Long fileId;
    
    @NotNull(message = "审批结果不能为空")
    private Integer approvalResult; // 1-通过，0-驳回
    
    private String approvalOpinion; // 审批意见（驳回时必填）
}
```

### 4.3 VO（视图对象）

#### ProcessFileVO.java

```java
package com.zssystem.vo;

import lombok.Data;
import java.time.LocalDateTime;
import java.util.List;

@Data
public class ProcessFileVO {
    private Long id;
    private String fileNo;
    private Long equipmentId;
    private String equipmentNo;
    private String machineNo;
    private String fileName;
    private String filePath;
    private Long fileSize;
    private String fileSizeText; // 格式化后的文件大小，如：2.5MB
    private String fileType;
    private Integer version;
    private String versionText; // 版本号文本，如：V1.0
    private Integer status;
    private String statusText; // 状态文本
    private Long creatorId;
    private String creatorName;
    private LocalDateTime submitTime;
    private LocalDateTime approvalTime;
    private LocalDateTime effectiveTime;
    private LocalDateTime invalidTime;
    private String sealImagePath;
    private Integer isCurrent;
    private Long parentFileId;
    private String changeReason;
    private String remark;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
    
    // 扩展信息
    private List<ProcessFileApprovalVO> approvalHistory; // 审批历史
    private ProcessFileSealVO sealInfo; // 电子受控章信息
    private Integer currentApprovalLevel; // 当前审批级别
    private String nextApproverRole; // 下一审批人角色
}
```

#### ProcessFileApprovalVO.java

```java
package com.zssystem.vo;

import lombok.Data;
import java.time.LocalDateTime;

@Data
public class ProcessFileApprovalVO {
    private Long id;
    private Long fileId;
    private String fileNo;
    private Integer approvalLevel;
    private String approvalLevelText; // 审批级别文本
    private Long approverId;
    private String approverName;
    private String approverRole;
    private Integer approvalResult;
    private String approvalResultText; // 审批结果文本
    private String approvalOpinion;
    private LocalDateTime approvalTime;
}
```

#### ProcessFileSealVO.java

```java
package com.zssystem.vo;

import lombok.Data;
import java.time.LocalDateTime;

@Data
public class ProcessFileSealVO {
    private Long id;
    private Long fileId;
    private String fileNo;
    private String sealNo;
    private String sealType;
    private String sealContent;
    private String sealImagePath;
    private LocalDateTime sealTime;
    private Long sealById;
    private String sealByName;
}
```

### 4.4 Service 接口与实现

#### ProcessFileService.java

```java
package com.zssystem.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.zssystem.dto.ProcessFileApprovalDTO;
import com.zssystem.dto.ProcessFileQueryDTO;
import com.zssystem.dto.ProcessFileUploadDTO;
import com.zssystem.vo.ProcessFileVO;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;

public interface ProcessFileService {
    /**
     * 分页查询工艺文件列表
     */
    IPage<ProcessFileVO> getProcessFileList(ProcessFileQueryDTO queryDTO);
    
    /**
     * 根据ID查询工艺文件详情
     */
    ProcessFileVO getProcessFileById(Long id);
    
    /**
     * 上传工艺文件（新建或修改）
     */
    void uploadProcessFile(ProcessFileUploadDTO uploadDTO, Long currentUserId, String currentUserName) throws IOException;
    
    /**
     * 提交审批
     */
    void submitForApproval(Long fileId, Long currentUserId);
    
    /**
     * 审批工艺文件
     */
    void approveProcessFile(ProcessFileApprovalDTO approvalDTO, Long currentUserId, String currentUserName, String currentUserRole);
    
    /**
     * 作废工艺文件
     */
    void invalidateProcessFile(Long fileId, Long currentUserId);
    
    /**
     * 下载工艺文件
     */
    byte[] downloadProcessFile(Long fileId) throws IOException;
    
    /**
     * 查询设备的工艺文件列表
     */
    IPage<ProcessFileVO> getProcessFilesByEquipment(Long equipmentId, Integer pageNum, Integer pageSize);
    
    /**
     * 获取待审批的工艺文件列表（根据当前用户角色）
     */
    IPage<ProcessFileVO> getPendingApprovalFiles(String userRole, Integer pageNum, Integer pageSize);
}
```

#### ProcessFileServiceImpl.java（核心实现）

```java
package com.zssystem.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.zssystem.dto.ProcessFileApprovalDTO;
import com.zssystem.dto.ProcessFileQueryDTO;
import com.zssystem.dto.ProcessFileUploadDTO;
import com.zssystem.entity.*;
import com.zssystem.mapper.*;
import com.zssystem.service.ProcessFileService;
import com.zssystem.util.BeanUtil;
import com.zssystem.vo.ProcessFileApprovalVO;
import com.zssystem.vo.ProcessFileVO;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;
import java.util.stream.Collectors;

@Service
public class ProcessFileServiceImpl implements ProcessFileService {

    @Autowired
    private ProcessFileMapper processFileMapper;
    
    @Autowired
    private ProcessFileApprovalMapper approvalMapper;
    
    @Autowired
    private ProcessFileSealMapper sealMapper;
    
    @Autowired
    private EquipmentMapper equipmentMapper;
    
    @Value("${file.upload.path:/data/uploads/process-files}")
    private String uploadPath;
    
    @Value("${file.upload.max-size:10485760}")
    private Long maxFileSize;
    
    private static final Map<Integer, String> STATUS_MAP = new HashMap<>();
    private static final Map<Integer, String> APPROVAL_LEVEL_MAP = new HashMap<>();
    
    static {
        STATUS_MAP.put(0, "草稿");
        STATUS_MAP.put(1, "待车间主任审核");
        STATUS_MAP.put(2, "待注塑部经理会签");
        STATUS_MAP.put(3, "待生产技术部经理批准");
        STATUS_MAP.put(5, "已批准（生效中）");
        STATUS_MAP.put(-1, "已驳回");
        STATUS_MAP.put(-2, "已作废");
        
        APPROVAL_LEVEL_MAP.put(1, "车间主任审核");
        APPROVAL_LEVEL_MAP.put(2, "注塑部经理会签");
        APPROVAL_LEVEL_MAP.put(3, "生产技术部经理批准");
    }

    @Override
    @Transactional
    public void uploadProcessFile(ProcessFileUploadDTO uploadDTO, Long currentUserId, String currentUserName) throws IOException {
        // 1. 验证文件
        MultipartFile file = uploadDTO.getFile();
        validateFile(file);
        
        // 2. 查询设备信息
        Equipment equipment = equipmentMapper.selectById(uploadDTO.getEquipmentId());
        if (equipment == null) {
            throw new RuntimeException("设备不存在");
        }
        
        ProcessFile processFile;
        boolean isUpdate = uploadDTO.getId() != null;
        
        if (isUpdate) {
            // 修改：创建新版本
            ProcessFile oldFile = processFileMapper.selectById(uploadDTO.getId());
            if (oldFile == null) {
                throw new RuntimeException("原工艺文件不存在");
            }
            
            // 验证变更原因
            if (uploadDTO.getChangeReason() == null || uploadDTO.getChangeReason().trim().isEmpty()) {
                throw new RuntimeException("修改工艺文件必须填写变更原因");
            }
            
            // 将原文件标记为历史版本
            oldFile.setIsCurrent(0);
            processFileMapper.updateById(oldFile);
            
            // 创建新版本
            processFile = new ProcessFile();
            processFile.setParentFileId(oldFile.getId());
            processFile.setVersion(oldFile.getVersion() + 1);
            processFile.setChangeReason(uploadDTO.getChangeReason());
        } else {
            // 新建
            processFile = new ProcessFile();
            processFile.setVersion(1);
        }
        
        // 3. 生成文件编号
        String fileNo = generateFileNo();
        
        // 4. 保存文件到磁盘
        String filePath = saveFile(file, fileNo);
        
        // 5. 填充数据
        processFile.setFileNo(fileNo);
        processFile.setEquipmentId(equipment.getId());
        processFile.setEquipmentNo(equipment.getEquipmentNo());
        processFile.setMachineNo(equipment.getMachineNo());
        processFile.setFileName(file.getOriginalFilename());
        processFile.setFilePath(filePath);
        processFile.setFileSize(file.getSize());
        processFile.setFileType(getFileExtension(file.getOriginalFilename()));
        processFile.setStatus(0); // 草稿状态
        processFile.setCreatorId(currentUserId);
        processFile.setCreatorName(currentUserName);
        processFile.setIsCurrent(1);
        processFile.setRemark(uploadDTO.getRemark());
        
        processFileMapper.insert(processFile);
    }
    
    @Override
    @Transactional
    public void submitForApproval(Long fileId, Long currentUserId) {
        ProcessFile processFile = processFileMapper.selectById(fileId);
        if (processFile == null) {
            throw new RuntimeException("工艺文件不存在");
        }
        
        if (!processFile.getCreatorId().equals(currentUserId)) {
            throw new RuntimeException("只有创建人才能提交审批");
        }
        
        if (processFile.getStatus() != 0) {
            throw new RuntimeException("只有草稿状态才能提交审批");
        }
        
        processFile.setStatus(1); // 待车间主任审核
        processFile.setSubmitTime(LocalDateTime.now());
        processFileMapper.updateById(processFile);
    }
    
    @Override
    @Transactional
    public void approveProcessFile(ProcessFileApprovalDTO approvalDTO, Long currentUserId, 
                                   String currentUserName, String currentUserRole) {
        ProcessFile processFile = processFileMapper.selectById(approvalDTO.getFileId());
        if (processFile == null) {
            throw new RuntimeException("工艺文件不存在");
        }
        
        // 验证审批权限
        int currentLevel = getCurrentApprovalLevel(processFile.getStatus());
        validateApprovalPermission(currentLevel, currentUserRole);
        
        // 保存审批记录
        ProcessFileApproval approval = new ProcessFileApproval();
        approval.setFileId(processFile.getId());
        approval.setFileNo(processFile.getFileNo());
        approval.setApprovalLevel(currentLevel);
        approval.setApproverId(currentUserId);
        approval.setApproverName(currentUserName);
        approval.setApproverRole(currentUserRole);
        approval.setApprovalResult(approvalDTO.getApprovalResult());
        approval.setApprovalOpinion(approvalDTO.getApprovalOpinion());
        approval.setApprovalTime(LocalDateTime.now());
        approvalMapper.insert(approval);
        
        // 更新工艺文件状态
        if (approvalDTO.getApprovalResult() == 1) {
            // 通过
            int nextStatus = getNextStatus(processFile.getStatus());
            processFile.setStatus(nextStatus);
            
            // 如果是最终批准，生成电子受控章
            if (nextStatus == 5) {
                processFile.setApprovalTime(LocalDateTime.now());
                processFile.setEffectiveTime(LocalDateTime.now());
                generateSeal(processFile, currentUserId, currentUserName);
            }
        } else {
            // 驳回
            processFile.setStatus(-1);
        }
        
        processFileMapper.updateById(processFile);
    }
    
    /**
     * 生成电子受控章
     */
    private void generateSeal(ProcessFile processFile, Long sealById, String sealByName) {
        String sealNo = "SEAL" + LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMddHHmmss"));
        String sealImagePath = "/seals/" + processFile.getFileNo() + "_seal.png";
        
        // TODO: 实际生成受控章图片的逻辑
        // 可以使用图片处理库生成带有公司信息、日期、编号等的印章图片
        
        ProcessFileSeal seal = new ProcessFileSeal();
        seal.setFileId(processFile.getId());
        seal.setFileNo(processFile.getFileNo());
        seal.setSealNo(sealNo);
        seal.setSealType("受控章");
        seal.setSealContent("已批准生效");
        seal.setSealImagePath(sealImagePath);
        seal.setSealTime(LocalDateTime.now());
        seal.setSealById(sealById);
        seal.setSealByName(sealByName);
        
        sealMapper.insert(seal);
        
        processFile.setSealImagePath(sealImagePath);
    }
    
    /**
     * 验证文件
     */
    private void validateFile(MultipartFile file) {
        if (file == null || file.isEmpty()) {
            throw new RuntimeException("文件不能为空");
        }
        
        if (file.getSize() > maxFileSize) {
            throw new RuntimeException("文件大小超过限制：" + (maxFileSize / 1024 / 1024) + "MB");
        }
        
        String filename = file.getOriginalFilename();
        if (filename == null || (!filename.endsWith(".xls") && !filename.endsWith(".xlsx"))) {
            throw new RuntimeException("只支持Excel文件格式（.xls, .xlsx）");
        }
    }
    
    /**
     * 生成文件编号
     */
    private String generateFileNo() {
        String prefix = "PF" + LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
        
        // 查询当天最大序号
        String maxFileNo = processFileMapper.getMaxFileNoByPrefix(prefix);
        int sequence = 1;
        if (maxFileNo != null && maxFileNo.length() > prefix.length()) {
            sequence = Integer.parseInt(maxFileNo.substring(prefix.length())) + 1;
        }
        
        return prefix + String.format("%03d", sequence);
    }
    
    /**
     * 保存文件到磁盘
     */
    private String saveFile(MultipartFile file, String fileNo) throws IOException {
        LocalDateTime now = LocalDateTime.now();
        String year = now.format(DateTimeFormatter.ofPattern("yyyy"));
        String month = now.format(DateTimeFormatter.ofPattern("MM"));
        
        String dirPath = uploadPath + File.separator + year + File.separator + month;
        File dir = new File(dirPath);
        if (!dir.exists()) {
            dir.mkdirs();
        }
        
        String extension = getFileExtension(file.getOriginalFilename());
        String filename = fileNo + "." + extension;
        String filePath = dirPath + File.separator + filename;
        
        file.transferTo(new File(filePath));
        
        return filePath;
    }
    
    /**
     * 获取文件扩展名
     */
    private String getFileExtension(String filename) {
        if (filename == null || filename.lastIndexOf(".") == -1) {
            return "";
        }
        return filename.substring(filename.lastIndexOf(".") + 1);
    }
    
    /**
     * 获取当前审批级别
     */
    private int getCurrentApprovalLevel(int status) {
        return switch (status) {
            case 1 -> 1; // 车间主任审核
            case 2 -> 2; // 注塑部经理会签
            case 3 -> 3; // 生产技术部经理批准
            default -> throw new RuntimeException("当前状态不需要审批");
        };
    }
    
    /**
     * 验证审批权限
     */
    private void validateApprovalPermission(int approvalLevel, String userRole) {
        Map<Integer, String> levelRoleMap = new HashMap<>();
        levelRoleMap.put(1, "车间主任");
        levelRoleMap.put(2, "注塑部经理");
        levelRoleMap.put(3, "生产技术部经理");
        
        if (!levelRoleMap.get(approvalLevel).equals(userRole)) {
            throw new RuntimeException("您没有权限进行此审批操作");
        }
    }
    
    /**
     * 获取下一个状态
     */
    private int getNextStatus(int currentStatus) {
        return switch (currentStatus) {
            case 1 -> 2; // 车间主任审核通过 → 待注塑部经理会签
            case 2 -> 3; // 注塑部经理会签通过 → 待生产技术部经理批准
            case 3 -> 5; // 生产技术部经理批准通过 → 已批准（生效中）
            default -> throw new RuntimeException("状态流转异常");
        };
    }
    
    // 其他方法实现...
}
```

### 4.5 Controller 接口

#### ProcessFileController.java

```java
package com.zssystem.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.zssystem.common.Result;
import com.zssystem.dto.ProcessFileApprovalDTO;
import com.zssystem.dto.ProcessFileQueryDTO;
import com.zssystem.dto.ProcessFileUploadDTO;
import com.zssystem.service.ProcessFileService;
import com.zssystem.vo.ProcessFileVO;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

@Tag(name = "注塑工艺文件管理")
@RestController
@RequestMapping("/api/production/process-file")
public class ProcessFileController {
    
    @Autowired
    private ProcessFileService processFileService;
    
    @Operation(summary = "分页查询工艺文件列表")
    @GetMapping("/list")
    public Result<IPage<ProcessFileVO>> getList(@Validated ProcessFileQueryDTO queryDTO) {
        IPage<ProcessFileVO> page = processFileService.getProcessFileList(queryDTO);
        return Result.success(page);
    }
    
    @Operation(summary = "根据ID查询工艺文件详情")
    @GetMapping("/{id}")
    public Result<ProcessFileVO> getById(@PathVariable Long id) {
        ProcessFileVO vo = processFileService.getProcessFileById(id);
        return Result.success(vo);
    }
    
    @Operation(summary = "上传工艺文件")
    @PostMapping("/upload")
    public Result<Void> upload(
            @RequestParam(required = false) Long id,
            @RequestParam Long equipmentId,
            @RequestParam MultipartFile file,
            @RequestParam(required = false) String changeReason,
            @RequestParam(required = false) String remark) {
        // TODO: 从当前登录用户获取 userId 和 userName
        Long currentUserId = 1L;
        String currentUserName = "当前用户";
        
        ProcessFileUploadDTO uploadDTO = new ProcessFileUploadDTO();
        uploadDTO.setId(id);
        uploadDTO.setEquipmentId(equipmentId);
        uploadDTO.setFile(file);
        uploadDTO.setChangeReason(changeReason);
        uploadDTO.setRemark(remark);
        
        processFileService.uploadProcessFile(uploadDTO, currentUserId, currentUserName);
        return Result.success();
    }
    
    @Operation(summary = "提交审批")
    @PostMapping("/{id}/submit")
    public Result<Void> submit(@PathVariable Long id) {
        // TODO: 从当前登录用户获取 userId
        Long currentUserId = 1L;
        processFileService.submitForApproval(id, currentUserId);
        return Result.success();
    }
    
    @Operation(summary = "审批工艺文件")
    @PostMapping("/approve")
    public Result<Void> approve(@Validated @RequestBody ProcessFileApprovalDTO approvalDTO) {
        // TODO: 从当前登录用户获取 userId, userName, userRole
        Long currentUserId = 1L;
        String currentUserName = "当前用户";
        String currentUserRole = "车间主任";
        
        processFileService.approveProcessFile(approvalDTO, currentUserId, currentUserName, currentUserRole);
        return Result.success();
    }
    
    @Operation(summary = "作废工艺文件")
    @PostMapping("/{id}/invalidate")
    public Result<Void> invalidate(@PathVariable Long id) {
        // TODO: 从当前登录用户获取 userId
        Long currentUserId = 1L;
        processFileService.invalidateProcessFile(id, currentUserId);
        return Result.success();
    }
    
    @Operation(summary = "下载工艺文件")
    @GetMapping("/{id}/download")
    public ResponseEntity<byte[]> download(@PathVariable Long id) {
        try {
            byte[] fileContent = processFileService.downloadProcessFile(id);
            ProcessFileVO file = processFileService.getProcessFileById(id);
            
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_OCTET_STREAM);
            headers.setContentDispositionFormData("attachment", file.getFileName());
            
            return ResponseEntity.ok()
                    .headers(headers)
                    .body(fileContent);
        } catch (Exception e) {
            return ResponseEntity.internalServerError().build();
        }
    }
    
    @Operation(summary = "查询设备的工艺文件列表")
    @GetMapping("/equipment/{equipmentId}")
    public Result<IPage<ProcessFileVO>> getByEquipment(
            @PathVariable Long equipmentId,
            @RequestParam(defaultValue = "1") Integer pageNum,
            @RequestParam(defaultValue = "10") Integer pageSize) {
        IPage<ProcessFileVO> page = processFileService.getProcessFilesByEquipment(equipmentId, pageNum, pageSize);
        return Result.success(page);
    }
    
    @Operation(summary = "获取待审批的工艺文件列表")
    @GetMapping("/pending-approval")
    public Result<IPage<ProcessFileVO>> getPendingApproval(
            @RequestParam(defaultValue = "1") Integer pageNum,
            @RequestParam(defaultValue = "10") Integer pageSize) {
        // TODO: 从当前登录用户获取 userRole
        String userRole = "车间主任";
        IPage<ProcessFileVO> page = processFileService.getPendingApprovalFiles(userRole, pageNum, pageSize);
        return Result.success(page);
    }
}
```

## 5. 前端开发

### 5.1 页面结构

```
src/pages/Production/ProcessFile/
├── ProcessFileList.tsx          # 工艺文件列表页
├── ProcessFileUpload.tsx        # 工艺文件上传页
├── ProcessFileDetail.tsx        # 工艺文件详情页
├── ProcessFileApproval.tsx      # 工艺文件审批页
├── PendingApprovalList.tsx      # 待审批列表页
└── ProcessFileList.less         # 样式文件
```

### 5.2 API 接口定义

#### processFile.ts

```typescript
import { request } from '@/utils/request';

export interface ProcessFileInfo {
  id: number;
  fileNo: string;
  equipmentId: number;
  equipmentNo: string;
  machineNo: string;
  fileName: string;
  filePath: string;
  fileSize: number;
  fileSizeText: string;
  fileType: string;
  version: number;
  versionText: string;
  status: number;
  statusText: string;
  creatorId: number;
  creatorName: string;
  submitTime: string;
  approvalTime: string;
  effectiveTime: string;
  invalidTime: string;
  sealImagePath?: string;
  isCurrent: number;
  parentFileId?: number;
  changeReason?: string;
  remark?: string;
  createTime: string;
  updateTime: string;
  approvalHistory?: ProcessFileApprovalInfo[];
  sealInfo?: ProcessFileSealInfo;
  currentApprovalLevel?: number;
  nextApproverRole?: string;
}

export interface ProcessFileApprovalInfo {
  id: number;
  fileId: number;
  fileNo: string;
  approvalLevel: number;
  approvalLevelText: string;
  approverId: number;
  approverName: string;
  approverRole: string;
  approvalResult: number;
  approvalResultText: string;
  approvalOpinion?: string;
  approvalTime: string;
}

export interface ProcessFileSealInfo {
  id: number;
  fileId: number;
  fileNo: string;
  sealNo: string;
  sealType: string;
  sealContent?: string;
  sealImagePath: string;
  sealTime: string;
  sealById: number;
  sealByName: string;
}

export interface ProcessFileQueryParams {
  fileNo?: string;
  equipmentNo?: string;
  machineNo?: string;
  fileName?: string;
  status?: number;
  creatorName?: string;
  version?: number;
  isCurrent?: number;
  pageNum?: number;
  pageSize?: number;
}

export interface ProcessFileUploadParams {
  id?: number;
  equipmentId: number;
  file: File;
  changeReason?: string;
  remark?: string;
}

export interface ProcessFileApprovalParams {
  fileId: number;
  approvalResult: number;
  approvalOpinion?: string;
}

/**
 * 分页查询工艺文件列表
 */
export const getProcessFileList = (params: ProcessFileQueryParams) => {
  return request.get('/production/process-file/list', { params });
};

/**
 * 根据ID查询工艺文件详情
 */
export const getProcessFileById = (id: number) => {
  return request.get(`/production/process-file/${id}`);
};

/**
 * 上传工艺文件
 */
export const uploadProcessFile = (params: ProcessFileUploadParams) => {
  const formData = new FormData();
  if (params.id) formData.append('id', params.id.toString());
  formData.append('equipmentId', params.equipmentId.toString());
  formData.append('file', params.file);
  if (params.changeReason) formData.append('changeReason', params.changeReason);
  if (params.remark) formData.append('remark', params.remark);
  
  return request.post('/production/process-file/upload', formData, {
    headers: { 'Content-Type': 'multipart/form-data' },
  });
};

/**
 * 提交审批
 */
export const submitProcessFile = (id: number) => {
  return request.post(`/production/process-file/${id}/submit`);
};

/**
 * 审批工艺文件
 */
export const approveProcessFile = (params: ProcessFileApprovalParams) => {
  return request.post('/production/process-file/approve', params);
};

/**
 * 作废工艺文件
 */
export const invalidateProcessFile = (id: number) => {
  return request.post(`/production/process-file/${id}/invalidate`);
};

/**
 * 下载工艺文件
 */
export const downloadProcessFile = (id: number) => {
  return request.get(`/production/process-file/${id}/download`, {
    responseType: 'blob',
  });
};

/**
 * 查询设备的工艺文件列表
 */
export const getProcessFilesByEquipment = (equipmentId: number, pageNum: number, pageSize: number) => {
  return request.get(`/production/process-file/equipment/${equipmentId}`, {
    params: { pageNum, pageSize },
  });
};

/**
 * 获取待审批的工艺文件列表
 */
export const getPendingApprovalFiles = (pageNum: number, pageSize: number) => {
  return request.get('/production/process-file/pending-approval', {
    params: { pageNum, pageSize },
  });
};
```

### 5.3 核心页面示例

#### ProcessFileList.tsx（工艺文件列表页）

```typescript
import React, { useState, useEffect } from 'react';
import {
  Table,
  Button,
  Form,
  Input,
  Select,
  Space,
  Tag,
  Tooltip,
  Modal,
  message,
} from 'antd';
import {
  PlusOutlined,
  SearchOutlined,
  ReloadOutlined,
  DownloadOutlined,
  EyeOutlined,
  CheckCircleOutlined,
} from '@ant-design/icons';
import {
  ProcessFileInfo,
  ProcessFileQueryParams,
  getProcessFileList,
  downloadProcessFile,
  submitProcessFile,
} from '@/api/processFile';
import './ProcessFileList.less';

const ProcessFileList: React.FC = () => {
  const [form] = Form.useForm();
  const [tableData, setTableData] = useState<ProcessFileInfo[]>([]);
  const [loading, setLoading] = useState(false);
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 10,
    total: 0,
  });

  const statusOptions = [
    { label: '草稿', value: 0 },
    { label: '待车间主任审核', value: 1 },
    { label: '待注塑部经理会签', value: 2 },
    { label: '待生产技术部经理批准', value: 3 },
    { label: '已批准（生效中）', value: 5 },
    { label: '已驳回', value: -1 },
    { label: '已作废', value: -2 },
  ];

  const columns = [
    {
      title: '工艺文件编号',
      dataIndex: 'fileNo',
      key: 'fileNo',
      width: 150,
    },
    {
      title: '设备编号',
      dataIndex: 'equipmentNo',
      key: 'equipmentNo',
      width: 120,
    },
    {
      title: '机台号',
      dataIndex: 'machineNo',
      key: 'machineNo',
      width: 100,
    },
    {
      title: '文件名称',
      dataIndex: 'fileName',
      key: 'fileName',
      width: 200,
      ellipsis: true,
    },
    {
      title: '版本',
      dataIndex: 'versionText',
      key: 'versionText',
      width: 80,
    },
    {
      title: '状态',
      dataIndex: 'status',
      key: 'status',
      width: 150,
      render: (status: number, record: ProcessFileInfo) => {
        const colorMap: { [key: number]: string } = {
          0: 'default',
          1: 'processing',
          2: 'processing',
          3: 'processing',
          5: 'success',
          '-1': 'error',
          '-2': 'default',
        };
        return <Tag color={colorMap[status]}>{record.statusText}</Tag>;
      },
    },
    {
      title: '创建人',
      dataIndex: 'creatorName',
      key: 'creatorName',
      width: 100,
    },
    {
      title: '创建时间',
      dataIndex: 'createTime',
      key: 'createTime',
      width: 160,
    },
    {
      title: '操作',
      key: 'action',
      fixed: 'right' as const,
      width: 200,
      render: (_: any, record: ProcessFileInfo) => (
        <Space size="small">
          <Tooltip title="查看详情">
            <Button
              type="link"
              size="small"
              icon={<EyeOutlined />}
              onClick={() => handleViewDetail(record.id)}
            />
          </Tooltip>
          <Tooltip title="下载">
            <Button
              type="link"
              size="small"
              icon={<DownloadOutlined />}
              onClick={() => handleDownload(record.id, record.fileName)}
            />
          </Tooltip>
          {record.status === 0 && (
            <Tooltip title="提交审批">
              <Button
                type="link"
                size="small"
                icon={<CheckCircleOutlined />}
                onClick={() => handleSubmit(record.id)}
              >
                提交
              </Button>
            </Tooltip>
          )}
        </Space>
      ),
    },
  ];

  const fetchList = async () => {
    setLoading(true);
    try {
      const values = form.getFieldsValue();
      const params: ProcessFileQueryParams = {
        ...values,
        pageNum: pagination.current,
        pageSize: pagination.pageSize,
      };
      const response = await getProcessFileList(params);
      setTableData(response.data.records);
      setPagination({ ...pagination, total: response.data.total });
    } catch (error: any) {
      message.error(error.message || '查询失败');
    } finally {
      setLoading(false);
    }
  };

  const handleSearch = () => {
    setPagination({ ...pagination, current: 1 });
    fetchList();
  };

  const handleReset = () => {
    form.resetFields();
    setPagination({ ...pagination, current: 1 });
    fetchList();
  };

  const handleUpload = () => {
    // 跳转到上传页面
    window.location.href = '/production/process-file/upload';
  };

  const handleViewDetail = (id: number) => {
    // 跳转到详情页面
    window.location.href = `/production/process-file/detail/${id}`;
  };

  const handleDownload = async (id: number, fileName: string) => {
    try {
      const response = await downloadProcessFile(id);
      const blob = new Blob([response.data]);
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      message.success('下载成功');
    } catch (error: any) {
      message.error(error.message || '下载失败');
    }
  };

  const handleSubmit = (id: number) => {
    Modal.confirm({
      title: '确认提交',
      content: '确认提交该工艺文件进行审批吗？提交后将无法修改。',
      onOk: async () => {
        try {
          await submitProcessFile(id);
          message.success('提交成功');
          fetchList();
        } catch (error: any) {
          message.error(error.message || '提交失败');
        }
      },
    });
  };

  useEffect(() => {
    fetchList();
  }, [pagination.current, pagination.pageSize]);

  return (
    <div className="process-file-list">
      <Form form={form} layout="inline" style={{ marginBottom: 16 }}>
        <Form.Item name="fileNo" label="工艺文件编号">
          <Input placeholder="请输入工艺文件编号" allowClear />
        </Form.Item>
        <Form.Item name="equipmentNo" label="设备编号">
          <Input placeholder="请输入设备编号" allowClear />
        </Form.Item>
        <Form.Item name="machineNo" label="机台号">
          <Input placeholder="请输入机台号" allowClear />
        </Form.Item>
        <Form.Item name="fileName" label="文件名称">
          <Input placeholder="请输入文件名称" allowClear />
        </Form.Item>
        <Form.Item name="status" label="状态">
          <Select
            placeholder="请选择状态"
            allowClear
            style={{ width: 180 }}
            options={statusOptions}
          />
        </Form.Item>
        <Form.Item>
          <Space>
            <Button type="primary" icon={<SearchOutlined />} onClick={handleSearch}>
              查询
            </Button>
            <Button icon={<ReloadOutlined />} onClick={handleReset}>
              重置
            </Button>
          </Space>
        </Form.Item>
      </Form>

      <div style={{ marginBottom: 16 }}>
        <Button type="primary" icon={<PlusOutlined />} onClick={handleUpload}>
          上传工艺文件
        </Button>
      </div>

      <Table
        columns={columns}
        dataSource={tableData}
        rowKey="id"
        loading={loading}
        pagination={pagination}
        onChange={(newPagination) => {
          setPagination({
            current: newPagination.current || 1,
            pageSize: newPagination.pageSize || 10,
            total: pagination.total,
          });
        }}
        scroll={{ x: 1400 }}
      />
    </div>
  );
};

export default ProcessFileList;
```

#### ProcessFileUpload.tsx（工艺文件上传页）

```typescript
import React, { useState, useEffect } from 'react';
import {
  Form,
  Upload,
  Select,
  Input,
  Button,
  message,
  Card,
  Row,
  Col,
  Space,
  Alert,
} from 'antd';
import { UploadOutlined, InboxOutlined } from '@ant-design/icons';
import type { UploadFile } from 'antd/es/upload/interface';
import { getEquipmentList } from '@/api/equipment';
import { uploadProcessFile } from '@/api/processFile';
import { useNavigate, useParams } from 'react-router-dom';

const ProcessFileUpload: React.FC = () => {
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  const [equipmentList, setEquipmentList] = useState([]);
  const [fileList, setFileList] = useState<UploadFile[]>([]);
  const navigate = useNavigate();
  const { id } = useParams(); // 修改时传入文件ID

  useEffect(() => {
    fetchEquipmentList();
  }, []);

  const fetchEquipmentList = async () => {
    try {
      const response = await getEquipmentList({ pageNum: 1, pageSize: 1000 });
      setEquipmentList(response.data.records);
    } catch (error: any) {
      message.error('获取设备列表失败');
    }
  };

  const handleSubmit = async () => {
    try {
      const values = await form.validateFields();
      
      if (fileList.length === 0) {
        message.error('请选择要上传的文件');
        return;
      }

      setLoading(true);

      await uploadProcessFile({
        id: id ? Number(id) : undefined,
        equipmentId: values.equipmentId,
        file: fileList[0].originFileObj as File,
        changeReason: values.changeReason,
        remark: values.remark,
      });

      message.success(id ? '修改成功' : '上传成功');
      navigate('/production/process-file');
    } catch (error: any) {
      if (error.errorFields) {
        return;
      }
      message.error(error.message || '操作失败');
    } finally {
      setLoading(false);
    }
  };

  const uploadProps = {
    beforeUpload: (file: File) => {
      // 验证文件类型
      const isExcel = file.name.endsWith('.xls') || file.name.endsWith('.xlsx');
      if (!isExcel) {
        message.error('只支持Excel文件格式（.xls, .xlsx）');
        return false;
      }

      // 验证文件大小（10MB）
      const isLt10M = file.size / 1024 / 1024 < 10;
      if (!isLt10M) {
        message.error('文件大小不能超过10MB');
        return false;
      }

      setFileList([{
        uid: file.uid,
        name: file.name,
        status: 'done',
        originFileObj: file,
      }]);
      
      return false; // 阻止自动上传
    },
    fileList,
    onRemove: () => {
      setFileList([]);
    },
    maxCount: 1,
  };

  return (
    <div className="process-file-upload">
      <Card title={id ? '修改工艺文件' : '上传工艺文件'}>
        <Alert
          message="温馨提示"
          description={
            <ul style={{ marginBottom: 0, paddingLeft: 20 }}>
              <li>每台设备至少需要配置4个工艺文件</li>
              <li>仅支持Excel文件格式（.xls, .xlsx）</li>
              <li>文件大小不超过10MB</li>
              <li>上传后需要提交审批流程</li>
              {id && <li>修改工艺文件必须填写变更原因</li>}
            </ul>
          }
          type="info"
          showIcon
          style={{ marginBottom: 24 }}
        />

        <Form
          form={form}
          layout="vertical"
          initialValues={{ status: 1 }}
        >
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="equipmentId"
                label="选择设备"
                rules={[{ required: true, message: '请选择设备' }]}
              >
                <Select
                  showSearch
                  placeholder="请选择设备"
                  optionFilterProp="children"
                  filterOption={(input, option) =>
                    (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                  }
                  options={equipmentList.map((eq: any) => ({
                    label: `${eq.equipmentNo} - ${eq.equipmentName} (${eq.machineNo})`,
                    value: eq.id,
                  }))}
                />
              </Form.Item>
            </Col>
            
            {id && (
              <Col span={12}>
                <Form.Item
                  name="changeReason"
                  label="变更原因"
                  rules={[{ required: true, message: '请填写变更原因' }]}
                >
                  <Input.TextArea
                    rows={4}
                    placeholder="请详细说明本次变更的原因和内容"
                    maxLength={500}
                    showCount
                  />
                </Form.Item>
              </Col>
            )}
          </Row>

          <Form.Item
            label="上传工艺文件"
            required
            tooltip="支持.xls和.xlsx格式，文件大小不超过10MB"
          >
            <Upload.Dragger {...uploadProps}>
              <p className="ant-upload-drag-icon">
                <InboxOutlined />
              </p>
              <p className="ant-upload-text">点击或拖拽文件到此区域上传</p>
              <p className="ant-upload-hint">
                支持Excel文件格式（.xls, .xlsx），单个文件不超过10MB
              </p>
            </Upload.Dragger>
          </Form.Item>

          <Form.Item name="remark" label="备注">
            <Input.TextArea
              rows={3}
              placeholder="请输入备注信息（可选）"
              maxLength={1000}
              showCount
            />
          </Form.Item>

          <Form.Item>
            <Space>
              <Button type="primary" onClick={handleSubmit} loading={loading}>
                {id ? '保存修改' : '上传'}
              </Button>
              <Button onClick={() => navigate('/production/process-file')}>
                取消
              </Button>
            </Space>
          </Form.Item>
        </Form>
      </Card>
    </div>
  );
};

export default ProcessFileUpload;
```

#### ProcessFileDetail.tsx（工艺文件详情页）

```typescript
import React, { useState, useEffect } from 'react';
import {
  Card,
  Descriptions,
  Button,
  Space,
  Tag,
  Timeline,
  Modal,
  Form,
  Input,
  Radio,
  message,
  Table,
  Image,
} from 'antd';
import {
  DownloadOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  HistoryOutlined,
} from '@ant-design/icons';
import { useParams, useNavigate } from 'react-router-dom';
import {
  getProcessFileById,
  downloadProcessFile,
  approveProcessFile,
} from '@/api/processFile';
import type { ProcessFileInfo, ProcessFileApprovalInfo } from '@/api/processFile';

const ProcessFileDetail: React.FC = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const [form] = Form.useForm();
  const [fileDetail, setFileDetail] = useState<ProcessFileInfo | null>(null);
  const [loading, setLoading] = useState(false);
  const [approvalModalVisible, setApprovalModalVisible] = useState(false);
  const [historyModalVisible, setHistoryModalVisible] = useState(false);

  useEffect(() => {
    if (id) {
      fetchDetail();
    }
  }, [id]);

  const fetchDetail = async () => {
    setLoading(true);
    try {
      const response = await getProcessFileById(Number(id));
      setFileDetail(response.data);
    } catch (error: any) {
      message.error('加载详情失败');
    } finally {
      setLoading(false);
    }
  };

  const handleDownload = async () => {
    if (!fileDetail) return;
    
    try {
      const response = await downloadProcessFile(fileDetail.id);
      const blob = new Blob([response.data]);
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileDetail.fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      message.success('下载成功');
    } catch (error: any) {
      message.error('下载失败');
    }
  };

  const handleApprove = async () => {
    try {
      const values = await form.validateFields();
      
      if (values.approvalResult === 0 && !values.approvalOpinion) {
        message.error('驳回时必须填写审批意见');
        return;
      }

      await approveProcessFile({
        fileId: fileDetail!.id,
        approvalResult: values.approvalResult,
        approvalOpinion: values.approvalOpinion,
      });

      message.success(values.approvalResult === 1 ? '审批通过' : '已驳回');
      setApprovalModalVisible(false);
      fetchDetail();
    } catch (error: any) {
      message.error(error.message || '审批失败');
    }
  };

  const getStatusTag = (status: number) => {
    const statusConfig: { [key: number]: { color: string; text: string } } = {
      0: { color: 'default', text: '草稿' },
      1: { color: 'processing', text: '待车间主任审核' },
      2: { color: 'processing', text: '待注塑部经理会签' },
      3: { color: 'processing', text: '待生产技术部经理批准' },
      5: { color: 'success', text: '已批准（生效中）' },
      '-1': { color: 'error', text: '已驳回' },
      '-2': { color: 'default', text: '已作废' },
    };
    const config = statusConfig[status] || { color: 'default', text: '未知' };
    return <Tag color={config.color}>{config.text}</Tag>;
  };

  if (!fileDetail) {
    return <Card loading={loading}>加载中...</Card>;
  }

  return (
    <div className="process-file-detail">
      <Card
        title="工艺文件详情"
        extra={
          <Space>
            <Button icon={<DownloadOutlined />} onClick={handleDownload}>
              下载文件
            </Button>
            {[1, 2, 3].includes(fileDetail.status) && (
              <Button
                type="primary"
                icon={<CheckCircleOutlined />}
                onClick={() => setApprovalModalVisible(true)}
              >
                审批
              </Button>
            )}
            <Button onClick={() => navigate('/production/process-file')}>
              返回列表
            </Button>
          </Space>
        }
      >
        <Descriptions bordered column={2}>
          <Descriptions.Item label="工艺文件编号">
            {fileDetail.fileNo}
          </Descriptions.Item>
          <Descriptions.Item label="状态">
            {getStatusTag(fileDetail.status)}
          </Descriptions.Item>
          <Descriptions.Item label="设备编号">
            {fileDetail.equipmentNo}
          </Descriptions.Item>
          <Descriptions.Item label="机台号">
            {fileDetail.machineNo}
          </Descriptions.Item>
          <Descriptions.Item label="文件名称" span={2}>
            {fileDetail.fileName}
          </Descriptions.Item>
          <Descriptions.Item label="文件大小">
            {fileDetail.fileSizeText}
          </Descriptions.Item>
          <Descriptions.Item label="版本">
            {fileDetail.versionText}
          </Descriptions.Item>
          <Descriptions.Item label="创建人">
            {fileDetail.creatorName}
          </Descriptions.Item>
          <Descriptions.Item label="创建时间">
            {fileDetail.createTime}
          </Descriptions.Item>
          {fileDetail.submitTime && (
            <Descriptions.Item label="提交时间">
              {fileDetail.submitTime}
            </Descriptions.Item>
          )}
          {fileDetail.approvalTime && (
            <Descriptions.Item label="批准时间">
              {fileDetail.approvalTime}
            </Descriptions.Item>
          )}
          {fileDetail.effectiveTime && (
            <Descriptions.Item label="生效时间">
              {fileDetail.effectiveTime}
            </Descriptions.Item>
          )}
          {fileDetail.changeReason && (
            <Descriptions.Item label="变更原因" span={2}>
              {fileDetail.changeReason}
            </Descriptions.Item>
          )}
          {fileDetail.remark && (
            <Descriptions.Item label="备注" span={2}>
              {fileDetail.remark}
            </Descriptions.Item>
          )}
        </Descriptions>

        {fileDetail.sealInfo && (
          <Card
            title="电子受控章信息"
            size="small"
            style={{ marginTop: 16 }}
          >
            <Row gutter={16}>
              <Col span={12}>
                <Descriptions column={1} size="small">
                  <Descriptions.Item label="印章编号">
                    {fileDetail.sealInfo.sealNo}
                  </Descriptions.Item>
                  <Descriptions.Item label="盖章人">
                    {fileDetail.sealInfo.sealByName}
                  </Descriptions.Item>
                  <Descriptions.Item label="盖章时间">
                    {fileDetail.sealInfo.sealTime}
                  </Descriptions.Item>
                </Descriptions>
              </Col>
              <Col span={12}>
                {fileDetail.sealInfo.sealImagePath && (
                  <Image
                    src={fileDetail.sealInfo.sealImagePath}
                    alt="电子受控章"
                    width={150}
                  />
                )}
              </Col>
            </Row>
          </Card>
        )}

        {fileDetail.approvalHistory && fileDetail.approvalHistory.length > 0 && (
          <Card title="审批历史" size="small" style={{ marginTop: 16 }}>
            <Timeline>
              {fileDetail.approvalHistory.map((record: ProcessFileApprovalInfo) => (
                <Timeline.Item
                  key={record.id}
                  color={record.approvalResult === 1 ? 'green' : 'red'}
                >
                  <div>
                    <strong>{record.approvalLevelText}</strong>
                    <Tag
                      color={record.approvalResult === 1 ? 'success' : 'error'}
                      style={{ marginLeft: 8 }}
                    >
                      {record.approvalResultText}
                    </Tag>
                  </div>
                  <div style={{ color: '#666', fontSize: 12 }}>
                    审批人：{record.approverName} ({record.approverRole})
                  </div>
                  {record.approvalOpinion && (
                    <div style={{ color: '#666', fontSize: 12 }}>
                      审批意见：{record.approvalOpinion}
                    </div>
                  )}
                  <div style={{ color: '#999', fontSize: 12 }}>
                    {record.approvalTime}
                  </div>
                </Timeline.Item>
              ))}
            </Timeline>
          </Card>
        )}
      </Card>

      {/* 审批弹窗 */}
      <Modal
        title="审批工艺文件"
        open={approvalModalVisible}
        onOk={handleApprove}
        onCancel={() => setApprovalModalVisible(false)}
        width={600}
      >
        <Form form={form} layout="vertical">
          <Form.Item
            name="approvalResult"
            label="审批结果"
            rules={[{ required: true, message: '请选择审批结果' }]}
            initialValue={1}
          >
            <Radio.Group>
              <Radio value={1}>通过</Radio>
              <Radio value={0}>驳回</Radio>
            </Radio.Group>
          </Form.Item>

          <Form.Item
            name="approvalOpinion"
            label="审批意见"
            rules={[
              {
                validator: async (_, value) => {
                  const result = form.getFieldValue('approvalResult');
                  if (result === 0 && !value) {
                    throw new Error('驳回时必须填写审批意见');
                  }
                },
              },
            ]}
          >
            <Input.TextArea
              rows={4}
              placeholder="请输入审批意见（驳回时必填）"
              maxLength={500}
              showCount
            />
          </Form.Item>
        </Form>
      </Modal>
    </div>
  );
};

export default ProcessFileDetail;
```

#### PendingApprovalList.tsx（待审批列表页）

```typescript
import React, { useState, useEffect } from 'react';
import { Table, Button, Tag, Space, message, Modal } from 'antd';
import { EyeOutlined } from '@ant-design/icons';
import { useNavigate } from 'react-router-dom';
import { getPendingApprovalFiles } from '@/api/processFile';
import type { ProcessFileInfo } from '@/api/processFile';

const PendingApprovalList: React.FC = () => {
  const navigate = useNavigate();
  const [tableData, setTableData] = useState<ProcessFileInfo[]>([]);
  const [loading, setLoading] = useState(false);
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 10,
    total: 0,
  });

  useEffect(() => {
    fetchList();
  }, [pagination.current, pagination.pageSize]);

  const fetchList = async () => {
    setLoading(true);
    try {
      const response = await getPendingApprovalFiles(
        pagination.current,
        pagination.pageSize
      );
      setTableData(response.data.records);
      setPagination({ ...pagination, total: response.data.total });
    } catch (error: any) {
      message.error('查询失败');
    } finally {
      setLoading(false);
    }
  };

  const columns = [
    {
      title: '工艺文件编号',
      dataIndex: 'fileNo',
      key: 'fileNo',
      width: 150,
    },
    {
      title: '设备编号',
      dataIndex: 'equipmentNo',
      key: 'equipmentNo',
      width: 120,
    },
    {
      title: '机台号',
      dataIndex: 'machineNo',
      key: 'machineNo',
      width: 100,
    },
    {
      title: '文件名称',
      dataIndex: 'fileName',
      key: 'fileName',
      width: 200,
      ellipsis: true,
    },
    {
      title: '版本',
      dataIndex: 'versionText',
      key: 'versionText',
      width: 80,
    },
    {
      title: '当前状态',
      dataIndex: 'statusText',
      key: 'statusText',
      width: 150,
      render: (text: string) => <Tag color="processing">{text}</Tag>,
    },
    {
      title: '创建人',
      dataIndex: 'creatorName',
      key: 'creatorName',
      width: 100,
    },
    {
      title: '提交时间',
      dataIndex: 'submitTime',
      key: 'submitTime',
      width: 160,
    },
    {
      title: '操作',
      key: 'action',
      fixed: 'right' as const,
      width: 120,
      render: (_: any, record: ProcessFileInfo) => (
        <Space size="small">
          <Button
            type="link"
            size="small"
            icon={<EyeOutlined />}
            onClick={() => navigate(`/production/process-file/detail/${record.id}`)}
          >
            审批
          </Button>
        </Space>
      ),
    },
  ];

  return (
    <div className="pending-approval-list">
      <Card title="待我审批">
        <Table
          columns={columns}
          dataSource={tableData}
          rowKey="id"
          loading={loading}
          pagination={pagination}
          onChange={(newPagination) => {
            setPagination({
              current: newPagination.current || 1,
              pageSize: newPagination.pageSize || 10,
              total: pagination.total,
            });
          }}
          scroll={{ x: 1200 }}
        />
      </Card>
    </div>
  );
};

export default PendingApprovalList;
```

### 5.4 路由配置

#### App.tsx（添加路由）

```typescript
import ProcessFileList from '@/pages/Production/ProcessFile/ProcessFileList';
import ProcessFileUpload from '@/pages/Production/ProcessFile/ProcessFileUpload';
import ProcessFileDetail from '@/pages/Production/ProcessFile/ProcessFileDetail';
import PendingApprovalList from '@/pages/Production/ProcessFile/PendingApprovalList';

// 在路由配置中添加
<Route path="production">
  <Route path="process-file">
    <Route index element={<ProcessFileList />} />
    <Route path="upload" element={<ProcessFileUpload />} />
    <Route path="upload/:id" element={<ProcessFileUpload />} />
    <Route path="detail/:id" element={<ProcessFileDetail />} />
    <Route path="pending-approval" element={<PendingApprovalList />} />
  </Route>
</Route>
```

#### 菜单配置（Layout.tsx）

```typescript
// 在生产管理菜单下添加子菜单
{
  key: '/production',
  icon: <AppstoreOutlined />,
  label: '生产管理',
  children: [
    {
      key: '/production/order',
      label: '生产订单',
    },
    {
      key: '/production/plan',
      label: '生产计划',
    },
    {
      key: '/production/record',
      label: '生产记录',
    },
    {
      key: '/production/process-file',
      label: '工艺文件',
    },
    {
      key: '/production/pending-approval',
      label: '待我审批',
    },
  ],
}
```

### 5.5 工具函数

#### fileUtils.ts

```typescript
/**
 * 格式化文件大小
 */
export const formatFileSize = (bytes: number): string => {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
};

/**
 * 格式化版本号
 */
export const formatVersion = (version: number): string => {
  return `V${version}.0`;
};

/**
 * 验证Excel文件
 */
export const validateExcelFile = (file: File): boolean => {
  const isExcel = file.name.endsWith('.xls') || file.name.endsWith('.xlsx');
  if (!isExcel) {
    message.error('只支持Excel文件格式');
    return false;
  }

  const isLt10M = file.size / 1024 / 1024 < 10;
  if (!isLt10M) {
    message.error('文件大小不能超过10MB');
    return false;
  }

  return true;
};

/**
 * 下载文件
 */
export const downloadFile = (blob: Blob, filename: string) => {
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  window.URL.revokeObjectURL(url);
};
```

## 6. 核心功能实现要点

### 6.1 文件上传处理

- 限制文件类型为 Excel（.xls, .xlsx）
- 限制文件大小（建议不超过 10MB）
- 生成唯一的文件编号（格式：PF + 年月日 + 序号）
- 文件存储路径：`/uploads/process-files/{year}/{month}/{fileNo}.{ext}`
- 记录文件元数据（大小、类型、版本等）

### 6.2 审批流程控制

- 状态流转：草稿(0) → 待车间主任审核(1) → 待注塑部经理会签(2) → 待生产技术部经理批准(3) → 已批准(5)
- 驳回后退回到草稿状态，允许修改后重新提交
- 每个审批环节记录审批人、审批时间、审批意见
- 审批权限验证：只有对应角色的用户才能进行审批
- 三级审批流程，确保工艺文件质量和规范性

### 6.3 版本管理

- 版本号从 1 开始递增
- 修改时创建新版本，关联原文件（parent_file_id）
- 标记当前版本（is_current = 1），历史版本设为 0
- 保留所有历史版本，支持查看和下载

### 6.4 电子受控章

- 审批通过后自动生成电子受控章
- 受控章包含：印章编号、印章类型、盖章时间、盖章人等信息
- 生成受控章图片（可使用图片处理库生成）
- 将受控章叠加到 Excel 文件上（可在前端展示时叠加）

### 6.5 权限控制

| 角色 | 权限 |
|------|------|
| 注塑组长 | 创建、上传、修改、提交、查看 |
| 车间主任 | 第一级审核、查看 |
| 注塑部经理 | 第二级会签、查看 |
| 生产技术部经理 | 第三级最终批准、盖章、作废、查看 |
| 其他人员 | 查看已批准的工艺文件 |

### 6.6 工艺文件编号生成规则

#### 编号格式
```
PF + 年月日(8位) + 序号(3位)
示例：PF20260124001
```

#### 生成逻辑
```java
private String generateFileNo() {
    String prefix = "PF" + LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
    
    // 查询当天最大序号（处理并发）
    synchronized (this) {
        String maxFileNo = processFileMapper.getMaxFileNoByPrefix(prefix);
        int sequence = 1;
        if (maxFileNo != null && maxFileNo.length() > prefix.length()) {
            try {
                sequence = Integer.parseInt(maxFileNo.substring(prefix.length())) + 1;
            } catch (NumberFormatException e) {
                sequence = 1;
            }
        }
        return prefix + String.format("%03d", sequence);
    }
}
```

### 6.7 文件存储策略

#### 目录结构
```
/data/uploads/process-files/
├── 2026/
│   ├── 01/
│   │   ├── PF20260101001.xlsx
│   │   ├── PF20260101002.xlsx
│   │   └── ...
│   ├── 02/
│   └── ...
└── 2025/
    └── ...
```

#### 存储规范
- 按年月分目录存储，便于管理和备份
- 文件名使用文件编号，避免重名冲突
- 保留原始扩展名，便于识别文件类型
- 定期清理无效文件，释放存储空间
- 建议使用对象存储服务（如阿里云OSS）实现高可用

### 6.8 电子受控章实现方案

#### 方案一：图片水印（推荐）

```java
import javax.imageio.ImageIO;
import java.awt.*;
import java.awt.image.BufferedImage;
import java.io.File;

public class SealGenerator {
    /**
     * 生成电子受控章图片
     */
    public static String generateSealImage(String fileNo, LocalDateTime approvalTime, String sealPath) {
        try {
            // 创建图片
            int width = 200;
            int height = 200;
            BufferedImage image = new BufferedImage(width, height, BufferedImage.TYPE_INT_ARGB);
            Graphics2D g2d = image.createGraphics();
            
            // 抗锯齿
            g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
            
            // 绘制圆形边框（红色）
            g2d.setColor(Color.RED);
            g2d.setStroke(new BasicStroke(3));
            g2d.drawOval(10, 10, 180, 180);
            
            // 绘制内圈
            g2d.drawOval(20, 20, 160, 160);
            
            // 绘制五角星（可选）
            g2d.fillPolygon(
                new int[]{100, 110, 130, 115, 120, 100, 80, 85, 70, 90},
                new int[]{40, 70, 70, 85, 110, 95, 110, 85, 70, 70},
                10
            );
            
            // 绘制文字
            g2d.setFont(new Font("宋体", Font.BOLD, 16));
            g2d.drawString("受控文件", 70, 120);
            
            g2d.setFont(new Font("Arial", Font.PLAIN, 12));
            g2d.drawString(fileNo, 45, 145);
            
            String dateStr = approvalTime.format(DateTimeFormatter.ofPattern("yyyy-MM-dd"));
            g2d.drawString(dateStr, 50, 165);
            
            g2d.dispose();
            
            // 保存图片
            String filename = fileNo + "_seal.png";
            File sealFile = new File(sealPath, filename);
            ImageIO.write(image, "PNG", sealFile);
            
            return sealFile.getAbsolutePath();
        } catch (Exception e) {
            throw new RuntimeException("生成受控章失败", e);
        }
    }
}
```

#### 方案二：PDF水印

- 将Excel转换为PDF
- 使用Apache PDFBox添加水印
- 水印包含受控章、文件编号、批准日期等信息
- 优点：防篡改，适合打印

#### 方案三：Excel元数据

- 在Excel文件的自定义属性中写入受控信息
- 包括：文件编号、批准时间、批准人等
- 优点：不影响文件内容展示
- 缺点：容易被删除

### 6.9 通知提醒实现方案

#### 站内消息

```java
@Autowired
private MessageService messageService;

// 发送审批提醒
public void sendApprovalReminder(ProcessFile file, String targetRole) {
    // 查询目标角色的用户列表
    List<SysUser> users = userService.getUsersByRole(targetRole);
    
    for (SysUser user : users) {
        Message message = new Message();
        message.setUserId(user.getId());
        message.setTitle("待审批提醒");
        message.setContent("您有新的工艺文件需要审批：" + file.getFileNo());
        message.setType("approval");
        message.setRelatedId(file.getId());
        messageService.sendMessage(message);
    }
}
```

#### 邮件提醒

```java
@Autowired
private JavaMailSender mailSender;

public void sendEmailReminder(String email, ProcessFile file) {
    SimpleMailMessage message = new SimpleMailMessage();
    message.setTo(email);
    message.setSubject("工艺文件审批提醒");
    message.setText(String.format(
        "您有新的工艺文件需要审批：\n\n" +
        "文件编号：%s\n" +
        "设备编号：%s\n" +
        "文件名称：%s\n" +
        "提交时间：%s\n\n" +
        "请及时登录系统处理。",
        file.getFileNo(),
        file.getEquipmentNo(),
        file.getFileName(),
        file.getSubmitTime()
    ));
    mailSender.send(message);
}
```

### 6.10 最佳实践建议

#### 文件命名规范
- 建议格式：`设备编号_产品名称_工艺参数_日期.xlsx`
- 示例：`EQ001_产品A_注塑参数_20260124.xlsx`
- 避免使用特殊字符：`/ \ : * ? " < > |`
- 文件名长度控制在50个字符以内

#### 工艺文件内容规范
- 第一个工作表：基本工艺参数
- 第二个工作表：质量控制标准
- 第三个工作表：异常处理流程
- 第四个工作表：变更记录

#### 审批时效要求
- 车间主任审核：1个工作日内
- 注塑部经理会签：1个工作日内
- 生产技术部经理批准：1个工作日内
- 总时效：3个工作日内完成

#### 版本管理规范
- 主版本号：重大变更（如工艺参数大幅调整）
- 次版本号：一般变更（如参数微调）
- 建议版本号格式：V1.0, V1.1, V2.0
- 每个版本都应有详细的变更说明

## 7. 开发注意事项

### 7.1 文件存储

#### 存储方案选择

| 方案 | 优点 | 缺点 | 适用场景 |
|-----|------|------|---------|
| 本地文件系统 | 简单、成本低、速度快 | 扩展性差、备份困难 | 小规模、单机部署 |
| NFS网络存储 | 多服务器共享、统一管理 | 性能较差、单点故障 | 中小规模、集群部署 |
| 对象存储（OSS） | 高可用、易扩展、自动备份 | 成本较高、依赖网络 | 大规模、分布式部署 |
| 数据库存储 | 事务一致性强 | 性能差、存储成本高 | 小文件、对一致性要求高 |

**推荐方案**：阿里云OSS或MinIO（私有化部署）

#### 存储实现（OSS示例）

```java
@Autowired
private OSS ossClient;

@Value("${aliyun.oss.bucket-name}")
private String bucketName;

private String saveFileToOSS(MultipartFile file, String fileNo) throws IOException {
    String year = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy"));
    String month = LocalDateTime.now().format(DateTimeFormatter.ofPattern("MM"));
    String extension = getFileExtension(file.getOriginalFilename());
    String objectName = "process-files/" + year + "/" + month + "/" + fileNo + "." + extension;
    
    ossClient.putObject(bucketName, objectName, file.getInputStream());
    
    return objectName;
}
```

### 7.2 并发控制

#### 乐观锁实现

```java
// Entity中添加version字段
@Version
private Integer lockVersion;

// Service实现
@Override
@Transactional
public void approveProcessFile(ProcessFileApprovalDTO approvalDTO, Long currentUserId, 
                               String currentUserName, String currentUserRole) {
    ProcessFile processFile = processFileMapper.selectById(approvalDTO.getFileId());
    if (processFile == null) {
        throw new RuntimeException("工艺文件不存在");
    }
    
    // MyBatis-Plus会自动处理乐观锁
    // 如果版本号不匹配，更新会失败
    int result = processFileMapper.updateById(processFile);
    if (result == 0) {
        throw new RuntimeException("该文件已被其他用户修改，请刷新后重试");
    }
}
```

#### 分布式锁实现（Redis）

```java
@Autowired
private RedisTemplate<String, String> redisTemplate;

public void approveWithLock(Long fileId, ApprovalDTO dto) {
    String lockKey = "process_file_approval:" + fileId;
    String lockValue = UUID.randomUUID().toString();
    
    try {
        // 获取锁（5秒超时）
        Boolean locked = redisTemplate.opsForValue()
            .setIfAbsent(lockKey, lockValue, 5, TimeUnit.SECONDS);
        
        if (Boolean.TRUE.equals(locked)) {
            // 执行审批逻辑
            doApproval(fileId, dto);
        } else {
            throw new RuntimeException("系统繁忙，请稍后重试");
        }
    } finally {
        // 释放锁
        String currentValue = redisTemplate.opsForValue().get(lockKey);
        if (lockValue.equals(currentValue)) {
            redisTemplate.delete(lockKey);
        }
    }
}
```

### 7.3 安全性

#### 文件类型验证

```java
import org.apache.tika.Tika;

private void validateFileType(MultipartFile file) throws IOException {
    Tika tika = new Tika();
    String mimeType = tika.detect(file.getInputStream());
    
    // 真实的Excel文件MIME类型
    List<String> allowedTypes = Arrays.asList(
        "application/vnd.ms-excel",  // .xls
        "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"  // .xlsx
    );
    
    if (!allowedTypes.contains(mimeType)) {
        throw new RuntimeException("文件格式不正确，仅支持Excel文件");
    }
}
```

#### 文件病毒扫描（ClamAV）

```java
import fi.solita.clamav.ClamAVClient;

@Autowired
private ClamAVClient clamAVClient;

private void scanVirus(MultipartFile file) throws IOException {
    byte[] reply = clamAVClient.scan(file.getInputStream());
    
    if (!ClamAVClient.isCleanReply(reply)) {
        throw new RuntimeException("文件包含病毒，上传被拒绝");
    }
}
```

#### 文件下载权限验证

```java
@Override
public byte[] downloadProcessFile(Long fileId, Long currentUserId, String currentUserRole) throws IOException {
    ProcessFile file = processFileMapper.selectById(fileId);
    if (file == null) {
        throw new RuntimeException("文件不存在");
    }
    
    // 权限验证
    if (file.getStatus() != 5) {  // 未批准的文件
        // 只有创建人和审批人可以下载
        if (!file.getCreatorId().equals(currentUserId) && !isApprover(currentUserRole)) {
            throw new RuntimeException("您没有权限下载该文件");
        }
    }
    
    // 记录下载日志
    logFileOperation(fileId, currentUserId, "download");
    
    // 读取文件
    Path path = Paths.get(file.getFilePath());
    return Files.readAllBytes(path);
}
```

#### 操作日志记录

```java
@Aspect
@Component
public class ProcessFileOperationLog {
    
    @Autowired
    private OperationLogMapper logMapper;
    
    @AfterReturning("execution(* com.zssystem.service.ProcessFileService.*(..))")
    public void logOperation(JoinPoint joinPoint) {
        String methodName = joinPoint.getSignature().getName();
        Object[] args = joinPoint.getArgs();
        
        OperationLog log = new OperationLog();
        log.setModule("工艺文件管理");
        log.setOperation(methodName);
        log.setParams(JSON.toJSONString(args));
        log.setOperationTime(LocalDateTime.now());
        // TODO: 获取当前用户信息
        
        logMapper.insert(log);
    }
}
```

### 7.4 性能优化

#### 文件分片上传（前端）

```typescript
import SparkMD5 from 'spark-md5';

/**
 * 大文件分片上传
 */
export const uploadLargeFile = async (file: File, equipmentId: number) => {
  const chunkSize = 2 * 1024 * 1024; // 2MB per chunk
  const chunks = Math.ceil(file.size / chunkSize);
  
  // 计算文件MD5
  const md5 = await calculateFileMD5(file);
  
  // 分片上传
  for (let i = 0; i < chunks; i++) {
    const start = i * chunkSize;
    const end = Math.min(start + chunkSize, file.size);
    const chunk = file.slice(start, end);
    
    const formData = new FormData();
    formData.append('chunk', chunk);
    formData.append('chunkIndex', i.toString());
    formData.append('totalChunks', chunks.toString());
    formData.append('fileMd5', md5);
    formData.append('equipmentId', equipmentId.toString());
    
    await request.post('/production/process-file/upload-chunk', formData);
  }
  
  // 合并分片
  await request.post('/production/process-file/merge-chunks', { fileMd5: md5, equipmentId });
};

const calculateFileMD5 = (file: File): Promise<string> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    const spark = new SparkMD5.ArrayBuffer();
    
    reader.onload = (e) => {
      spark.append(e.target?.result as ArrayBuffer);
      resolve(spark.end());
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
};
```

#### 查询性能优化

```java
// 使用MyBatis-Plus的分页优化
@Override
public IPage<ProcessFileVO> getProcessFileList(ProcessFileQueryDTO queryDTO) {
    Page<ProcessFile> page = new Page<>(queryDTO.getPageNum(), queryDTO.getPageSize());
    
    // 只查询必要字段，避免查询大字段（如文件路径等）
    LambdaQueryWrapper<ProcessFile> wrapper = new LambdaQueryWrapper<>();
    wrapper.select(ProcessFile::getId, ProcessFile::getFileNo, ProcessFile::getEquipmentNo,
                  ProcessFile::getMachineNo, ProcessFile::getFileName, ProcessFile::getStatus,
                  ProcessFile::getVersion, ProcessFile::getCreatorName, ProcessFile::getCreateTime)
           .like(queryDTO.getFileNo() != null, ProcessFile::getFileNo, queryDTO.getFileNo())
           .like(queryDTO.getEquipmentNo() != null, ProcessFile::getEquipmentNo, queryDTO.getEquipmentNo())
           .eq(queryDTO.getStatus() != null, ProcessFile::getStatus, queryDTO.getStatus())
           .orderByDesc(ProcessFile::getCreateTime);
    
    IPage<ProcessFile> filePage = processFileMapper.selectPage(page, wrapper);
    return filePage.convert(this::convertToVO);
}
```

#### 缓存优化（Redis）

```java
@Cacheable(value = "processFile", key = "#id")
public ProcessFileVO getProcessFileById(Long id) {
    ProcessFile file = processFileMapper.selectById(id);
    if (file == null) {
        throw new RuntimeException("工艺文件不存在");
    }
    return convertToVO(file);
}

@CacheEvict(value = "processFile", key = "#fileId")
public void approveProcessFile(Long fileId, ApprovalDTO dto) {
    // 审批逻辑...
}
```

## 8. 测试用例

### 8.1 功能测试

#### 8.1.1 文件上传测试

| 测试场景 | 测试步骤 | 预期结果 |
|---------|---------|---------|
| 上传正确格式文件 | 选择.xlsx文件，填写信息，点击上传 | 上传成功，生成文件编号，状态为草稿 |
| 上传.xls格式文件 | 选择.xls文件上传 | 上传成功 |
| 上传非Excel文件 | 选择.pdf文件上传 | 提示"只支持Excel文件格式" |
| 上传超大文件 | 选择11MB的文件上传 | 提示"文件大小超过限制：10MB" |
| 未选择设备上传 | 不选择设备，直接上传文件 | 提示"设备ID不能为空" |
| 文件名包含特殊字符 | 上传文件名为"工艺@#%.xlsx"的文件 | 上传成功，文件正常保存 |
| 文件名包含中文 | 上传文件名为"注塑工艺参数.xlsx"的文件 | 上传成功，文件正常保存 |

#### 8.1.2 审批流程测试

| 测试场景 | 测试步骤 | 预期结果 |
|---------|---------|---------|
| 完整审批流程 | 提交→车间主任审核通过→注塑部经理会签通过→生产技术部经理批准通过 | 状态变为"已批准"，自动生成电子受控章 |
| 第一级驳回 | 车间主任审核驳回 | 状态变为"已驳回"，可重新编辑 |
| 第二级驳回 | 注塑部经理会签驳回 | 状态变为"已驳回"，可重新编辑 |
| 第三级驳回 | 生产技术部经理批准驳回 | 状态变为"已驳回"，可重新编辑 |
| 驳回后重新提交 | 修改后重新提交审批 | 重新走完整审批流程 |
| 未提交直接审批 | 草稿状态直接访问审批接口 | 提示"只有草稿状态才能提交审批" |
| 重复审批 | 同一审批人对同一文件审批两次 | 第二次提示"该文件已审批" |
| 越级审批 | 车间主任角色审批第二级 | 提示"您没有权限进行此审批操作" |

#### 8.1.3 版本管理测试

| 测试场景 | 测试步骤 | 预期结果 |
|---------|---------|---------|
| 修改生成新版本 | 修改已批准的文件，填写变更原因，提交 | 生成V2.0版本，原文件标记为历史版本 |
| 未填写变更原因修改 | 修改文件时不填写变更原因 | 提示"修改工艺文件必须填写变更原因" |
| 查看历史版本 | 点击"查看历史版本"按钮 | 显示所有历史版本列表 |
| 下载历史版本 | 点击历史版本的"下载"按钮 | 下载对应版本的文件 |
| 版本号递增 | 连续修改3次 | 版本号依次为V1.0、V2.0、V3.0、V4.0 |
| 只有当前版本可修改 | 尝试修改历史版本 | 提示"只能修改当前版本" |

#### 8.1.4 权限控制测试

| 测试场景 | 测试步骤 | 预期结果 |
|---------|---------|---------|
| 注塑组长上传文件 | 注塑组长登录，上传文件 | 上传成功 |
| 普通员工上传文件 | 普通员工登录，尝试上传文件 | 提示"您没有权限上传工艺文件" |
| 车间主任审核 | 车间主任登录，审核文件 | 审核成功 |
| 注塑部经理会签 | 注塑部经理登录，会签文件 | 会签成功 |
| 生产技术部经理批准 | 生产技术部经理登录，批准文件 | 批准成功，自动盖章 |
| 非创建人提交审批 | 其他用户尝试提交别人的草稿 | 提示"只有创建人才能提交审批" |
| 查看已批准文件 | 所有用户都可以查看已批准的文件 | 查看成功 |
| 作废文件权限 | 注塑组长或部门经理作废文件 | 作废成功 |

#### 8.1.5 电子受控章测试

| 测试场景 | 测试步骤 | 预期结果 |
|---------|---------|---------|
| 自动生成受控章 | 完成所有审批流程 | 自动生成受控章，包含印章编号、日期等信息 |
| 受控章信息查看 | 查看已批准文件的受控章信息 | 显示盖章人、盖章时间、印章编号等 |
| 受控章图片下载 | 下载带受控章的文件 | 文件包含受控章水印或标识 |

### 8.2 边界测试

#### 8.2.1 数据边界测试

| 测试场景 | 测试数据 | 预期结果 |
|---------|---------|---------|
| 文件大小为0 | 上传0KB的文件 | 提示"文件不能为空" |
| 文件大小为10MB | 上传10MB的文件 | 上传成功 |
| 文件大小为10MB+1字节 | 上传10485761字节的文件 | 提示"文件大小超过限制" |
| 文件名长度为1 | 文件名"a.xlsx" | 上传成功 |
| 文件名长度为200 | 文件名包含200个字符 | 上传成功 |
| 变更原因长度为500 | 填写500字符的变更原因 | 保存成功 |
| 审批意见为空 | 驳回时不填写审批意见 | 可以保存（可选字段） |
| 设备配置0个工艺文件 | 新设备未配置工艺文件 | 可正常上传 |
| 设备配置4个工艺文件 | 设备已配置4个工艺文件 | 仍可继续上传（不限制上限） |

#### 8.2.2 并发测试

| 测试场景 | 测试步骤 | 预期结果 |
|---------|---------|---------|
| 并发上传同一设备的文件 | 10个用户同时为同一设备上传工艺文件 | 全部成功，文件编号不重复 |
| 并发审批同一文件 | 2个车间主任同时审批同一文件 | 只有1个成功，另1个提示"该文件已审批" |
| 并发修改同一文件 | 2个用户同时修改同一工艺文件 | 使用乐观锁，只有1个成功 |
| 并发提交审批 | 同一用户快速点击2次提交按钮 | 只提交1次，第2次提示"当前状态不允许提交" |
| 高并发查询 | 100个用户同时查询工艺文件列表 | 响应时间<2秒，查询成功 |

#### 8.2.3 异常测试

| 测试场景 | 测试步骤 | 预期结果 |
|---------|---------|---------|
| 磁盘空间不足 | 磁盘空间不足时上传文件 | 提示"磁盘空间不足，上传失败" |
| 网络中断 | 上传过程中断网 | 提示"网络异常，上传失败"，回滚数据 |
| 数据库连接断开 | 审批过程中数据库断开 | 提示"系统异常，请稍后重试"，保持原状态 |
| 文件损坏 | 上传损坏的Excel文件 | 提示"文件格式错误或已损坏" |
| 文件被删除 | 下载已被物理删除的文件 | 提示"文件不存在或已被删除" |
| 设备被删除 | 查询已删除设备的工艺文件 | 仍可查看（软删除，保留历史数据） |

### 8.3 性能测试

#### 8.3.1 响应时间测试

| 操作 | 并发数 | 目标响应时间 | 备注 |
|-----|--------|-------------|-----|
| 文件列表查询 | 100 | <2秒 | 包含10000条数据 |
| 文件详情查询 | 50 | <1秒 | 包含审批历史 |
| 文件上传（2MB） | 10 | <5秒 | 正常网络环境 |
| 文件上传（10MB） | 5 | <15秒 | 正常网络环境 |
| 文件下载（2MB） | 20 | <3秒 | 正常网络环境 |
| 审批操作 | 50 | <1秒 | 单次审批操作 |
| 待审批列表 | 100 | <2秒 | 包含1000条数据 |

#### 8.3.2 吞吐量测试

| 测试场景 | 并发用户数 | 持续时间 | 目标TPS | 成功率目标 |
|---------|----------|---------|---------|----------|
| 文件上传 | 20 | 10分钟 | ≥10 | ≥99% |
| 文件查询 | 100 | 10分钟 | ≥200 | ≥99.5% |
| 审批操作 | 50 | 10分钟 | ≥50 | ≥99.5% |
| 文件下载 | 30 | 10分钟 | ≥20 | ≥99% |

#### 8.3.3 压力测试

| 测试场景 | 说明 | 预期结果 |
|---------|------|---------|
| 文件存储 | 存储100000个工艺文件 | 系统正常运行，查询性能不受影响 |
| 审批记录 | 单个文件审批记录超过100条（多次驳回重审） | 查询和展示正常 |
| 版本数量 | 单个设备工艺文件版本超过50个 | 版本切换和查询正常 |
| 长时间运行 | 系统连续运行30天 | 无内存泄漏，性能稳定 |

### 8.4 安全测试

#### 8.4.1 文件安全测试

| 测试场景 | 测试步骤 | 预期结果 |
|---------|---------|---------|
| 上传病毒文件 | 上传包含病毒的Excel文件 | 系统检测并拒绝上传 |
| 上传脚本文件 | 将.js文件改名为.xlsx上传 | 系统识别真实格式并拒绝 |
| 路径遍历攻击 | 下载文件时使用"../../"路径 | 系统拒绝非法路径访问 |
| SQL注入 | 在搜索框输入SQL语句 | 系统正确转义，不执行SQL |
| XSS攻击 | 在文件名中输入脚本代码 | 系统过滤或转义，不执行脚本 |

#### 8.4.2 权限安全测试

| 测试场景 | 测试步骤 | 预期结果 |
|---------|---------|---------|
| 未登录访问 | 未登录直接访问API | 返回401未授权 |
| Token过期 | 使用过期Token访问 | 返回401 Token过期 |
| 篡改Token | 修改Token内容访问 | 返回401 Token无效 |
| 越权访问 | 访问其他用户的草稿文件 | 返回403无权限 |
| 绕过审批流程 | 直接调用最终批准接口 | 系统验证状态，拒绝操作 |

### 8.5 兼容性测试

#### 8.5.1 浏览器兼容性

| 浏览器 | 版本 | 测试结果 |
|-------|------|---------|
| Chrome | 最新版 | 全功能支持 |
| Firefox | 最新版 | 全功能支持 |
| Safari | 最新版 | 全功能支持 |
| Edge | 最新版 | 全功能支持 |
| IE11 | - | 不支持（可提示升级） |

#### 8.5.2 Excel文件兼容性

| 格式 | 版本 | 测试结果 |
|-----|------|---------|
| .xls | Excel 97-2003 | 支持 |
| .xlsx | Excel 2007+ | 支持 |
| .xlsm | 带宏的Excel | 支持上传，宏不执行 |
| .xlsb | 二进制Excel | 不支持 |

## 9. 部署配置

### 9.1 文件存储配置

#### application.yml

```yaml
# 文件上传配置
file:
  upload:
    path: /data/uploads/process-files  # 本地存储路径
    max-size: 10485760  # 最大文件大小（10MB = 10 * 1024 * 1024）
    allowed-types: xls,xlsx  # 允许的文件类型
    
# 电子受控章配置
seal:
  image:
    path: /data/seals  # 受控章图片存储路径
    template: /templates/seal_template.png  # 受控章模板图片
    font-size: 14  # 字体大小
    color: red  # 印章颜色
```

#### FileUploadConfig.java

```java
package com.zssystem.config;

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Configuration;

@Configuration
@ConfigurationProperties(prefix = "file.upload")
public class FileUploadConfig {
    private String path;
    private Long maxSize;
    private String allowedTypes;
    
    // Getters and Setters
}
```

### 9.2 定时任务配置

#### ScheduleConfig.java

```java
package com.zssystem.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.annotation.EnableScheduling;

@Configuration
@EnableScheduling
public class ScheduleConfig {
}
```

#### ProcessFileScheduleTask.java

```java
package com.zssystem.task;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.zssystem.entity.ProcessFile;
import com.zssystem.mapper.ProcessFileMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.util.List;

@Slf4j
@Component
public class ProcessFileScheduleTask {

    @Autowired
    private ProcessFileMapper processFileMapper;

    /**
     * 定期清理过期的草稿文件（超过5天未提交）
     * 每天凌晨2点执行
     */
    @Scheduled(cron = "0 0 2 * * ?")
    public void cleanExpiredDrafts() {
        log.info("开始清理过期草稿文件...");
        
        LocalDateTime expireTime = LocalDateTime.now().minusDays(5);
        
        LambdaQueryWrapper<ProcessFile> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(ProcessFile::getStatus, 0)  // 草稿状态
               .lt(ProcessFile::getCreateTime, expireTime);  // 创建时间超过5天
        
        List<ProcessFile> expiredFiles = processFileMapper.selectList(wrapper);
        
        if (!expiredFiles.isEmpty()) {
            for (ProcessFile file : expiredFiles) {
                processFileMapper.deleteById(file.getId());
                log.info("清理过期草稿: {}, 创建时间: {}", file.getFileNo(), file.getCreateTime());
            }
            log.info("清理完成，共清理 {} 个过期草稿", expiredFiles.size());
        } else {
            log.info("没有需要清理的过期草稿");
        }
    }

    /**
     * 定期归档历史版本数据（超过2年）
     * 每月1日凌晨3点执行
     */
    @Scheduled(cron = "0 0 3 1 * ?")
    public void archiveOldVersions() {
        log.info("开始归档历史版本数据...");
        
        LocalDateTime archiveTime = LocalDateTime.now().minusYears(2);
        
        LambdaQueryWrapper<ProcessFile> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(ProcessFile::getIsCurrent, 0)  // 非当前版本
               .lt(ProcessFile::getCreateTime, archiveTime);  // 创建时间超过2年
        
        List<ProcessFile> oldVersions = processFileMapper.selectList(wrapper);
        
        if (!oldVersions.isEmpty()) {
            // TODO: 将数据归档到历史表或备份
            log.info("归档完成，共归档 {} 个历史版本", oldVersions.size());
        } else {
            log.info("没有需要归档的历史版本");
        }
    }
    
    /**
     * 定期检查并提醒超时未审批的工艺文件
     * 每天上午9点和下午3点执行
     */
    @Scheduled(cron = "0 0 9,15 * * ?")
    public void remindPendingApprovals() {
        log.info("开始检查超时未审批的工艺文件...");
        
        LocalDateTime reminderTime = LocalDateTime.now().minusDays(3);
        
        LambdaQueryWrapper<ProcessFile> wrapper = new LambdaQueryWrapper<>();
        wrapper.in(ProcessFile::getStatus, 1, 2, 3)  // 待审批状态
               .lt(ProcessFile::getSubmitTime, reminderTime);  // 提交时间超过3天
        
        List<ProcessFile> pendingFiles = processFileMapper.selectList(wrapper);
        
        if (!pendingFiles.isEmpty()) {
            for (ProcessFile file : pendingFiles) {
                // TODO: 发送提醒通知（站内消息、邮件等）
                log.info("提醒审批: {}, 提交时间: {}, 当前状态: {}", 
                        file.getFileNo(), file.getSubmitTime(), file.getStatus());
            }
            log.info("提醒完成，共 {} 个待审批文件超时", pendingFiles.size());
        } else {
            log.info("没有超时的待审批文件");
        }
    }
}
```

### 9.3 数据库索引优化

```sql
-- 为常用查询字段添加索引
CREATE INDEX idx_file_no ON process_file(file_no);
CREATE INDEX idx_equipment_id ON process_file(equipment_id);
CREATE INDEX idx_equipment_no ON process_file(equipment_no);
CREATE INDEX idx_machine_no ON process_file(machine_no);
CREATE INDEX idx_status ON process_file(status);
CREATE INDEX idx_creator_id ON process_file(creator_id);
CREATE INDEX idx_is_current ON process_file(is_current);
CREATE INDEX idx_submit_time ON process_file(submit_time);
CREATE INDEX idx_approval_time ON process_file(approval_time);

-- 复合索引（针对常见组合查询）
CREATE INDEX idx_equipment_status ON process_file(equipment_id, status);
CREATE INDEX idx_status_current ON process_file(status, is_current);
CREATE INDEX idx_creator_status ON process_file(creator_id, status);

-- 审批记录表索引
CREATE INDEX idx_approval_file_id ON process_file_approval(file_id);
CREATE INDEX idx_approval_level ON process_file_approval(approval_level);
CREATE INDEX idx_approval_approver ON process_file_approval(approver_id);

-- 电子受控章表索引
CREATE INDEX idx_seal_file_id ON process_file_seal(file_id);
```

### 9.4 Nginx配置（文件下载优化）

```nginx
# nginx.conf
server {
    listen 80;
    server_name your-domain.com;

    # API 代理
    location /api/ {
        proxy_pass http://localhost:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # 上传文件大小限制
        client_max_body_size 20M;
    }

    # 静态文件直接访问（提高下载性能）
    location /downloads/process-files/ {
        alias /data/uploads/process-files/;
        
        # 启用sendfile加速
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        
        # 缓存控制
        expires 1h;
        add_header Cache-Control "public, immutable";
        
        # 安全配置
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options DENY;
    }

    # 前端静态资源
    location / {
        root /var/www/frontend;
        try_files $uri $uri/ /index.html;
    }
}
```

### 9.5 Docker部署配置

#### Dockerfile（后端）

```dockerfile
FROM openjdk:17-jdk-slim

WORKDIR /app

# 复制jar包
COPY target/zssystem-backend-1.0.0.jar app.jar

# 创建文件上传目录
RUN mkdir -p /data/uploads/process-files
RUN mkdir -p /data/seals

# 暴露端口
EXPOSE 8080

# 启动应用
ENTRYPOINT ["java", "-jar", "app.jar"]
```

#### docker-compose.yml

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: zssystem-mysql
    environment:
      MYSQL_ROOT_PASSWORD: your_password
      MYSQL_DATABASE: zssystem
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql

  backend:
    build: ./backend
    container_name: zssystem-backend
    ports:
      - "8080:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/zssystem?useUnicode=true&characterEncoding=utf8
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: your_password
    volumes:
      - upload-data:/data/uploads
      - seal-data:/data/seals
    depends_on:
      - mysql

  frontend:
    image: nginx:alpine
    container_name: zssystem-frontend
    ports:
      - "80:80"
    volumes:
      - ./frontend/dist:/usr/share/nginx/html
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend

volumes:
  mysql-data:
  upload-data:
  seal-data:
```

### 9.6 监控配置

#### application.yml（添加actuator）

```yaml
# 监控配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
```

#### pom.xml（添加依赖）

```xml
<!-- Spring Boot Actuator -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>

<!-- Micrometer Prometheus -->
<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-registry-prometheus</artifactId>
</dependency>
```

## 10. 后续优化建议

### 10.1 工艺文件模板管理
- 提供标准化的工艺文件Excel模板
- 支持模板的在线编辑和版本管理
- 不同产品类型可配置不同模板
- 模板字段验证，确保上传文件符合规范

### 10.2 在线预览 Excel 文件
- 支持在浏览器中直接预览Excel内容
- 使用第三方组件（如：handsontable、SpreadJS）
- 支持多工作表切换查看
- 预览时显示电子受控章水印

### 10.3 审批提醒功能
- **站内消息提醒**：待审批时推送站内消息
- **邮件提醒**：发送审批通知邮件给审批人
- **短信提醒**：紧急审批可发送短信提醒
- **超时提醒**：超过规定时间未审批自动提醒
- **移动推送**：支持手机端消息推送

### 10.4 批量操作功能
- **批量上传**：支持一次上传多个工艺文件
- **批量提交**：可一次性提交多个草稿文件
- **批量审批**：审批人可批量通过/驳回多个文件
- **批量下载**：支持批量下载工艺文件
- **批量作废**：可一次作废多个过期文件

### 10.5 移动端审批
- 开发移动端H5页面或小程序
- 支持移动端查看工艺文件
- 支持移动端扫码审批
- 移动端签名功能
- 离线审批（缓存后上传）

### 10.6 电子签名功能
- 审批人手写电子签名
- 签名与用户账号绑定
- 签名加密存储
- 签名防伪验证
- 签名与电子受控章结合

### 10.7 集成工作流引擎
- 集成 Activiti 或 Flowable 工作流引擎
- 支持可视化流程设计
- 支持动态审批流程配置
- 支持条件分支（如：金额大小、紧急程度）
- 支持审批加签、转办、委托

### 10.8 文件水印功能
- 自动为工艺文件添加水印
- 水印包含：公司名称、受控标识、文件编号、生效日期
- 支持文字水印和图片水印
- 下载时自动添加水印
- 打印时显示水印

### 10.9 统计分析功能
- 工艺文件审批效率统计
- 各设备工艺文件配置情况统计
- 审批通过率、驳回率分析
- 版本变更频率统计
- 审批时长分析（平均审批时长、超时审批统计）
- 导出统计报表

### 10.10 工艺文件比对功能
- 不同版本之间的内容对比
- 高亮显示变更内容
- 支持Excel单元格级别对比
- 变更内容审批人重点关注
- 生成版本变更记录报告

### 10.11 智能审批建议
- 基于历史审批数据，AI辅助审批决策
- 自动识别工艺文件中的异常数据
- 提供审批意见模板推荐
- 风险预警提示

### 10.12 文档加密与权限
- 敏感工艺文件加密存储
- 下载文件设置密码保护
- 文件查看权限细化到部门/岗位
- 文件操作日志完整记录
- 防止未授权传播

## 11. 常见问题FAQ

### 11.1 功能使用问题

**Q1: 为什么我上传的文件提示"只支持Excel文件格式"？**

A: 请确保：
1. 文件扩展名为 .xls 或 .xlsx
2. 文件确实是Excel格式（不是改名的其他格式文件）
3. 文件没有损坏
4. 文件大小不超过10MB

**Q2: 审批流程中，我驳回了一个文件，为什么看不到了？**

A: 驳回后的文件状态变为"已驳回"，会退回到创建人那里。创建人可以在自己的文件列表中看到并修改。您可以在"全部文件"列表中筛选"已驳回"状态查看。

**Q3: 为什么我无法审批某个工艺文件？**

A: 请检查：
1. 该文件是否处于您可审批的状态
2. 您的角色是否有相应的审批权限
3. 该文件是否已被其他人审批

**Q4: 修改工艺文件后，为什么要重新走审批流程？**

A: 工艺文件的任何修改都可能影响生产质量和安全，因此必须重新审批以确保变更的合理性和规范性。

**Q5: 如何查看一个工艺文件的历史版本？**

A: 在文件详情页，点击"版本历史"按钮，可以查看所有历史版本，并支持下载。

**Q6: 电子受控章是什么时候生成的？**

A: 当工艺文件完成所有审批流程（生产技术部经理批准通过）后，系统会自动生成电子受控章。

**Q7: 一台设备必须配置几个工艺文件？**

A: 根据业务规则，每台设备至少需要配置4个工艺文件，但可以配置更多。

**Q8: 草稿状态的文件会被自动删除吗？**

A: 是的。超过5天未提交审批的草稿文件会被系统自动清理。请及时提交审批。

### 11.2 技术问题

**Q9: 文件上传失败，提示"网络异常"怎么办？**

A: 可能原因：
1. 网络不稳定，建议重试
2. 文件过大，上传超时，建议压缩文件或分批上传
3. 服务器存储空间不足，联系管理员

**Q10: 下载文件时出现404错误怎么办？**

A: 可能原因：
1. 文件已被物理删除
2. 文件路径配置错误
3. 权限不足
请联系系统管理员检查。

**Q11: 审批操作后，状态没有更新怎么办？**

A: 请尝试：
1. 刷新页面
2. 清除浏览器缓存
3. 检查网络连接
4. 如果仍然无法解决，联系技术支持

**Q12: 如何批量下载多个工艺文件？**

A: 当前版本暂不支持批量下载，请逐个下载。批量下载功能在后续版本中会提供。

### 11.3 权限问题

**Q13: 我是车间主任，为什么无法查看待审批列表？**

A: 请确认：
1. 您的账号角色是否正确设置为"车间主任"
2. 是否有待审批的工艺文件
3. 筛选条件是否正确

**Q14: 普通员工可以查看已批准的工艺文件吗？**

A: 可以。所有用户都可以查看已批准生效的工艺文件，但无法修改。

**Q15: 如何申请工艺文件的审批权限？**

A: 审批权限由系统管理员根据您的岗位分配。请联系管理员申请。

### 11.4 数据安全问题

**Q16: 工艺文件会丢失吗？**

A: 系统有完善的数据备份机制：
1. 数据库定期备份
2. 文件存储有冗余
3. 历史版本永久保留
4. 可以随时恢复

**Q17: 误删除的工艺文件可以恢复吗？**

A: 系统采用软删除机制，误删除的文件可以联系管理员恢复。

**Q18: 工艺文件的审批记录会被删除吗？**

A: 不会。所有审批记录都会永久保存，用于追溯和审计。

## 12. 开发进度规划

### 12.1 Phase 1: 核心功能（2-3周）

#### Week 1: 基础功能开发
- [ ] 数据库表创建和初始化
- [ ] 后端实体类、Mapper、DTO、VO开发
- [ ] 文件上传功能实现
- [ ] 工艺文件列表查询功能
- [ ] 工艺文件详情查询功能

#### Week 2: 审批流程开发
- [ ] 审批流程Service实现
- [ ] 审批流程Controller实现
- [ ] 审批记录保存
- [ ] 审批状态流转
- [ ] 权限验证逻辑

#### Week 3: 前端开发
- [ ] 工艺文件列表页
- [ ] 工艺文件上传页
- [ ] 工艺文件详情页
- [ ] 待审批列表页
- [ ] 审批操作页面

### 12.2 Phase 2: 增强功能（2周）

#### Week 4: 版本管理和电子受控章
- [ ] 版本管理功能实现
- [ ] 历史版本查看和下载
- [ ] 电子受控章生成逻辑
- [ ] 受控章图片生成
- [ ] 文件作废功能

#### Week 5: 优化和完善
- [ ] 文件下载优化
- [ ] 性能优化（索引、查询优化）
- [ ] 异常处理完善
- [ ] 日志记录完善
- [ ] 前端交互优化

### 12.3 Phase 3: 测试和部署（1-2周）

#### Week 6: 测试
- [ ] 单元测试
- [ ] 集成测试
- [ ] 功能测试
- [ ] 性能测试
- [ ] 安全测试
- [ ] Bug修复

#### Week 7: 部署和上线
- [ ] 测试环境部署
- [ ] 数据迁移（如有）
- [ ] 生产环境部署
- [ ] 用户培训
- [ ] 上线验证

### 12.4 Phase 4: 扩展功能（按需）

- [ ] 审批提醒功能
- [ ] 批量操作功能
- [ ] 移动端支持
- [ ] 在线预览功能
- [ ] 统计分析功能
- [ ] 工艺文件比对功能

## 13. 项目交付物

### 13.1 文档交付物

- ✅ 功能开发文档（本文档）
- [ ] 数据库设计文档
- [ ] API接口文档（Swagger/Knife4j自动生成）
- [ ] 用户操作手册
- [ ] 系统管理员手册
- [ ] 测试报告
- [ ] 部署文档

### 13.2 代码交付物

- [ ] 后端源代码（Java）
- [ ] 前端源代码（React + TypeScript）
- [ ] 数据库SQL脚本
- [ ] 配置文件
- [ ] Docker部署文件
- [ ] 单元测试代码

### 13.3 其他交付物

- [ ] 系统演示PPT
- [ ] 培训视频
- [ ] 常见问题FAQ文档
- [ ] 运维手册

## 14. 联系方式与技术支持

### 14.1 开发团队

- 项目负责人：[姓名]
- 后端开发：[姓名]
- 前端开发：[姓名]
- 测试工程师：[姓名]

### 14.2 技术支持

- 技术支持邮箱：support@company.com
- 技术支持电话：XXX-XXXX-XXXX
- 工作时间：周一至周五 9:00-18:00

### 14.3 问题反馈

如发现系统Bug或有功能建议，请通过以下方式反馈：

1. 在线问题跟踪系统：[URL]
2. 技术支持邮箱
3. 内部协作平台

---

## 文档变更记录

| 版本 | 日期 | 修改人 | 修改内容 |
|-----|------|--------|---------|
| V1.0 | 2026-01-24 | 开发团队 | 初始版本，完成基础功能设计 |
| V1.1 | 2026-01-24 | 开发团队 | 优化审批流程为3级，完善测试用例和部署配置 |
| V1.2 | 2026-01-24 | 开发团队 | 添加FAQ、开发进度规划和交付物清单 |

---

**文档结束**
