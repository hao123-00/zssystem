# 现场5S区域管理功能开发文档

## 1. 功能概述

现场5S区域管理是在现有5S管理模块下新增的子功能，用于对车间各区域进行职能化管理。注塑部经理负责定义区域及其职能、指定每日拍照时段；注塑组长负责在规定时段内上传各区域的现场照片。系统根据拍照完成情况自动判定当日状态为**正常**或**异常**。

## 2. 功能需求

### 2.1 区域管理（注塑部经理）

- **区域列表**：分页查询、新增、编辑、删除、启用/停用
- **区域信息**：
  - 区域编码、区域名称
  - **职能名称**：由经理指定（如：灯光管理、地面清洁、物料摆放、设备保养等）
  - 排序号（用于展示顺序）
  - 状态（启用/停用）
- **拍照时段配置**：每个区域可配置每日需拍照的次数及时间点（默认每日2次，如：08:00、16:00，可配置）
- **区域数量**：不固定，经理可根据实际需要动态添加

### 2.2 拍照上传（注塑组长）

- **我的拍照任务**：展示当日各区域待拍照列表，按时段分组
- **拍照上传**：
  - 选择区域 → 拍照或选择图片 → 提交
  - 支持手机端调用摄像头、PC端选择文件上传
  - 每次上传关联：区域ID、上传时间、上传人、照片路径
- **时段限制**：在指定时段内（如时段前后30分钟容忍）上传视为按时完成

### 2.3 状态判定规则

- **正常**：当日该区域所有规定时段均按时完成拍照
- **异常**：当日该区域任一规定时段未按时完成拍照
- 状态按**区域+日期**维度统计，每日零点后重新计算

### 2.4 统计与查看

- **日报/列表**：按日期查询各区域状态（正常/异常）、拍照记录
- **异常明细**：可查看异常原因（未拍照、超时拍照等）
- **历史记录**：支持按区域、日期范围查询拍照记录

### 2.5 权限与角色

| 角色       | 权限说明                               |
|------------|----------------------------------------|
| 注塑部经理 | 区域的新增、编辑、删除、职能配置、时段配置 |
| 注塑组长   | 查看拍照任务、上传照片、查看本组记录     |
| 普通用户   | 仅查看（可按需配置）                     |

## 3. 数据库设计

### 3.1 区域表（site_5s_area）

```sql
CREATE TABLE `site_5s_area` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `area_code` varchar(50) NOT NULL COMMENT '区域编码',
  `area_name` varchar(100) NOT NULL COMMENT '区域名称',
  `duty_name` varchar(100) NOT NULL COMMENT '职能名称（如：灯光管理、地面清洁）',
  `sort_order` int DEFAULT 0 COMMENT '排序号，越小越靠前',
  `status` tinyint DEFAULT 1 COMMENT '状态：0-停用，1-启用',
  `remark` varchar(500) DEFAULT NULL COMMENT '备注',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_area_code` (`area_code`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='5S区域表';
```

### 3.2 区域拍照时段配置表（site_5s_area_schedule）

```sql
CREATE TABLE `site_5s_area_schedule` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `area_id` bigint NOT NULL COMMENT '区域ID',
  `slot_index` int NOT NULL COMMENT '时段序号（1=第一次，2=第二次...）',
  `scheduled_time` time NOT NULL COMMENT '规定拍照时间（如 08:00）',
  `tolerance_minutes` int DEFAULT 30 COMMENT '前后容忍分钟数，如30表示07:30-08:30内有效',
  `remark` varchar(200) DEFAULT NULL COMMENT '时段说明',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` tinyint DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  KEY `idx_area_id` (`area_id`),
  UNIQUE KEY `uk_area_slot` (`area_id`, `slot_index`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='区域拍照时段配置表';
```

### 3.3 区域拍照记录表（site_5s_area_photo）

```sql
CREATE TABLE `site_5s_area_photo` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `area_id` bigint NOT NULL COMMENT '区域ID',
  `photo_date` date NOT NULL COMMENT '拍照日期',
  `slot_index` int NOT NULL COMMENT '对应时段序号',
  `photo_path` varchar(500) NOT NULL COMMENT '照片存储路径',
  `uploader_id` bigint DEFAULT NULL COMMENT '上传人ID',
  `uploader_name` varchar(50) DEFAULT NULL COMMENT '上传人姓名',
  `upload_time` datetime NOT NULL COMMENT '实际上传时间',
  `is_on_time` tinyint DEFAULT 1 COMMENT '是否按时：0-超时，1-按时',
  `remark` varchar(500) DEFAULT NULL COMMENT '备注',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `deleted` tinyint DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_area_date_slot` (`area_id`, `photo_date`, `slot_index`),
  KEY `idx_area_id` (`area_id`),
  KEY `idx_photo_date` (`photo_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='区域拍照记录表';
```

### 3.4 区域日报状态表（site_5s_area_daily_status，可选）

用于预计算每日各区域状态，便于快速查询和统计；也可不建此表，由业务层按规则实时计算。

```sql
CREATE TABLE `site_5s_area_daily_status` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `area_id` bigint NOT NULL COMMENT '区域ID',
  `status_date` date NOT NULL COMMENT '状态日期',
  `status` tinyint NOT NULL COMMENT '状态：0-异常，1-正常',
  `total_slots` int DEFAULT 2 COMMENT '当日应拍照次数',
  `completed_slots` int DEFAULT 0 COMMENT '已按时完成次数',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_area_date` (`area_id`, `status_date`),
  KEY `idx_status_date` (`status_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='区域日报状态表（可选）';
```

## 4. 业务流程

### 4.1 区域配置流程（经理）

1. 经理登录 → 进入「区域管理」
2. 点击「新增区域」→ 填写区域编码、名称、职能名称（如灯光管理）
3. 配置拍照时段：默认每日2次，可设置时间点（如 08:00、16:00）及容忍分钟数
4. 保存后，该区域进入启用状态，组长端可见

### 4.2 拍照上传流程（组长）

1. 组长登录 → 进入「区域拍照」或「我的拍照任务」
2. 选择日期（默认今日）→ 展示各区域及各时段完成情况
3. 对未完成的时段，点击「拍照」→ 调用摄像头或选择图片 → 提交
4. 系统校验上传时间是否在时段容忍范围内，标记为按时/超时
5. 全部时段完成后，该区域当日状态自动为「正常」

### 4.3 状态计算逻辑

```
当日状态 = (已按时完成次数 >= 应拍照次数) ? 正常 : 异常
```

- 未上传：completed_slots = 0，状态为异常
- 部分按时：如应2次，只完成1次按时，状态为异常
- 全部按时：completed_slots = total_slots，状态为正常

## 5. 接口设计（概要）

| 接口说明       | 方法 | 路径示例                      | 说明                 |
|----------------|------|-------------------------------|----------------------|
| 区域列表       | GET  | /api/site5s/area/list         | 分页查询，支持筛选   |
| 新增/编辑区域  | POST | /api/site5s/area/save         | 含时段配置           |
| 删除区域       | POST | /api/site5s/area/delete/{id}  | 逻辑删除             |
| 今日拍照任务   | GET  | /api/site5s/area/tasks        | 按日期返回各区域待办 |
| 上传照片       | POST | /api/site5s/area/upload-photo | 表单：areaId、slotIndex、date、file |
| 日报状态列表   | GET  | /api/site5s/area/daily-status | 按日期查询各区域状态 |
| 拍照记录查询   | GET  | /api/site5s/area/photo-records| 按区域、日期范围查询 |

## 6. 前端页面结构

### 6.1 区域管理（经理）

- 路径：`/site5s/area` 或整合进现有 5S 管理菜单
- 列表：表格展示区域编码、名称、职能、时段配置、状态、操作
- 新增/编辑弹窗：区域基本信息 + 时段配置（可动态添加/删除时段）

### 6.2 区域拍照（组长）

- 路径：`/site5s/area-photo`
- 日期选择器 + 各区域卡片/列表
- 每个区域展示：职能名称、各时段完成情况（✓ 已完成 / ○ 待完成）
- 待完成时段提供「拍照上传」按钮

### 6.3 日报/统计（共用）

- 按日期展示各区域状态（正常/异常）
- 支持导出报表（Excel）

## 7. 开发要点

### 7.1 时段容忍计算

- 规定时间 `scheduled_time`，容忍 `tolerance_minutes`
- 有效时间窗口：`[scheduled_time - tolerance_minutes, scheduled_time + tolerance_minutes]`
- 上传时间落在窗口内则 `is_on_time = 1`

### 7.2 照片存储

- 存储路径建议：`uploads/site5s-area/{year}/{month}/AP_{timestamp}.jpg`
- 与现有 `handover-photos` 类似，可配置根路径

### 7.3 默认时段配置

- 新建区域时，可预填默认 2 个时段：08:00、16:00，容忍 30 分钟
- 经理可修改时间点及容忍范围

### 7.4 角色与权限

- 使用现有权限体系，新增「区域管理」「区域拍照」等权限码
- 注塑部经理：区域管理相关权限
- 注塑组长：区域拍照、查看记录权限

## 8. 注意事项

1. 区域删除采用逻辑删除，已有拍照记录的区域可考虑禁止物理删除或提示
2. 时段配置变更不影响历史记录，仅影响新日期的判定
3. 同一区域、同一日期、同一时段仅允许一条有效拍照记录（唯一约束）
4. 照片文件需考虑定期清理策略（如保留 90 天），与业务确认
5. 前端需区分手机端（调用摄像头）与 PC 端（文件选择）
6. 编号规则：区域编码可沿用 `AREA001`、`AREA002` 等，由经理录入或自动生成
