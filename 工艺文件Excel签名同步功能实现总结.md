# 工艺文件Excel签名同步功能实现总结

## 完成时间
**日期**: 2026-01-25  
**状态**: ✅ 已完成

## 功能概述

在工艺文件审批流程中，当各角色完成电子签名后，自动将签名图片同步到注塑工艺卡（Excel文件）的相应位置：
- **注塑组长**的电子签名 → 编制人下方空白表格
- **车间主任**的电子签名 → 审核人下方空白表格
- **注塑部经理**的电子签名 → 会签下方空白表格
- **生产技术部经理**的电子签名 → 批准人下方空白表格

## 实现内容

### 1. Excel签名插入工具类

**文件**: `backend/src/main/java/com/zssystem/util/ProcessFileExcelUtil.java`

**核心功能**:
- `insertSignatureToExcel()`: 在Excel文件中插入签名图片
- `findCellPosition()`: 通过搜索文本查找签名位置
- `insertImageToCell()`: 将图片插入到指定单元格

**技术特点**:
- 使用Apache POI操作Excel文件
- 支持XLSX格式（.xlsx）
- 自动搜索"编制人"、"审核人"、"会签"、"批准人"标签
- 在标签下方单元格插入签名图片
- 自动调整行高和列宽以适应图片
- 图片自动调整大小保持宽高比

### 2. 签名类型映射

| 签名类型代码 | 签名类型名称 | Excel标签 | 签名人角色 |
|------------|------------|----------|-----------|
| `SUBMIT` | 提交 | 编制人 | 注塑组长 |
| `APPROVE_LEVEL1` | 审核 | 审核人 | 车间主任 |
| `APPROVE_LEVEL2` | 会签 | 会签 | 注塑部经理 |
| `APPROVE_LEVEL3` | 批准 | 批准人 | 生产技术部经理 |

### 3. 自动同步机制

**文件**: `backend/src/main/java/com/zssystem/service/impl/ProcessFileSignatureServiceImpl.java`

**实现逻辑**:
1. 保存电子签名记录到数据库
2. 保存签名图片到文件系统
3. **自动调用** `ProcessFileExcelUtil.insertSignatureToExcel()` 更新Excel文件
4. 如果Excel更新失败，记录警告但不影响签名记录保存

**代码位置**:
```java
// 在 saveSignature() 方法中
signatureMapper.insert(signature);

// 4. 将签名图片插入到工艺文件Excel中
try {
    boolean success = ProcessFileExcelUtil.insertSignatureToExcel(
        processFile.getFilePath(),
        signatureImagePath,
        signatureDTO.getSignatureType()
    );
    if (!success) {
        System.out.println("警告: 签名图片插入Excel失败，但签名记录已保存");
    }
} catch (Exception e) {
    System.err.println("插入签名到Excel时出错: " + e.getMessage());
    e.printStackTrace();
    // 不抛出异常，因为签名记录已保存，Excel更新失败不影响签名功能
}
```

## 技术实现细节

### 1. Excel文件操作

**使用的库**: Apache POI（通过EasyExcel间接引入）

**主要类**:
- `XSSFWorkbook`: 工作簿对象
- `XSSFSheet`: 工作表对象
- `XSSFDrawing`: 绘图对象
- `XSSFClientAnchor`: 图片锚点（定位和大小）
- `XSSFPicture`: 图片对象

### 2. 位置查找算法

1. **遍历所有单元格**，搜索包含标签文本的单元格
2. **找到标签后**，返回标签所在行的下一行、相同列的位置
3. **如果找不到标签**，返回null并记录警告

### 3. 图片插入参数

- **行高**: 80磅（约106像素）
- **列宽**: 最小20个字符宽度（如果当前列宽小于20）
- **图片大小**: 自动调整以适应单元格，保持宽高比
- **图片格式**: PNG

### 4. 错误处理

- **Excel文件不存在**: 记录错误，不影响签名记录保存
- **标签未找到**: 记录警告，返回false
- **图片插入失败**: 记录错误，不影响签名记录保存
- **文件权限问题**: 记录错误，不影响签名记录保存

## 文件清单

### 新增文件
- `backend/src/main/java/com/zssystem/util/ProcessFileExcelUtil.java` - Excel签名插入工具类

### 修改文件
- `backend/src/main/java/com/zssystem/service/impl/ProcessFileSignatureServiceImpl.java` - 添加Excel同步逻辑

## 使用说明

### 1. 功能自动触发

当用户完成电子签名后，系统会自动：
1. 保存签名记录到数据库
2. 保存签名图片到文件系统
3. **自动更新Excel文件**，将签名图片插入到相应位置

### 2. 签名位置说明

Excel文件中需要包含以下标签之一：
- **编制人** - 注塑组长签名位置
- **审核人** - 车间主任签名位置
- **会签** - 注塑部经理签名位置
- **批准人** - 生产技术部经理签名位置

签名图片会插入到标签所在行的下一行、相同列的位置。

### 3. Excel文件要求

- **格式**: XLSX格式（.xlsx）
- **标签位置**: 标签文本必须存在于Excel中
- **文件权限**: 系统需要有读写权限

## 测试验证

### 测试场景1: 注塑组长提交审批

1. 注塑组长上传工艺文件（Excel格式）
2. 点击"提交"按钮
3. 进行电子签名
4. **验证**:
   - ✅ 签名记录已保存
   - ✅ 签名图片已保存
   - ✅ Excel文件中"编制人"下方已插入签名图片

### 测试场景2: 车间主任审核

1. 车间主任进入"待我审批"
2. 选择一个待审核的工艺文件
3. 填写审批意见并签名
4. **验证**:
   - ✅ 审批记录已保存
   - ✅ 签名记录已保存
   - ✅ Excel文件中"审核人"下方已插入签名图片

### 测试场景3: 注塑部经理会签

1. 注塑部经理进入"待我审批"
2. 选择一个待会签的工艺文件
3. 填写审批意见并签名
4. **验证**:
   - ✅ 会签记录已保存
   - ✅ 签名记录已保存
   - ✅ Excel文件中"会签"下方已插入签名图片

### 测试场景4: 生产技术部经理批准

1. 生产技术部经理进入"待我审批"
2. 选择一个待批准的工艺文件
3. 填写审批意见并签名
4. **验证**:
   - ✅ 批准记录已保存
   - ✅ 签名记录已保存
   - ✅ Excel文件中"批准人"下方已插入签名图片

## 注意事项

### 1. Excel文件格式

- 仅支持XLSX格式（.xlsx）
- 不支持XLS格式（.xls）

### 2. 标签文本

- 标签文本必须完全匹配（区分大小写）
- 如果Excel中标签文本不同，需要修改工具类中的常量

### 3. 文件权限

- 确保系统对Excel文件有读写权限
- 如果文件被其他程序打开，可能无法更新

### 4. 错误处理

- Excel更新失败不会影响签名记录保存
- 系统会记录警告信息，便于排查问题

### 5. 性能考虑

- Excel文件较大时，更新可能需要一些时间
- 建议Excel文件大小不超过10MB

## 后续优化建议

1. **支持XLS格式**: 扩展支持.xls格式的Excel文件
2. **位置配置化**: 将签名位置配置化，支持自定义标签文本
3. **批量更新**: 支持批量更新多个签名
4. **图片压缩**: 对签名图片进行压缩，减小Excel文件大小
5. **位置验证**: 在插入前验证目标位置是否已有内容
6. **备份机制**: 更新Excel前自动备份原文件
7. **日志记录**: 记录详细的Excel更新日志

## 相关文档

- `工艺文件审批流程-电子签名功能实现总结.md` - 电子签名功能详细文档
- `工艺文件审批流程-电子签名功能快速使用指南.md` - 快速使用指南
- `12-注塑工艺文件管理功能开发文档.md` - 工艺文件管理完整功能设计

---

**完成状态**: ✅ 所有代码已完成并编译通过  
**下一步**: 重启后端服务，进行功能测试
