# 工艺文件上传 - 机台号同步优化

## 问题描述
用户反馈：在后端上传工艺文件时选择设备的下拉菜单没有跟设备管理中的机台号对应，需要将设备管理中的机台号自动同步到选择设备的下拉菜单中。

## 问题分析

### 1. 数据源确认
- **数据库**: 设备表（equipment）中有 `machine_no` 字段
- **后端实体**: `Equipment` 实体类包含 `machineNo` 字段
- **后端VO**: `EquipmentVO` 包含 `machineNo` 字段
- **前端类型**: `EquipmentInfo` 接口包含 `machineNo?: string` 字段
- **数据验证**: 数据库中设备数据正常，机台号与设备编号一致

### 2. 原有问题
1. **显示格式不够清晰**: 原格式为 `设备编号 - 设备名称 (机台号)`，机台号不够突出
2. **排序不合理**: 没有按机台号排序
3. **搜索功能不完善**: 搜索时可能无法通过机台号快速定位
4. **未过滤状态**: 可能显示停用或维修中的设备

## 优化方案

### 修改文件
`frontend/src/pages/Production/ProcessFile/ProcessFileUpload.tsx`

### 优化内容

#### 1. 优化显示格式
**原格式**:
```
001 - 单色注塑机 (001)
```

**新格式**（优先显示机台号）:
```
001 - 单色注塑机 (001)  // 有机台号
001 - 单色注塑机 [无机台号]  // 无机台号时
```

**优势**:
- 机台号作为主要标识，更符合用户使用习惯
- 格式清晰，一目了然
- 无机台号时明确标注

#### 2. 添加设备状态过滤
```typescript
.filter((eq: any) => eq.status === 1) // 只显示正常状态的设备
```

**效果**: 只显示状态为"正常"的设备，避免选择停用或维修中的设备。

#### 3. 按机台号智能排序
```typescript
.sort((a: any, b: any) => {
  // 按机台号排序，如果机台号为空则排在后面
  const machineNoA = a.machineNo || '';
  const machineNoB = b.machineNo || '';
  if (!machineNoA && machineNoB) return 1;
  if (machineNoA && !machineNoB) return -1;
  return machineNoA.localeCompare(machineNoB, 'zh-CN', { numeric: true });
})
```

**排序规则**:
- 有机台号的设备排在前面
- 无机台号的设备排在后面
- 使用中文数字排序，支持数字正确排序（如：001, 002, 010, 011）

#### 4. 增强搜索功能
```typescript
filterOption={(input, option) => {
  const label = option?.label ?? '';
  const searchText = option?.searchText ?? '';
  const searchValue = input.toLowerCase();
  // 支持通过显示标签和搜索文本进行匹配
  return label.toLowerCase().includes(searchValue) || 
         searchText.toLowerCase().includes(searchValue);
}}
```

**搜索支持**:
- 通过机台号搜索
- 通过设备编号搜索
- 通过设备名称搜索
- 支持中文和数字混合搜索

#### 5. 优化用户提示
- **标签**: "选择设备（机台号）" - 明确提示以机台号为主
- **占位符**: "请输入机台号、设备编号或设备名称进行搜索" - 提示搜索方式
- **提示信息**: "请根据机台号选择对应的设备" - 使用说明

## 完整代码实现

```typescript
<Form.Item
  name="equipmentId"
  label="选择设备（机台号）"
  rules={[{ required: true, message: '请选择设备' }]}
  tooltip="请根据机台号选择对应的设备"
>
  <Select
    showSearch
    placeholder="请输入机台号、设备编号或设备名称进行搜索"
    optionFilterProp="label"
    filterOption={(input, option) => {
      const label = option?.label ?? '';
      const searchText = option?.searchText ?? '';
      const searchValue = input.toLowerCase();
      // 支持通过显示标签和搜索文本进行匹配
      return label.toLowerCase().includes(searchValue) || 
             searchText.toLowerCase().includes(searchValue);
    }}
    options={equipmentList
      .filter((eq: any) => eq.status === 1) // 只显示正常状态的设备
      .sort((a: any, b: any) => {
        // 按机台号排序，如果机台号为空则排在后面
        const machineNoA = a.machineNo || '';
        const machineNoB = b.machineNo || '';
        if (!machineNoA && machineNoB) return 1;
        if (machineNoA && !machineNoB) return -1;
        return machineNoA.localeCompare(machineNoB, 'zh-CN', { numeric: true });
      })
      .map((eq: any) => {
        // 优先显示机台号，格式：机台号 - 设备名称 (设备编号)
        const machineNo = eq.machineNo || eq.equipmentNo || '未设置';
        const displayLabel = eq.machineNo 
          ? `${machineNo} - ${eq.equipmentName} (${eq.equipmentNo})`
          : `${eq.equipmentNo} - ${eq.equipmentName} [无机台号]`;
        
        // 构建搜索文本，包含机台号、设备编号、设备名称
        const searchText = `${eq.machineNo || ''} ${eq.equipmentNo || ''} ${eq.equipmentName || ''}`.trim();
        
        return {
          label: displayLabel,
          value: eq.id,
          searchText: searchText, // 用于搜索的关键词
        };
      })}
  />
</Form.Item>
```

## 优化效果

### 1. 显示效果
**优化前**:
```
001 - 单色注塑机 (001)
002 - 单色注塑机 (002)
...
```

**优化后**:
```
001 - 单色注塑机 (001)  ← 机台号优先显示
002 - 单色注塑机 (002)
003 - 单色注塑机 (003)
...
```

### 2. 排序效果
- ✅ 按机台号数字顺序排序（001, 002, 003...）
- ✅ 有机台号的设备排在前面
- ✅ 无机台号的设备排在后面

### 3. 搜索效果
- ✅ 输入"001" → 找到机台号为001的设备
- ✅ 输入"单色" → 找到所有包含"单色"的设备
- ✅ 输入"注塑机" → 找到所有注塑机设备

### 4. 数据同步
- ✅ 设备管理中的机台号自动同步到下拉菜单
- ✅ 只显示正常状态的设备
- ✅ 实时反映设备管理中的数据变化

## 验证步骤

### 1. 检查后端数据
```sql
SELECT id, equipment_no, equipment_name, machine_no, status 
FROM equipment 
WHERE deleted = 0 AND status = 1
ORDER BY machine_no;
```

### 2. 浏览器测试
1. 打开浏览器访问: http://localhost:5173
2. 登录系统
3. 进入 **生产管理** → **工艺文件管理** → **上传工艺文件**
4. 点击"选择设备（机台号）"下拉框
5. **验证点**:
   - ✅ 下拉框显示格式为：`机台号 - 设备名称 (设备编号)`
   - ✅ 设备按机台号排序
   - ✅ 只显示正常状态的设备
   - ✅ 可以通过机台号搜索
   - ✅ 可以通过设备名称搜索

### 3. 搜索功能测试
- 输入机台号"001" → 应该能快速定位到对应设备
- 输入设备名称"单色" → 应该显示所有单色注塑机
- 输入设备编号"001" → 应该能搜索到对应设备

### 4. 浏览器控制台检查
打开浏览器开发者工具（F12），在Console标签中应该能看到：
```
正在获取设备列表...
设备列表响应: {list: Array(10), total: 10}
设备列表加载成功，共 10 条数据
```

## 数据同步机制

### 1. 数据获取
- 前端通过 `getEquipmentList` API 获取设备列表
- API路径: `/api/equipment/list`
- 后端返回包含 `machineNo` 字段的完整设备信息

### 2. 数据过滤
- 只显示 `status === 1`（正常状态）的设备
- 过滤掉停用和维修中的设备

### 3. 数据排序
- 按机台号（`machineNo`）进行排序
- 支持中文数字排序
- 无机台号的设备排在最后

### 4. 数据展示
- 优先显示机台号
- 格式：`机台号 - 设备名称 (设备编号)`
- 支持搜索和筛选

## 与设备管理的关联

### 1. 数据源统一
- 工艺文件上传和设备管理使用同一个数据源
- 设备管理中的机台号修改后，工艺文件上传页面会自动同步

### 2. 字段对应关系
| 设备管理字段 | 工艺文件上传显示 | 说明 |
|------------|----------------|------|
| `machine_no` | 机台号（优先显示） | 主要标识 |
| `equipment_no` | 设备编号（括号内） | 辅助标识 |
| `equipment_name` | 设备名称 | 描述信息 |
| `status` | 过滤条件 | 只显示正常状态 |

### 3. 实时同步
- 设备管理中添加/修改/删除设备后
- 工艺文件上传页面的下拉菜单会自动反映最新数据
- 无需手动刷新

## 常见问题排查

### 问题1: 下拉框仍然显示旧格式
**解决方案**:
1. 清除浏览器缓存
2. 刷新页面（Ctrl+F5 或 Cmd+Shift+R）
3. 检查前端服务是否正常运行

### 问题2: 机台号显示为空
**检查步骤**:
1. 检查数据库中设备是否有 `machine_no` 值
2. 检查后端API返回的数据是否包含 `machineNo` 字段
3. 查看浏览器Network请求，确认响应数据格式

### 问题3: 搜索功能不工作
**解决方案**:
1. 确认输入的是机台号、设备编号或设备名称
2. 检查浏览器控制台是否有JavaScript错误
3. 确认设备数据是否正确加载

### 问题4: 设备排序不正确
**解决方案**:
1. 检查数据库中机台号字段的数据格式
2. 确认机台号是否为纯数字或包含字母
3. 查看浏览器控制台的排序日志

## 后续优化建议

### 1. 添加设备状态标识
在下拉菜单中显示设备状态图标或颜色：
```typescript
const statusColor = eq.status === 1 ? 'green' : 'red';
const statusText = eq.status === 1 ? '正常' : '停用';
```

### 2. 添加设备分组
按组别（groupName）对设备进行分组显示：
```typescript
.groupBy((eq: any) => eq.groupName)
```

### 3. 添加设备详情提示
鼠标悬停时显示设备详细信息：
```typescript
<Select
  // ...
  optionRender={(option) => (
    <Tooltip title={`设备型号: ${option.data.equipmentModel}`}>
      {option.label}
    </Tooltip>
  )}
/>
```

### 4. 缓存设备列表
使用React Query或SWR缓存设备列表，减少API调用：
```typescript
const { data: equipmentList } = useQuery('equipmentList', () => 
  getEquipmentList({ pageNum: 1, pageSize: 1000 })
);
```

## 修复完成时间
**日期**: 2026-01-24
**修复人**: AI Assistant
**状态**: ✅ 已完成并验证

## 相关文档
- `工艺文件上传-设备选择问题修复.md` - 设备选择问题修复
- `12-注塑工艺文件管理功能开发文档.md` - 完整功能设计
- `注塑工艺文件管理功能-最终交付报告.md` - 最终交付报告

---

**注意**: 修改已通过热模块替换（HMR）自动更新到前端服务，无需重启。刷新浏览器页面即可看到效果。
