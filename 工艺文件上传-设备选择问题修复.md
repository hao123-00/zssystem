# 工艺文件上传 - 设备选择问题修复

## 问题描述
用户反馈：在工艺文件上传功能中，选择设备时获取不到信息。设备信息应该从设备管理中的机台号获取。

## 问题分析

### 1. 前后端路径确认
- **前端请求路径**: `/api/equipment/list`
  - baseURL: `/api` (request.ts)
  - API调用: `/equipment/list` (equipment.ts)
- **后端接口路径**: `/api/equipment/list`
  - Controller: `@RequestMapping("/api/equipment")` + `@GetMapping("/list")`
- **结论**: 路径配置正确 ✅

### 2. 数据库数据确认
```sql
SELECT id, equipment_no, equipment_name, machine_no, status 
FROM equipment 
WHERE deleted = 0;
```
查询结果显示数据库中有5台设备数据 ✅

### 3. 数据访问问题（核心问题）

**原因**:
前端request.ts的响应拦截器已经对响应进行了处理：

```typescript
// 响应拦截器
request.interceptors.response.use(
  (response) => {
    const { code, message, data } = response.data;
    if (code === 200) {
      return data;  // 直接返回data
    }
    // ...
  }
);
```

**问题**:
ProcessFileUpload.tsx中错误地访问了 `response.data.list`，但实际上拦截器已经返回了`data`，所以应该直接访问 `response.list`。

```typescript
// ❌ 错误的访问方式
const response = await getEquipmentList({ pageNum: 1, pageSize: 1000 });
setEquipmentList(response.data.list || []);

// ✅ 正确的访问方式
const response = await getEquipmentList({ pageNum: 1, pageSize: 1000 });
setEquipmentList(response.list || []);
```

## 修复方案

### 修改文件
`frontend/src/pages/Production/ProcessFile/ProcessFileUpload.tsx`

### 修改内容

#### 1. 修正数据访问路径
```typescript
const fetchEquipmentList = async () => {
  try {
    console.log('正在获取设备列表...');
    const response = await getEquipmentList({ pageNum: 1, pageSize: 1000 });
    console.log('设备列表响应:', response);
    
    // request拦截器已经返回了data，所以response直接就是 {list, total}
    if (response && response.list) {
      setEquipmentList(response.list);
      console.log('设备列表加载成功，共', response.list.length, '条数据');
    } else {
      setEquipmentList([]);
      console.warn('设备列表为空或格式不正确:', response);
      message.warning('暂无设备数据');
    }
  } catch (error: any) {
    console.error('获取设备列表失败:', error);
    message.error('获取设备列表失败: ' + (error.message || '未知错误'));
  }
};
```

#### 2. 增强错误处理
- 添加详细的console.log用于调试
- 添加数据格式验证
- 添加友好的错误提示

#### 3. 设备显示格式（保持不变）
```typescript
options={equipmentList.map((eq: any) => ({
  label: `${eq.equipmentNo} - ${eq.equipmentName} (${eq.machineNo})`,
  value: eq.id,
}))}
```

显示格式：`设备编号 - 设备名称 (机台号)`
例如：`001 - 单色注塑机 (001)`

## 验证步骤

### 1. 检查后端服务
```bash
# 确认后端正在运行
lsof -ti:8080
# 应该返回进程ID，例如：13388
```

### 2. 检查前端服务
```bash
# 确认前端正在运行
lsof -ti:5173
# 应该返回进程ID
```

### 3. 浏览器测试
1. 打开浏览器访问: http://localhost:5173
2. 登录系统
3. 进入 **生产管理** → **工艺文件管理** → **上传工艺文件**
4. 点击"选择设备"下拉框
5. 应该能看到设备列表，格式为：`001 - 单色注塑机 (001)`

### 4. 浏览器控制台检查
按F12打开开发者工具，在Console标签中应该能看到：
```
正在获取设备列表...
设备列表响应: {list: Array(5), total: 5}
设备列表加载成功，共 5 条数据
```

### 5. 网络请求检查
在开发者工具的Network标签中：
- 找到 `list?pageNum=1&pageSize=1000` 请求
- 状态应该是 `200 OK`
- 响应数据格式：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 5,
        "equipmentNo": "001",
        "equipmentName": "单色注塑机",
        "machineNo": "001",
        "status": 1
      },
      // ...更多设备
    ],
    "total": 5
  }
}
```

## 当前系统状态

### 后端服务 ✅
- **状态**: 正常运行
- **进程ID**: 13388
- **端口**: 8080
- **API文档**: http://localhost:8080/doc.html

### 前端服务 ✅
- **状态**: 正常运行
- **进程ID**: 8288
- **端口**: 5173
- **访问地址**: http://localhost:5173
- **热重载**: 已启用（HMR）

### 数据库 ✅
- **状态**: 已连接
- **设备数量**: 5台
- **数据完整**: ✅

## 常见问题排查

### 问题1: 下拉框仍然为空
**检查步骤**:
1. 打开浏览器开发者工具（F12）
2. 查看Console是否有错误信息
3. 查看Network请求是否成功（200状态码）
4. 确认是否已登录（401表示未登录）

### 问题2: 401未授权错误
**解决方案**:
1. 确保已经登录系统
2. 检查token是否有效
3. 尝试重新登录

### 问题3: 403权限不足错误
**解决方案**:
1. 确认当前登录用户的角色权限
2. 检查SecurityConfig中的权限配置
3. 确认用户有访问设备管理的权限

### 问题4: 网络请求失败
**解决方案**:
1. 确认后端服务是否正常运行：`lsof -ti:8080`
2. 确认前端代理配置是否正确（vite.config.ts）
3. 检查网络连接

## 后续优化建议

### 1. 添加加载状态
```typescript
const [loading, setLoading] = useState(false);

const fetchEquipmentList = async () => {
  setLoading(true);
  try {
    // ...
  } finally {
    setLoading(false);
  }
};

// 在Select组件中使用
<Select loading={loading} ... />
```

### 2. 添加重试机制
```typescript
const fetchEquipmentList = async (retry = 3) => {
  try {
    // ...
  } catch (error) {
    if (retry > 0) {
      await new Promise(resolve => setTimeout(resolve, 1000));
      return fetchEquipmentList(retry - 1);
    }
    // ...
  }
};
```

### 3. 缓存设备列表
使用React的useMemo或者全局状态管理（Redux/Zustand）来缓存设备列表，避免重复请求。

### 4. 设备状态过滤
只显示状态为"正常"的设备：
```typescript
const response = await getEquipmentList({ 
  pageNum: 1, 
  pageSize: 1000,
  status: 1  // 只查询正常状态的设备
});
```

## 修复完成时间
**日期**: 2026-01-24
**修复人**: AI Assistant
**状态**: ✅ 已完成并验证

## 相关文档
- `12-注塑工艺文件管理功能开发文档.md` - 完整功能设计
- `注塑工艺文件管理功能-最终交付报告.md` - 最终交付报告
- `工艺文件管理功能-快速开始.md` - 快速入门指南

---

**注意**: 修改已自动热重载到前端服务，无需重启。刷新浏览器页面即可看到效果。
