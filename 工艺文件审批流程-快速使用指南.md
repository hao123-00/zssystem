# 工艺文件审批流程 - 快速使用指南

## ✅ 已完成的工作

1. ✅ 创建了4个审批流程角色
2. ✅ 创建了11个工艺文件管理权限
3. ✅ 建立了角色和权限的关联关系
4. ✅ 完善了SecurityUtil工具类
5. ✅ 更新了ProcessFileServiceImpl权限验证逻辑
6. ✅ 创建了角色常量类

## 📊 数据统计

- **角色数量**: 4个
- **权限数量**: 11个（2个菜单权限 + 9个按钮权限）
- **角色权限关联**: 23条

## 🚀 使用步骤

### 步骤1: 为用户分配角色

在用户管理模块中，为相关用户分配对应的角色：

1. **注塑组长用户** → 分配 `注塑组长` 角色
2. **车间主任用户** → 分配 `车间主任` 角色
3. **注塑部经理用户** → 分配 `注塑部经理` 角色
4. **生产技术部经理用户** → 分配 `生产技术部经理` 角色

### 步骤2: 测试审批流程

#### 测试场景1: 注塑组长上传和提交
1. 使用注塑组长账号登录
2. 进入"生产管理" → "工艺文件管理"
3. 点击"上传工艺文件"
4. 选择设备，上传Excel文件
5. 点击"提交"按钮，提交审批

#### 测试场景2: 车间主任审核
1. 使用车间主任账号登录
2. 进入"生产管理" → "待我审批"
3. 查看待审核的工艺文件
4. 点击"审批"按钮
5. 选择"通过"或"驳回"，填写审批意见
6. 提交审批

#### 测试场景3: 注塑部经理会签
1. 使用注塑部经理账号登录
2. 进入"生产管理" → "待我审批"
3. 查看待会签的工艺文件
4. 点击"审批"按钮
5. 选择"通过"或"驳回"，填写审批意见
6. 提交会签

#### 测试场景4: 生产技术部经理批准
1. 使用生产技术部经理账号登录
2. 进入"生产管理" → "待我审批"
3. 查看待批准的工艺文件
4. 点击"审批"按钮
5. 选择"通过"或"驳回"，填写审批意见
6. 提交批准（通过后自动盖电子受控章）

## 🔍 权限验证

系统会自动根据用户角色进行权限验证：

### 权限验证逻辑

1. **上传权限**: 只有注塑组长可以上传工艺文件
2. **提交权限**: 只有注塑组长可以提交审批
3. **审核权限**: 只有车间主任可以审核（第一级）
4. **会签权限**: 只有注塑部经理可以会签（第二级）
5. **批准权限**: 只有生产技术部经理可以批准（第三级）
6. **查看权限**: 所有角色都可以查看
7. **下载权限**: 所有角色都可以下载
8. **修改权限**: 只有注塑组长可以修改
9. **作废权限**: 注塑组长和生产技术部经理可以作废

### 审批流程状态流转

```
[草稿(0)] 
    ↓ 注塑组长提交
[待车间主任审核(1)] 
    ↓ 车间主任审核通过
[待注塑部经理会签(2)] 
    ↓ 注塑部经理会签通过
[待生产技术部经理批准(3)] 
    ↓ 生产技术部经理批准通过 + 盖电子受控章
[已批准-生效中(5)]
```

## 📝 角色权限对照表

| 角色 | 菜单权限 | 按钮权限 |
|------|---------|---------|
| **注塑组长** | 工艺文件管理 | 上传、提交、查看、下载、修改、作废 |
| **车间主任** | 工艺文件管理、待我审批 | 审核（第一级）、查看、下载 |
| **注塑部经理** | 工艺文件管理、待我审批 | 会签（第二级）、查看、下载 |
| **生产技术部经理** | 工艺文件管理、待我审批 | 批准（第三级）、查看、下载、作废 |

## 🔧 代码使用示例

### 在Controller中检查权限

```java
@PostMapping("/approve")
public Result<Void> approve(@Valid @RequestBody ProcessFileApprovalDTO approvalDTO) {
    // 获取当前用户角色代码
    String userRoleCode = SecurityUtil.getCurrentUserRoleCode();
    
    // 检查是否有审批权限
    if (!SecurityUtil.hasRoleCode(ProcessFileRoleConstant.ROLE_CODE_WORKSHOP_DIRECTOR)) {
        return Result.error("您没有审批权限");
    }
    
    // 执行审批逻辑
    // ...
}
```

### 在Service中验证权限

```java
@Override
public void approveProcessFile(ProcessFileApprovalDTO approvalDTO, 
                               Long currentUserId, 
                               String currentUserName, 
                               String currentUserRole) {
    // 验证审批权限（内部已使用角色代码验证）
    validateApprovalPermission(approvalLevel, currentUserRole);
    
    // 执行审批逻辑
    // ...
}
```

## ⚠️ 注意事项

1. **角色分配**: 确保为用户正确分配角色，否则无法进行相应操作
2. **权限验证**: 系统会自动验证权限，无需手动检查
3. **角色代码**: 建议使用角色代码而不是角色名称，更准确
4. **多角色支持**: 用户可以有多个角色，系统会检查所有角色
5. **权限继承**: 菜单权限包含其下的按钮权限，但需要显式分配

## 🐛 常见问题

### Q1: 用户无法看到"工艺文件管理"菜单？
**A**: 检查用户是否分配了相应的角色，以及角色是否有"工艺文件管理"菜单权限。

### Q2: 用户无法进行审批操作？
**A**: 检查：
1. 用户是否分配了对应的审批角色（车间主任/注塑部经理/生产技术部经理）
2. 工艺文件是否处于对应的审批状态
3. 用户是否有对应的审批权限

### Q3: 审批流程卡在某个环节？
**A**: 检查：
1. 是否有对应角色的用户
2. 该用户是否已分配角色
3. 工艺文件状态是否正确

### Q4: 如何查看用户的角色？
**A**: 在用户管理模块中，可以查看和编辑用户的角色分配。

## 📚 相关文件

- `backend/src/main/resources/db/process_file_role_permission_init.sql` - 角色权限初始化脚本
- `backend/src/main/java/com/zssystem/constant/ProcessFileRoleConstant.java` - 角色常量类
- `backend/src/main/java/com/zssystem/util/SecurityUtil.java` - 安全工具类
- `backend/src/main/java/com/zssystem/service/impl/ProcessFileServiceImpl.java` - 工艺文件服务实现
- `工艺文件审批流程-角色权限完善总结.md` - 详细总结文档

## ✅ 验证清单

- [x] SQL脚本执行成功
- [x] 4个角色已创建
- [x] 11个权限已创建
- [x] 23个角色权限关联已建立
- [x] SecurityUtil工具类已完善
- [x] ProcessFileServiceImpl权限验证已更新
- [x] 角色常量类已创建
- [ ] 为用户分配角色（需要手动完成）
- [ ] 测试审批流程（需要手动完成）

---

**下一步**: 在用户管理模块中为用户分配角色，然后测试审批流程功能。
