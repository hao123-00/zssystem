# 工艺文件审批流程 - 电子签名功能实现总结

## 完成时间
**日期**: 2026-01-25  
**状态**: ✅ 已完成

## 功能概述

在工艺文件审批流程中的提交、审核、审批、会签环节前增加电子签名功能，确保每个审批环节都有电子签名记录，提高审批流程的合法性和可追溯性。

## 实现内容

### 1. 数据库设计

#### 1.1 电子签名表（process_file_signature）

**文件**: `backend/src/main/resources/db/process_file_signature.sql`

**表结构**:
- `id`: 主键ID
- `file_id`: 工艺文件ID
- `file_no`: 工艺文件编号（冗余）
- `signature_type`: 签名类型（SUBMIT-提交，APPROVE_LEVEL1-审核，APPROVE_LEVEL2-会签，APPROVE_LEVEL3-批准）
- `signer_id`: 签名人ID
- `signer_name`: 签名人姓名
- `signer_role`: 签名人角色
- `signature_image_path`: 签名图片路径
- `signature_time`: 签名时间
- `ip_address`: 签名IP地址
- `device_info`: 设备信息
- `create_time`: 创建时间
- `update_time`: 更新时间
- `deleted`: 删除标志

#### 1.2 审批记录表更新

在 `process_file_approval` 表中添加 `signature_id` 字段，关联电子签名记录。

### 2. 后端实现

#### 2.1 实体类

**文件**: `backend/src/main/java/com/zssystem/entity/ProcessFileSignature.java`
- 使用MyBatis-Plus注解
- 支持逻辑删除
- 自动填充创建时间和更新时间

#### 2.2 DTO

**文件**: `backend/src/main/java/com/zssystem/dto/ProcessFileSignatureDTO.java`
- `fileId`: 文件ID
- `signatureType`: 签名类型
- `signatureImage`: 签名图片（MultipartFile）
- `ipAddress`: IP地址（可选）
- `deviceInfo`: 设备信息（可选）

#### 2.3 VO

**文件**: `backend/src/main/java/com/zssystem/vo/ProcessFileSignatureVO.java`
- 包含签名所有信息
- `signatureTypeText`: 签名类型文本
- `signatureImageUrl`: 签名图片访问URL

#### 2.4 Mapper

**文件**: `backend/src/main/java/com/zssystem/mapper/ProcessFileSignatureMapper.java`
- 继承 `BaseMapper<ProcessFileSignature>`
- 提供根据文件ID和签名类型查询的方法

#### 2.5 Service

**文件**: 
- `backend/src/main/java/com/zssystem/service/ProcessFileSignatureService.java` - 接口
- `backend/src/main/java/com/zssystem/service/impl/ProcessFileSignatureServiceImpl.java` - 实现

**主要方法**:
- `saveSignature()`: 保存电子签名
- `getSignaturesByFileId()`: 查询文件的所有签名
- `getSignatureByFileIdAndType()`: 根据文件ID和类型查询签名
- `getSignatureById()`: 根据签名ID查询

**功能特点**:
- 自动创建签名存储目录（按年月分类）
- 生成唯一文件名
- 保存签名图片到文件系统
- 记录IP地址和设备信息

#### 2.6 Controller

**文件**: `backend/src/main/java/com/zssystem/controller/ProcessFileController.java`

**新增/修改接口**:

1. **提交审批接口** (`POST /api/production/process-file/{id}/submit`)
   - 接收签名图片（MultipartFile）
   - 保存电子签名
   - 提交审批

2. **审批接口** (`POST /api/production/process-file/approve`)
   - 接收审批数据和签名图片
   - 根据文件状态确定签名类型
   - 保存电子签名
   - 执行审批并关联签名ID

3. **查询签名列表** (`GET /api/production/process-file/{id}/signatures`)
   - 查询文件的所有电子签名

4. **查看签名图片** (`GET /api/production/process-file/signature/image/{signatureId}`)
   - 返回签名图片的二进制数据

#### 2.7 审批记录关联

**更新**: `ProcessFileApproval` 实体类添加 `signatureId` 字段
**更新**: `ProcessFileApprovalVO` 添加 `signatureInfo` 字段
**更新**: `ProcessFileServiceImpl.convertToApprovalVO()` 方法，自动查询并关联签名信息

### 3. 前端实现

#### 3.1 签名画板组件

**文件**: 
- `frontend/src/components/SignaturePad/SignaturePad.tsx`
- `frontend/src/components/SignaturePad/SignaturePad.less`

**功能特点**:
- 基于Canvas的签名画板
- 支持鼠标和触摸操作
- 支持清除重签
- 将画布内容转换为Base64图片

**使用方式**:
```typescript
<SignaturePad
  onConfirm={(signatureData) => {
    // signatureData是Base64格式的图片数据
    // 处理签名确认
  }}
  onCancel={() => {
    // 处理取消
  }}
  width={600}
  height={300}
/>
```

#### 3.2 API接口

**文件**: `frontend/src/api/processFile.ts`

**新增接口**:
- `uploadSignature()`: 上传电子签名
- `getSignaturesByFileId()`: 查询文件的签名列表
- `getSignatureImage()`: 查看签名图片

**修改接口**:
- `submitProcessFile()`: 修改为接收签名数据
- `approveProcessFile()`: 修改为接收签名数据

#### 3.3 页面集成

**文件**: `frontend/src/pages/Production/ProcessFile/index.tsx`

**修改内容**:
- 提交审批时弹出签名弹窗
- 签名确认后提交审批（包含签名数据）

**文件**: `frontend/src/pages/Production/ProcessFile/ProcessFileDetail.tsx`

**修改内容**:
- 审批时先填写审批意见，然后弹出签名弹窗
- 签名确认后提交审批（包含签名数据）
- 审批历史中显示电子签名图片

### 4. 签名类型映射

| 签名类型代码 | 签名类型名称 | 使用场景 |
|------------|------------|---------|
| `SUBMIT` | 提交 | 注塑组长提交审批 |
| `APPROVE_LEVEL1` | 审核（车间主任） | 车间主任审核 |
| `APPROVE_LEVEL2` | 会签（注塑部经理） | 注塑部经理会签 |
| `APPROVE_LEVEL3` | 批准（生产技术部经理） | 生产技术部经理批准 |

### 5. 审批流程集成

#### 5.1 提交审批流程

```
[注塑组长] 
    ↓ 点击"提交"按钮
[弹出签名弹窗]
    ↓ 进行签名
[确认签名]
    ↓ 上传签名 + 提交审批
[状态变为：待车间主任审核]
```

#### 5.2 审批流程

```
[审批人] 
    ↓ 点击"审批"按钮
[填写审批意见]
    ↓ 点击"确定"
[弹出签名弹窗]
    ↓ 进行签名
[确认签名]
    ↓ 上传签名 + 提交审批
[状态流转到下一级 / 已批准]
```

## 文件清单

### 数据库文件
- `backend/src/main/resources/db/process_file_signature.sql` - 签名表创建脚本

### 后端文件
- `backend/src/main/java/com/zssystem/entity/ProcessFileSignature.java` - 签名实体类
- `backend/src/main/java/com/zssystem/dto/ProcessFileSignatureDTO.java` - 签名DTO
- `backend/src/main/java/com/zssystem/vo/ProcessFileSignatureVO.java` - 签名VO
- `backend/src/main/java/com/zssystem/mapper/ProcessFileSignatureMapper.java` - 签名Mapper
- `backend/src/main/java/com/zssystem/service/ProcessFileSignatureService.java` - 签名Service接口
- `backend/src/main/java/com/zssystem/service/impl/ProcessFileSignatureServiceImpl.java` - 签名Service实现
- `backend/src/main/java/com/zssystem/controller/ProcessFileController.java` - 更新Controller
- `backend/src/main/java/com/zssystem/entity/ProcessFileApproval.java` - 更新实体类（添加signatureId）
- `backend/src/main/java/com/zssystem/vo/ProcessFileApprovalVO.java` - 更新VO（添加signatureInfo）
- `backend/src/main/java/com/zssystem/service/ProcessFileService.java` - 更新接口（添加signatureId参数）
- `backend/src/main/java/com/zssystem/service/impl/ProcessFileServiceImpl.java` - 更新实现（关联签名）

### 前端文件
- `frontend/src/components/SignaturePad/SignaturePad.tsx` - 签名画板组件
- `frontend/src/components/SignaturePad/SignaturePad.less` - 签名画板样式
- `frontend/src/api/processFile.ts` - 更新API接口
- `frontend/src/pages/Production/ProcessFile/index.tsx` - 更新提交审批功能
- `frontend/src/pages/Production/ProcessFile/ProcessFileDetail.tsx` - 更新审批功能和显示

## 使用说明

### 1. 执行SQL脚本

```bash
mysql -uroot -pczd828101 -D zssystem < backend/src/main/resources/db/process_file_signature.sql
```

### 2. 创建签名存储目录

```bash
mkdir -p /Users/czd/zssystem/uploads/signatures
```

### 3. 重启后端服务

```bash
cd /Users/czd/zssystem/backend
./start.sh
```

### 4. 测试功能

#### 测试场景1: 提交审批
1. 使用注塑组长账号登录
2. 进入"生产管理" → "工艺文件管理"
3. 选择一个草稿状态的工艺文件
4. 点击"提交"按钮
5. 在签名弹窗中进行签名
6. 点击"确认签名"
7. 验证：提交成功，状态变为"待车间主任审核"

#### 测试场景2: 审批流程
1. 使用车间主任账号登录
2. 进入"生产管理" → "待我审批"
3. 选择一个待审核的工艺文件
4. 点击"审批"按钮
5. 填写审批意见，选择"通过"或"驳回"
6. 点击"确定"
7. 在签名弹窗中进行签名
8. 点击"确认签名"
9. 验证：审批成功，签名显示在审批历史中

## 技术要点

### 1. 签名图片存储
- 存储路径：`/Users/czd/zssystem/uploads/signatures/年份/月份/`
- 文件命名：`SIG_文件ID_类型_时间戳.png`
- 格式：PNG图片

### 2. 签名数据格式
- 前端：Canvas转换为Base64格式
- 传输：Base64转换为Blob，使用FormData上传
- 后端：接收MultipartFile，保存为PNG文件

### 3. 签名关联
- 提交审批：签名类型为 `SUBMIT`
- 审核：签名类型为 `APPROVE_LEVEL1`
- 会签：签名类型为 `APPROVE_LEVEL2`
- 批准：签名类型为 `APPROVE_LEVEL3`

### 4. 签名显示
- 审批历史中显示签名图片
- 支持点击查看大图
- 显示签名时间和签名人信息

## 安全考虑

1. **签名验证**: 记录IP地址和设备信息，便于追溯
2. **签名不可篡改**: 签名图片保存后不可修改
3. **签名关联**: 每个审批记录关联唯一的签名ID
4. **权限控制**: 只有对应角色才能进行签名和审批

## 后续优化建议

1. **签名水印**: 在签名图片上添加时间戳水印
2. **签名加密**: 对签名图片进行加密存储
3. **签名验证**: 添加签名完整性验证机制
4. **批量签名**: 支持批量审批时的批量签名
5. **签名模板**: 支持保存常用签名模板

## 验证清单

- [x] 数据库表创建成功
- [x] 后端代码编译通过
- [x] 前端组件创建完成
- [x] 提交审批集成签名功能
- [x] 审批流程集成签名功能
- [x] 审批历史显示签名
- [ ] 功能测试（需要手动完成）
- [ ] 签名图片存储验证（需要手动完成）

## 相关文档

- `12-注塑工艺文件管理功能开发文档.md` - 工艺文件管理完整功能设计
- `工艺文件审批流程-角色权限完善总结.md` - 角色权限完善总结
- `工艺文件审批流程-快速使用指南.md` - 快速使用指南

---

**完成状态**: ✅ 所有代码已完成并编译通过  
**下一步**: 重启后端服务，进行功能测试
