# 工艺文件审批流程 - 电子签名功能快速使用指南

## ✅ 已完成的工作

1. ✅ 创建了电子签名数据库表
2. ✅ 实现了后端签名服务
3. ✅ 创建了前端签名画板组件
4. ✅ 集成了签名功能到审批流程
5. ✅ 更新了审批记录显示签名

## 🚀 使用步骤

### 步骤1: 重启后端服务

后端代码已修改，需要重新启动：

```bash
# 停止当前后端服务
kill $(lsof -ti:8080)

# 重新启动后端服务
cd /Users/czd/zssystem/backend
./start.sh
```

### 步骤2: 测试提交审批（需要签名）

1. **使用注塑组长账号登录**
2. 进入 **生产管理** → **工艺文件管理**
3. 选择一个草稿状态的工艺文件
4. 点击 **"提交"** 按钮
5. **弹出签名弹窗**：
   - 在画板上进行签名（支持鼠标和触摸）
   - 可以点击"清除重签"重新签名
   - 点击"确认签名"完成
6. **验证**：
   - ✅ 提交成功
   - ✅ 状态变为"待车间主任审核"
   - ✅ 签名已保存

### 步骤3: 测试审批流程（需要签名）

1. **使用车间主任账号登录**
2. 进入 **生产管理** → **待我审批**
3. 选择一个待审核的工艺文件
4. 点击 **"审批"** 按钮
5. **填写审批信息**：
   - 选择"通过"或"驳回"
   - 填写审批意见（驳回时必填）
   - 点击"确定"
6. **弹出签名弹窗**：
   - 在画板上进行签名
   - 点击"确认签名"
7. **验证**：
   - ✅ 审批成功
   - ✅ 状态流转到下一级
   - ✅ 审批历史中显示签名图片

### 步骤4: 查看签名信息

1. 进入工艺文件详情页
2. 查看 **"审批历史"** 部分
3. **验证**：
   - ✅ 每个审批记录都显示签名图片
   - ✅ 显示签名时间和签名人信息
   - ✅ 可以点击签名图片查看大图

## 📋 签名类型说明

| 操作 | 签名类型 | 签名人角色 |
|------|---------|-----------|
| 提交审批 | SUBMIT | 注塑组长 |
| 审核 | APPROVE_LEVEL1 | 车间主任 |
| 会签 | APPROVE_LEVEL2 | 注塑部经理 |
| 批准 | APPROVE_LEVEL3 | 生产技术部经理 |

## 🎨 签名画板使用说明

### 基本操作
- **鼠标/触摸**: 在画板上拖动进行签名
- **清除重签**: 点击"清除重签"按钮清空画板
- **确认签名**: 点击"确认签名"按钮完成签名并提交

### 注意事项
- 签名前请确保画板上有签名内容
- 签名后无法修改，如需修改请点击"清除重签"
- 签名图片会自动保存，不可删除

## 🔍 签名存储位置

签名图片存储在：
```
/Users/czd/zssystem/uploads/signatures/年份/月份/
```

文件命名格式：
```
SIG_文件ID_类型_时间戳.png
```

例如：
```
SIG_1_SUBMIT_20260125120000.png
```

## ⚠️ 常见问题

### Q1: 签名弹窗无法显示？
**A**: 检查浏览器控制台是否有错误，确认前端代码已更新。

### Q2: 签名后提交失败？
**A**: 
1. 检查后端服务是否正常运行
2. 检查签名存储目录是否存在
3. 查看后端日志确认错误信息

### Q3: 审批历史中看不到签名？
**A**: 
1. 确认审批时已进行签名
2. 检查签名图片是否成功保存
3. 查看浏览器Network请求确认签名数据是否正确返回

### Q4: 签名图片无法显示？
**A**: 
1. 检查签名图片路径是否正确
2. 确认签名图片文件是否存在
3. 检查文件权限

## 📝 数据验证

### 验证签名数据

```sql
-- 查询所有电子签名
SELECT id, file_id, file_no, signature_type, signer_name, signer_role, signature_time
FROM process_file_signature
WHERE deleted = 0
ORDER BY signature_time DESC;

-- 查询审批记录关联的签名
SELECT a.id, a.file_id, a.approval_level, a.approver_name, a.signature_id, s.signature_type
FROM process_file_approval a
LEFT JOIN process_file_signature s ON a.signature_id = s.id
WHERE a.deleted = 0
ORDER BY a.approval_time DESC;
```

## 🎯 功能特点

1. **强制签名**: 提交和审批前必须进行签名
2. **签名追溯**: 记录签名时间、IP地址、设备信息
3. **签名关联**: 每个审批记录关联唯一的签名
4. **签名显示**: 审批历史中显示签名图片
5. **签名不可篡改**: 签名保存后不可修改

## 📚 相关文档

- `工艺文件审批流程-电子签名功能实现总结.md` - 详细实现文档
- `工艺文件审批流程-角色权限完善总结.md` - 角色权限完善总结
- `12-注塑工艺文件管理功能开发文档.md` - 工艺文件管理完整功能设计

---

**下一步**: 重启后端服务，进行功能测试
