# 工艺文件审批流程 - 角色权限完善总结

## 完成时间
**日期**: 2026-01-25  
**状态**: ✅ 已完成

## 完成内容

### 1. 创建角色和权限初始化SQL脚本

**文件**: `backend/src/main/resources/db/process_file_role_permission_init.sql`

#### 创建的角色（4个）
1. **注塑组长** (`INJECTION_LEADER`)
   - 角色代码: `INJECTION_LEADER`
   - 角色名称: `注塑组长`
   - 描述: 负责编制和上传注塑工艺文件

2. **车间主任** (`WORKSHOP_DIRECTOR`)
   - 角色代码: `WORKSHOP_DIRECTOR`
   - 角色名称: `车间主任`
   - 描述: 负责审核注塑工艺文件

3. **注塑部经理** (`INJECTION_MANAGER`)
   - 角色代码: `INJECTION_MANAGER`
   - 角色名称: `注塑部经理`
   - 描述: 负责会签注塑工艺文件

4. **生产技术部经理** (`PRODUCTION_TECH_MANAGER`)
   - 角色代码: `PRODUCTION_TECH_MANAGER`
   - 角色名称: `生产技术部经理`
   - 描述: 负责最终批准注塑工艺文件并盖电子受控章

#### 创建的权限（11个）

**菜单权限（2个）**:
1. `PROCESS_FILE_MANAGEMENT` - 工艺文件管理（菜单）
2. `PROCESS_FILE_PENDING_APPROVAL` - 待我审批（菜单）

**按钮权限（9个）**:
1. `PROCESS_FILE_UPLOAD` - 工艺文件上传
2. `PROCESS_FILE_SUBMIT` - 工艺文件提交审批
3. `PROCESS_FILE_APPROVE_LEVEL1` - 工艺文件审核（车间主任）
4. `PROCESS_FILE_APPROVE_LEVEL2` - 工艺文件会签（注塑部经理）
5. `PROCESS_FILE_APPROVE_LEVEL3` - 工艺文件批准（生产技术部经理）
6. `PROCESS_FILE_VIEW` - 工艺文件查看
7. `PROCESS_FILE_DOWNLOAD` - 工艺文件下载
8. `PROCESS_FILE_EDIT` - 工艺文件修改
9. `PROCESS_FILE_INVALIDATE` - 工艺文件作废

#### 角色权限分配

**注塑组长权限**:
- 工艺文件管理（菜单）
- 工艺文件上传（按钮）
- 工艺文件提交审批（按钮）
- 工艺文件查看（按钮）
- 工艺文件下载（按钮）
- 工艺文件修改（按钮）
- 工艺文件作废（按钮）

**车间主任权限**:
- 工艺文件管理（菜单）
- 工艺文件审核（第一级）（按钮）
- 工艺文件查看（按钮）
- 工艺文件下载（按钮）
- 待我审批（菜单）

**注塑部经理权限**:
- 工艺文件管理（菜单）
- 工艺文件会签（第二级）（按钮）
- 工艺文件查看（按钮）
- 工艺文件下载（按钮）
- 待我审批（菜单）

**生产技术部经理权限**:
- 工艺文件管理（菜单）
- 工艺文件批准（第三级）（按钮）
- 工艺文件查看（按钮）
- 工艺文件下载（按钮）
- 待我审批（菜单）
- 工艺文件作废（按钮）

### 2. 创建角色常量类

**文件**: `backend/src/main/java/com/zssystem/constant/ProcessFileRoleConstant.java`

**功能**:
- 定义角色代码和角色名称常量
- 提供角色代码和角色名称的相互转换方法
- 提供审批级别到角色的映射方法
- 提供角色验证方法

**主要方法**:
- `getRoleNameByCode(String roleCode)` - 根据角色代码获取角色名称
- `getRoleCodeByName(String roleName)` - 根据角色名称获取角色代码
- `getRoleCodeByApprovalLevel(int approvalLevel)` - 根据审批级别获取角色代码
- `getRoleNameByApprovalLevel(int approvalLevel)` - 根据审批级别获取角色名称
- `isProcessFileRole(String roleCode)` - 检查是否为工艺文件审批相关角色

### 3. 完善SecurityUtil工具类

**文件**: `backend/src/main/java/com/zssystem/util/SecurityUtil.java`

**新增功能**:
1. **getCurrentUserRoleCode()** - 获取当前用户角色代码（第一个角色）
2. **getCurrentUserRoleCodes()** - 获取当前用户所有角色代码列表
3. **hasRoleCode(String roleCode)** - 检查当前用户是否有指定角色（通过角色代码）

**改进功能**:
- **getCurrentUserRole()** - 完善了从用户角色关联表查询用户角色的逻辑
- 支持从 `sys_user_role` 表查询用户角色
- 支持从 `sys_role` 表获取角色详细信息

### 4. 更新ProcessFileServiceImpl

**文件**: `backend/src/main/java/com/zssystem/service/impl/ProcessFileServiceImpl.java`

**改进内容**:

#### validateApprovalPermission() 方法
- 使用角色常量类进行权限验证
- 支持通过角色代码和角色名称两种方式验证（兼容性）
- 优先使用角色代码验证，提高准确性
- 提供更详细的错误提示信息

#### getStatusByRole() 方法
- 使用角色常量类进行角色判断
- 支持通过角色代码和角色名称两种方式判断（兼容性）
- 优先使用角色代码判断，提高准确性

## 审批流程权限映射

| 审批级别 | 审批环节 | 角色代码 | 角色名称 | 权限代码 |
|---------|---------|---------|---------|---------|
| 1 | 第一级审核 | `WORKSHOP_DIRECTOR` | 车间主任 | `PROCESS_FILE_APPROVE_LEVEL1` |
| 2 | 第二级会签 | `INJECTION_MANAGER` | 注塑部经理 | `PROCESS_FILE_APPROVE_LEVEL2` |
| 3 | 第三级批准 | `PRODUCTION_TECH_MANAGER` | 生产技术部经理 | `PROCESS_FILE_APPROVE_LEVEL3` |

## 执行SQL脚本

### 执行方式

```bash
# 方式1：使用mysql命令行
mysql -uroot -pczd828101 -D zssystem < backend/src/main/resources/db/process_file_role_permission_init.sql

# 方式2：在MySQL客户端中执行
source /Users/czd/zssystem/backend/src/main/resources/db/process_file_role_permission_init.sql
```

### 验证数据

执行SQL脚本后，可以运行以下查询验证数据：

```sql
-- 查询创建的角色
SELECT `id`, `role_code`, `role_name`, `description`, `status` 
FROM `sys_role` 
WHERE `role_code` IN ('INJECTION_LEADER', 'WORKSHOP_DIRECTOR', 'INJECTION_MANAGER', 'PRODUCTION_TECH_MANAGER')
AND `deleted` = 0
ORDER BY `id`;

-- 查询创建的权限
SELECT `id`, `permission_code`, `permission_name`, `permission_type`, `parent_id`
FROM `sys_permission` 
WHERE `permission_code` LIKE 'PROCESS_FILE%'
AND `deleted` = 0
ORDER BY `permission_type`, `sort_order`;

-- 查询角色权限关联
SELECT r.`role_code`, r.`role_name`, p.`permission_code`, p.`permission_name`
FROM `sys_role` r
INNER JOIN `sys_role_permission` rp ON r.`id` = rp.`role_id`
INNER JOIN `sys_permission` p ON rp.`permission_id` = p.`id`
WHERE r.`role_code` IN ('INJECTION_LEADER', 'WORKSHOP_DIRECTOR', 'INJECTION_MANAGER', 'PRODUCTION_TECH_MANAGER')
AND r.`deleted` = 0 AND p.`deleted` = 0
ORDER BY r.`role_code`, p.`permission_type`, p.`sort_order`;
```

## 使用说明

### 1. 为用户分配角色

在用户管理模块中，为用户分配相应的角色：
- 注塑组长 → 分配 `INJECTION_LEADER` 角色
- 车间主任 → 分配 `WORKSHOP_DIRECTOR` 角色
- 注塑部经理 → 分配 `INJECTION_MANAGER` 角色
- 生产技术部经理 → 分配 `PRODUCTION_TECH_MANAGER` 角色

### 2. 权限验证

系统会自动根据用户的角色进行权限验证：

```java
// 在Controller或Service中
String userRoleCode = SecurityUtil.getCurrentUserRoleCode();
List<String> userRoleCodes = SecurityUtil.getCurrentUserRoleCodes();

// 检查权限
if (SecurityUtil.hasRoleCode(ProcessFileRoleConstant.ROLE_CODE_WORKSHOP_DIRECTOR)) {
    // 车间主任权限
}
```

### 3. 审批流程

审批流程会自动根据用户角色进行验证：
- 车间主任只能审核状态为"待车间主任审核"的工艺文件
- 注塑部经理只能会签状态为"待注塑部经理会签"的工艺文件
- 生产技术部经理只能批准状态为"待生产技术部经理批准"的工艺文件

## 代码文件清单

### 新增文件
1. `backend/src/main/resources/db/process_file_role_permission_init.sql` - 角色和权限初始化SQL脚本
2. `backend/src/main/java/com/zssystem/constant/ProcessFileRoleConstant.java` - 角色常量类

### 修改文件
1. `backend/src/main/java/com/zssystem/util/SecurityUtil.java` - 完善用户角色获取逻辑
2. `backend/src/main/java/com/zssystem/service/impl/ProcessFileServiceImpl.java` - 使用角色代码进行权限验证

## 后续工作

### 1. 执行SQL脚本
执行 `process_file_role_permission_init.sql` 脚本，创建角色和权限数据。

### 2. 为用户分配角色
在用户管理模块中，为相关用户分配对应的角色。

### 3. 测试验证
- 测试注塑组长上传和提交审批功能
- 测试车间主任审核功能
- 测试注塑部经理会签功能
- 测试生产技术部经理批准功能
- 测试权限验证是否正确

### 4. 前端权限控制（可选）
如果需要在前端进行权限控制，可以：
- 根据用户权限动态显示/隐藏按钮
- 根据用户角色显示不同的菜单项
- 在API调用前进行权限检查

## 注意事项

1. **角色代码唯一性**: 角色代码必须唯一，不能重复
2. **权限代码唯一性**: 权限代码必须唯一，不能重复
3. **角色权限关联**: 确保角色和权限的关联关系正确
4. **用户角色分配**: 确保为用户正确分配角色
5. **兼容性**: 代码同时支持角色代码和角色名称，保持向后兼容

## 相关文档

- `12-注塑工艺文件管理功能开发文档.md` - 工艺文件管理完整功能设计
- `04-权限管理功能开发文档.md` - 权限管理功能设计
- `工艺文件管理-查询失败问题修复.md` - 查询功能修复
- `工艺文件下载-下载失败问题修复.md` - 下载功能修复
- `工艺文件查看-文件不存在问题修复.md` - 查看功能修复

---

**完成状态**: ✅ 所有代码已完成并编译通过  
**下一步**: 执行SQL脚本，为用户分配角色，进行功能测试
