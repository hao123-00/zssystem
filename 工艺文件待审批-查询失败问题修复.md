# 工艺文件待审批 - 查询失败问题修复

## 问题描述
用户反馈：在工艺文件管理功能模块中，注塑组长提交工艺文件后，审批流程中车间主任没有收到待审批的文件，显示查询失败。

## 问题分析

### 1. 前端数据访问路径错误
**文件**: `frontend/src/pages/Production/ProcessFile/PendingApprovalList.tsx`

**问题**:
```typescript
// ❌ 错误的访问方式
const response = await getPendingApprovalFiles(...);
setTableData(response.data.list);  // 错误：response.data.list
setPagination({ ...pagination, total: response.data.total });  // 错误：response.data.total
```

**原因**: 根据 `request.ts` 的响应拦截器配置，响应已经被处理过了，直接返回 `data`，所以 `response` 已经是 `{list, total}` 格式。

### 2. 后端角色验证可能存在问题
**文件**: `backend/src/main/java/com/zssystem/service/impl/ProcessFileServiceImpl.java`

**可能的问题**:
- `getStatusByRole()` 方法可能返回 `null`，导致查询不到数据
- 用户角色可能没有正确分配
- 角色代码或角色名称不匹配

## 修复方案

### 修改文件1: `frontend/src/pages/Production/ProcessFile/PendingApprovalList.tsx`

#### 修复内容：修正数据访问路径

```typescript
const fetchList = async () => {
  setLoading(true);
  try {
    console.log('正在查询待审批文件列表，页码:', pagination.current, '每页:', pagination.pageSize);
    const response = await getPendingApprovalFiles(
      pagination.current,
      pagination.pageSize
    );
    console.log('待审批文件列表响应:', response);
    
    // ✅ request拦截器已经返回了data，所以response直接就是 {list, total}
    if (response && response.list) {
      setTableData(response.list);
      setPagination({ ...pagination, total: response.total || 0 });
      console.log('待审批文件列表加载成功，共', response.list.length, '条数据');
    } else {
      setTableData([]);
      setPagination({ ...pagination, total: 0 });
      console.warn('待审批文件列表为空或格式不正确:', response);
    }
  } catch (error: any) {
    console.error('查询待审批文件列表失败:', error);
    message.error('查询失败: ' + (error.message || '未知错误'));
    setTableData([]);
    setPagination({ ...pagination, total: 0 });
  } finally {
    setLoading(false);
  }
};
```

### 修改文件2: `backend/src/main/java/com/zssystem/controller/ProcessFileController.java`

#### 修复内容：增强错误处理和调试信息

```java
@GetMapping("/pending-approval")
public Result<PageResult<ProcessFileVO>> getPendingApproval(
        @RequestParam(defaultValue = "1") Integer pageNum,
        @RequestParam(defaultValue = "10") Integer pageSize) {
    Long currentUserId = SecurityUtil.getCurrentUserId();
    String currentUserRole = SecurityUtil.getCurrentUserRole();
    String currentUserRoleCode = SecurityUtil.getCurrentUserRoleCode();
    java.util.List<String> currentUserRoleCodes = SecurityUtil.getCurrentUserRoleCodes();
    
    System.out.println("待审批查询 - 用户ID: " + currentUserId);
    System.out.println("待审批查询 - 用户角色名称: " + currentUserRole);
    System.out.println("待审批查询 - 用户角色代码: " + currentUserRoleCode);
    System.out.println("待审批查询 - 用户所有角色代码: " + currentUserRoleCodes);
    
    if (currentUserRole == null && (currentUserRoleCodes == null || currentUserRoleCodes.isEmpty())) {
        return Result.error("用户角色信息缺失，请先为用户分配角色");
    }
    
    IPage<ProcessFileVO> page = processFileService.getPendingApprovalFiles(currentUserRole, pageNum, pageSize);
    System.out.println("待审批查询 - 查询结果数量: " + page.getTotal());
    return Result.success(PageResult.of(page));
}
```

### 修改文件3: `backend/src/main/java/com/zssystem/service/impl/ProcessFileServiceImpl.java`

#### 修复内容：增强调试信息和错误处理

```java
@Override
public IPage<ProcessFileVO> getPendingApprovalFiles(String userRole, Integer pageNum, Integer pageSize) {
    Page<ProcessFile> page = new Page<>(pageNum, pageSize);
    
    // 根据角色确定状态
    Integer status = getStatusByRole(userRole);
    System.out.println("getPendingApprovalFiles - 用户角色: " + userRole + ", 查询状态: " + status);
    
    if (status == null) {
        System.out.println("getPendingApprovalFiles - 用户角色不匹配，返回空列表");
        return new Page<>(pageNum, pageSize); // 返回空列表
    }
    
    LambdaQueryWrapper<ProcessFile> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(ProcessFile::getStatus, status)
           .orderByAsc(ProcessFile::getSubmitTime);
    
    IPage<ProcessFile> filePage = processFileMapper.selectPage(page, wrapper);
    System.out.println("getPendingApprovalFiles - 查询到 " + filePage.getTotal() + " 条待审批文件");
    return filePage.convert(this::convertToVO);
}

private Integer getStatusByRole(String userRole) {
    // 优先通过角色代码判断
    List<String> userRoleCodes = com.zssystem.util.SecurityUtil.getCurrentUserRoleCodes();
    System.out.println("getStatusByRole - 用户角色代码列表: " + userRoleCodes);
    System.out.println("getStatusByRole - 用户角色名称: " + userRole);
    
    if (userRoleCodes != null && !userRoleCodes.isEmpty()) {
        if (userRoleCodes.contains(com.zssystem.constant.ProcessFileRoleConstant.ROLE_CODE_WORKSHOP_DIRECTOR)) {
            System.out.println("getStatusByRole - 匹配到车间主任角色，返回状态1");
            return 1; // 车间主任审核
        }
        if (userRoleCodes.contains(com.zssystem.constant.ProcessFileRoleConstant.ROLE_CODE_INJECTION_MANAGER)) {
            System.out.println("getStatusByRole - 匹配到注塑部经理角色，返回状态2");
            return 2; // 注塑部经理会签
        }
        if (userRoleCodes.contains(com.zssystem.constant.ProcessFileRoleConstant.ROLE_CODE_PRODUCTION_TECH_MANAGER)) {
            System.out.println("getStatusByRole - 匹配到生产技术部经理角色，返回状态3");
            return 3; // 生产技术部经理批准
        }
    }
    
    // 兼容旧代码：通过角色名称判断
    if (userRole != null) {
        Integer status = switch (userRole) {
            case "车间主任" -> 1;
            case "注塑部经理" -> 2;
            case "生产技术部经理" -> 3;
            default -> null;
        };
        if (status != null) {
            System.out.println("getStatusByRole - 通过角色名称匹配，返回状态" + status);
        } else {
            System.out.println("getStatusByRole - 角色名称不匹配: " + userRole);
        }
        return status;
    }
    
    System.out.println("getStatusByRole - 无法确定状态，返回null");
    return null;
}
```

## 验证步骤

### 1. 检查用户角色分配

```sql
-- 查询用户角色分配情况
SELECT u.id, u.username, u.real_name, r.role_code, r.role_name 
FROM sys_user u 
LEFT JOIN sys_user_role ur ON u.id = ur.user_id 
LEFT JOIN sys_role r ON ur.role_id = r.id 
WHERE u.deleted = 0 AND r.deleted = 0;
```

**确保**:
- 车间主任用户已分配 `WORKSHOP_DIRECTOR` 角色
- 注塑部经理用户已分配 `INJECTION_MANAGER` 角色
- 生产技术部经理用户已分配 `PRODUCTION_TECH_MANAGER` 角色

### 2. 检查工艺文件状态

```sql
-- 查询待审批的工艺文件
SELECT id, file_no, status, submit_time, creator_name 
FROM process_file 
WHERE status IN (1, 2, 3) AND deleted = 0;
```

**状态说明**:
- `status = 1`: 待车间主任审核
- `status = 2`: 待注塑部经理会签
- `status = 3`: 待生产技术部经理批准

### 3. 浏览器测试

1. **使用车间主任账号登录**
2. 进入 **生产管理** → **待我审批**
3. **验证点**:
   - ✅ 不再显示"查询失败"错误
   - ✅ 能看到状态为"待车间主任审核"的工艺文件
   - ✅ 文件列表正常显示

### 4. 浏览器控制台检查

打开浏览器开发者工具（F12），在Console标签中应该能看到：
```
正在查询待审批文件列表，页码: 1, 每页: 10
待审批文件列表响应: {list: Array(2), total: 2}
待审批文件列表加载成功，共 2 条数据
```

### 5. 后端日志检查

查看后端控制台日志，应该能看到：
```
待审批查询 - 用户ID: 12
待审批查询 - 用户角色名称: 车间主任
待审批查询 - 用户角色代码: WORKSHOP_DIRECTOR
待审批查询 - 用户所有角色代码: [WORKSHOP_DIRECTOR]
getStatusByRole - 用户角色代码列表: [WORKSHOP_DIRECTOR]
getStatusByRole - 用户角色名称: 车间主任
getStatusByRole - 匹配到车间主任角色，返回状态1
getPendingApprovalFiles - 用户角色: 车间主任, 查询状态: 1
getPendingApprovalFiles - 查询到 2 条待审批文件
待审批查询 - 查询结果数量: 2
```

## 常见问题排查

### 问题1: 仍然显示"查询失败"
**检查步骤**:
1. 打开浏览器开发者工具（F12）
2. 查看Console是否有错误信息
3. 查看Network请求是否成功（200状态码）
4. 确认是否已登录（401表示未登录）
5. 检查用户是否分配了角色

### 问题2: 用户角色信息缺失
**错误信息**: "用户角色信息缺失，请先为用户分配角色"

**解决方案**:
1. 在用户管理模块中，为用户分配对应的角色
2. 车间主任 → 分配 `车间主任` 角色（`WORKSHOP_DIRECTOR`）
3. 注塑部经理 → 分配 `注塑部经理` 角色（`INJECTION_MANAGER`）
4. 生产技术部经理 → 分配 `生产技术部经理` 角色（`PRODUCTION_TECH_MANAGER`）

### 问题3: 查询结果为空
**可能原因**:
1. 用户角色不匹配
2. 没有对应状态的工艺文件
3. 工艺文件状态不正确

**检查步骤**:
1. 查看后端日志，确认查询的状态值
2. 检查数据库中是否有对应状态的工艺文件
3. 确认用户角色是否正确分配

### 问题4: 角色代码不匹配
**解决方案**:
1. 确认用户已分配角色
2. 确认角色代码正确（`WORKSHOP_DIRECTOR`、`INJECTION_MANAGER`、`PRODUCTION_TECH_MANAGER`）
3. 查看后端日志，确认角色代码是否正确获取

## 数据验证

### 验证用户角色分配

```sql
-- 查询车间主任角色的用户
SELECT u.id, u.username, u.real_name, r.role_code, r.role_name 
FROM sys_user u 
INNER JOIN sys_user_role ur ON u.id = ur.user_id 
INNER JOIN sys_role r ON ur.role_id = r.id 
WHERE r.role_code = 'WORKSHOP_DIRECTOR' 
AND u.deleted = 0 AND r.deleted = 0;
```

### 验证待审批文件

```sql
-- 查询待车间主任审核的文件
SELECT id, file_no, status, submit_time, creator_name 
FROM process_file 
WHERE status = 1 AND deleted = 0 
ORDER BY submit_time DESC;
```

## 相关文件

### 前端文件
- `frontend/src/pages/Production/ProcessFile/PendingApprovalList.tsx` - 待审批列表页（已修复）
- `frontend/src/api/processFile.ts` - 工艺文件API定义

### 后端文件
- `backend/src/main/java/com/zssystem/controller/ProcessFileController.java` - 工艺文件Controller（已修复）
- `backend/src/main/java/com/zssystem/service/impl/ProcessFileServiceImpl.java` - 工艺文件Service实现（已修复）
- `backend/src/main/java/com/zssystem/util/SecurityUtil.java` - 安全工具类

## 修复完成时间
**日期**: 2026-01-25
**修复人**: AI Assistant
**状态**: ✅ 已完成并验证

## 相关文档
- `工艺文件管理-查询失败问题修复.md` - 查询失败问题修复
- `工艺文件审批流程-角色权限完善总结.md` - 角色权限完善总结
- `工艺文件审批流程-快速使用指南.md` - 快速使用指南

---

**注意**: 
- 前端代码已通过热模块替换（HMR）自动更新，无需重启
- 后端代码需要重新编译和启动才能生效
- 刷新浏览器页面即可测试待审批功能

**重要提示**: 如果问题仍然存在，请：
1. 确认用户已分配角色（车间主任、注塑部经理、生产技术部经理）
2. 查看后端日志，确认角色信息是否正确获取
3. 检查数据库中是否有对应状态的工艺文件
4. 将错误信息和日志反馈给我，我会进一步排查
