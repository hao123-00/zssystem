# 工艺文件表单功能实现总结

## 完成时间
**日期**: 2026-01-25  
**状态**: ✅ 已完成

## 功能概述

将工艺文件上传功能从Excel文件上传改为页面表单填写方式。用户点击"新建工艺文件"后，弹出表单页面，填写完整的注塑工艺卡片信息，然后保存并走审批流程。

## 实现内容

### 1. 数据库设计

#### 1.1 工艺文件详细内容表（process_file_detail）

**文件**: `backend/src/main/resources/db/process_file_detail.sql`

**表结构**:
- 基本信息：产品型号、产品名称、模具制造公司、零件名称、项目负责人
- 材料信息：材料名称、牌号、颜色、颜料名称、比例、重量等
- 模具信息：模具编号、型腔数量、锁模力
- 产品关键尺寸：文本字段
- 设备信息：设备ID、设备编号、机台号、设备名称
- 注塑成型工艺参数：
  - 合模参数（4组：合模1、合模2、模保、高压）
  - 进芯参数（2组：进芯一、进芯二）
  - 射胶参数（6段：每段包含压力、流量、位置）
  - 保压参数（3段：每段包含压力、流量、位置）
  - 开模参数（4组：开模1-4）
  - 抽芯参数（2组：抽芯一、抽芯二）
  - 熔胶参数（3组：熔胶1、熔前松退、熔后松退）
  - 顶出参数（4组：顶出一速、顶出二速、顶退一速、顶退二速）
- 特殊模式参数：注射模式、进芯方式、抽芯方式、座台方式、顶针模式、顶针次数、螺杆转速、抽芯行程方式
- 温度参数：料筒温度（4段）、模具温度
- 时间参数：合模、模保、进芯、注射、保压、冷却、抽芯、开模、取件时间、总时间
- 原材料干燥处理：使用设备、盛料高度、翻料时间、干燥温度、前模冷却
- 零件后处理：零件后处理、产品后处理、加热温度、保温温度、干燥时间、后模冷却
- 工序内容和品质检查：文本字段
- 综合评估：文本字段

### 2. 后端实现

#### 2.1 实体类

**文件**: `backend/src/main/java/com/zssystem/entity/ProcessFileDetail.java`
- 包含所有表单字段
- 使用MyBatis-Plus注解
- 支持逻辑删除

#### 2.2 DTO

**文件**: `backend/src/main/java/com/zssystem/dto/ProcessFileFormDTO.java`
- 包含所有表单字段
- 使用Bean Validation进行参数校验

#### 2.3 Mapper

**文件**: `backend/src/main/java/com/zssystem/mapper/ProcessFileDetailMapper.java`
- 继承`BaseMapper<ProcessFileDetail>`
- 提供基本的CRUD操作

#### 2.4 Service

**文件**: 
- `backend/src/main/java/com/zssystem/service/ProcessFileService.java` - 接口
- `backend/src/main/java/com/zssystem/service/impl/ProcessFileServiceImpl.java` - 实现

**主要方法**:
- `saveProcessFileForm()`: 保存工艺文件表单数据
  - 支持新建和修改（版本管理）
  - 自动生成文件编号
  - 保存主表和详细内容表
  - 返回文件ID

#### 2.5 Controller

**文件**: `backend/src/main/java/com/zssystem/controller/ProcessFileController.java`

**新增接口**:
- `POST /api/production/process-file/save-form`: 保存工艺文件表单

### 3. 前端实现

#### 3.1 表单页面

**文件**: 
- `frontend/src/pages/Production/ProcessFile/ProcessFileForm.tsx`
- `frontend/src/pages/Production/ProcessFile/ProcessFileForm.less`

**功能特点**:
- 完全按照图片布局设计
- 使用Ant Design组件（Form、Input、InputNumber、Select、TextArea）
- 分区域展示（基本信息、材料信息、模具信息、工艺参数等）
- 设备选择下拉框（支持搜索，显示机台号-设备名称）
- 表单验证
- 保存后跳转到详情页或列表页

#### 3.2 API接口

**文件**: `frontend/src/api/processFile.ts`

**新增接口**:
- `saveProcessFileForm()`: 保存工艺文件表单

#### 3.3 路由配置

**文件**: `frontend/src/App.tsx`

**新增路由**:
- `/production/process-file/form` - 新建表单
- `/production/process-file/form/:id` - 修改表单

#### 3.4 列表页面修改

**文件**: `frontend/src/pages/Production/ProcessFile/index.tsx`

**修改内容**:
- "上传工艺文件"按钮改为"新建工艺文件"
- 点击后跳转到表单页面而不是上传页面

### 4. 审批流程保持不变

- 提交审批：需要电子签名
- 审核流程：车间主任 → 注塑部经理 → 生产技术部经理
- 电子签名同步到Excel：保持不变（如果后续需要生成Excel）

## 文件清单

### 数据库文件
- `backend/src/main/resources/db/process_file_detail.sql` - 详细内容表创建脚本

### 后端文件
- `backend/src/main/java/com/zssystem/entity/ProcessFileDetail.java` - 详细内容实体类
- `backend/src/main/java/com/zssystem/dto/ProcessFileFormDTO.java` - 表单DTO
- `backend/src/main/java/com/zssystem/mapper/ProcessFileDetailMapper.java` - 详细内容Mapper
- `backend/src/main/java/com/zssystem/service/ProcessFileService.java` - 更新Service接口
- `backend/src/main/java/com/zssystem/service/impl/ProcessFileServiceImpl.java` - 更新Service实现
- `backend/src/main/java/com/zssystem/controller/ProcessFileController.java` - 更新Controller

### 前端文件
- `frontend/src/pages/Production/ProcessFile/ProcessFileForm.tsx` - 表单页面组件
- `frontend/src/pages/Production/ProcessFile/ProcessFileForm.less` - 表单样式
- `frontend/src/api/processFile.ts` - 更新API接口
- `frontend/src/App.tsx` - 更新路由配置
- `frontend/src/pages/Production/ProcessFile/index.tsx` - 更新列表页面

## 使用说明

### 1. 执行SQL脚本

```bash
mysql -uroot -pczd828101 -D zssystem < backend/src/main/resources/db/process_file_detail.sql
```

### 2. 重启后端服务

```bash
cd /Users/czd/zssystem/backend
./start.sh
```

### 3. 使用流程

1. **新建工艺文件**:
   - 进入"生产管理" → "工艺文件管理"
   - 点击"新建工艺文件"按钮
   - 填写表单信息（必须选择设备机台号）
   - 点击"保存"按钮
   - 保存成功后，可以点击"提交"按钮进行审批

2. **修改工艺文件**:
   - 在列表页点击"修改"按钮（仅草稿状态）
   - 修改表单信息
   - 必须填写"变更原因"
   - 点击"保存"按钮
   - 保存成功后，可以点击"提交"按钮进行审批

3. **审批流程**:
   - 与之前保持一致
   - 需要电子签名
   - 签名会同步到Excel（如果后续需要生成Excel）

## 技术要点

### 1. 表单字段映射

所有表单字段名称与数据库字段名称保持一致（驼峰命名），使用`BeanUtils.copyProperties()`进行自动映射。

### 2. 设备选择

- 下拉框显示格式：`机台号 - 设备名称 (设备编号)`
- 支持搜索（按机台号、设备编号、设备名称）
- 只显示正常状态的设备
- 按机台号排序

### 3. 版本管理

- 修改时创建新版本
- 原版本标记为历史版本（`isCurrent = 0`）
- 新版本继承原版本的详细内容

### 4. 文件编号生成

- 格式：`PF20260125001`
- 自动生成，无需手动输入

## 注意事项

1. **必填字段**:
   - 设备ID（必须选择设备机台号）
   - 修改时必须填写变更原因

2. **数据验证**:
   - 数字字段自动验证范围
   - 百分比字段限制0-100
   - 温度、时间等字段限制最小值

3. **表单保存**:
   - 保存成功后返回文件ID
   - 可以继续编辑或提交审批

4. **审批流程**:
   - 审批流程保持不变
   - 电子签名功能保持不变
   - 签名同步到Excel功能保持不变

## 后续优化建议

1. **表单验证增强**: 添加更多业务规则验证
2. **数据导入**: 支持从Excel导入数据到表单
3. **数据导出**: 支持将表单数据导出为Excel
4. **模板功能**: 支持保存常用模板
5. **批量操作**: 支持批量创建相似工艺文件
6. **历史版本查看**: 支持查看历史版本的详细内容

## 相关文档

- `12-注塑工艺文件管理功能开发文档.md` - 工艺文件管理完整功能设计
- `工艺文件审批流程-电子签名功能实现总结.md` - 电子签名功能文档
- `工艺文件Excel签名同步功能实现总结.md` - Excel签名同步功能文档

---

**完成状态**: ✅ 所有代码已完成并编译通过  
**下一步**: 重启后端服务，进行功能测试
